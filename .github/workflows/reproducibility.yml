name: Reproducibility Check

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  # Allow running manually from the Actions tab
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

# 2. Download and Extract Data (Smart Search)
      - name: Download Data from OSF
        run: |
          # 1. Download
          wget -q -O project_data.zip "https://files.osf.io/v1/resources/ctne9/providers/osfstorage/?zip="
          
          # 2. Unzip
          unzip -q project_data.zip -d temp_osf_data
          
          # 3. Find where the STL files are hiding
          # We look for the first file ending in .stl to locate the directory
          STL_FILE=$(find temp_osf_data -name "*.stl" | head -n 1)
          
          if [ -z "$STL_FILE" ]; then
            echo "ERROR: No STL files found in the zip!"
            # Debug: List all files so we can see what happened
            find temp_osf_data
            exit 1
          fi
          
          # Get the directory containing that STL file
          SOURCE_DIR=$(dirname "$STL_FILE")
          echo "Found STL files in: $SOURCE_DIR"
          
          # 4. Move and Rename
          # We move the found directory to where the Python script expects it
          # and ensure it has the specific name the script requires
          mv "$SOURCE_DIR" py_SPHARM/SPHARM_main/3d_models_QSY_spheroids_multi_poly
          
          # Cleanup
          rm project_data.zip
          rm -rf temp_osf_data

      # 3. Build the Docker Image
      # We build it here using your Dockerfile
      - name: Build Docker Image
        run: docker build -t spharm .

      # 4. Run Python Analysis (Batch Operation)
      # We use 'conda run -n spharm' to execute inside the conda env defined in your Dockerfile
      # We mount the current directory (${PWD}) to /project so outputs are saved to the runner
      - name: Run SPHARM Batch Operation
        run: |
          docker run --rm \
          -v ${{ github.workspace }}:/project \
          -w /project/py_SPHARM \
          spharm \
          conda run -n spharm python -m SPHARM_main."batch operation"

      # 5. Run Curvature Script
      - name: Run Curvature Script
        run: |
          docker run --rm \
          -v ${{ github.workspace }}:/project \
          -w /project/py_SPHARM \
          spharm \
          conda run -n spharm python SPHARM_modules/curvature.py

      # 6. Run Sphericity Script
      - name: Run Sphericity Script
        run: |
          docker run --rm \
          -v ${{ github.workspace }}:/project \
          -w /project/py_SPHARM \
          spharm \
          conda run -n spharm python SPHARM_modules/sphericity.py

      # 7. Render Quarto Paper
      # The Renv packages are already restored in the Docker build step.
      # We just need to trigger the render.
      - name: Render Quarto Paper
        run: |
          docker run --rm \
          -v ${{ github.workspace }}:/project \
          -w /project \
          spharm \
          quarto render analysis/paper/paper.qmd --to docx

      # 8. Upload the Resulting Paper
      # This allows you to download the .docx from the GitHub Actions Summary page
      - name: Upload Artifact (Paper)
        uses: actions/upload-artifact@v4
        with:
          name: research-paper
          path: analysis/paper/paper.docx
          
      # 9. Upload Data Results (Optional)
      # Uploads the CSVs generated by Python so you can inspect them
      - name: Upload Data Results
        uses: actions/upload-artifact@v4
        with:
          name: analysis-data
          path: analysis/data/raw_data/SPHARM_sphericity_curvature_result/
