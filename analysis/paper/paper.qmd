---
title: "Spherical harmonic analysis of faceted spheroids identifies shaping strategies and standardisation at Qianshangying (North China)"
author:
  - Zhi Ye:
      correspondence: "no"
      orcid: 
      institute:
        - ivpp1
        - ivpp2
        - UCAS
  - Shuwen Pei:
      correspondence: "yes"
      email: peishuwen@ivpp.ac.cn
      orcid: 
      institute:
        - ivpp1
        - ivpp2
  - Dongdong Ma:
      correspondence: "no"
      orcid: 
      institute:
        - ivpp1
        - ivpp2
  - Hao Li:
      correspondence: "no"
      orcid: 
      institute:
        - ALPHA
        - TPESRE
  - Ben Marwick:
      correspondence: "yes"
      email: bmarwick@uw.edu
      orcid: 0000-0001-7879-4531
      institute:
        - uw
institute:
  - ivpp1: Key Laboratory of Vertebrate Evolution and Human Origins, Institute of Vertebrate Paleontology and Paleoanthropology, Chinese Academy of Sciences, Beijing 100044, China
  - ivpp2: Key Scientific Research Base on Paleolithic Human Evolution and Paleogenetics (IVPP), SACH. Beijing, 100044, China
  - UCAS: University of Chinese Academy of Sciences, Beijing 100049, China
  - ALPHA: Group of Alpine Paleoecology and Human Adaptation (ALPHA), Institute of Tibetan Plateau Research, Chinese Academy of Sciences, Beijing 100101; 
  - TPESRE: State Key Laboratory of Tibetan Plateau Earth System, Resources and Environment (TPESRE), Beijing 100101
  - uw: Department of Anthropology, University of Washington, Seattle, WA, USA
title-block-published: "Last updated"  
date: now
date-format: long
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
crossref:
  fig-title: "Fig."
  fig-prefix: "Fig."
number-sections: true
execute:
  echo: true
  warning: false
  message: false
  comment: "#>"
  fig-dpi: 600
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Spheroids are widely distributed lithic artifacts, yet their production strategies and functions remain debated. Traditional morphology-based typologies obscure their technological features and variability. Here we introduce a novel, open-source and reproducible framework that uses spherical harmonics as a method of quantitative morphological analysis, integrated with technological measures, to assess production strategies. Applied to Middle Pleistocene faceted spheroids from Qianshangying (~429 ka, northern China), the approach demonstrates that spheroid production followed a conceptual template, involving a patterned reduction process aimed at achieving standardized spherical forms, and represents a deliberate shaping strategy. Our results further demonstrate that spheroids can be clearly distinguished from polyhedrons and multifacial cores exhausted through reduction. Our methods for investigating spheroid production strategies reveal a higher level of technological complexity than previously assumed for early lithic industries in northern China. Our study also provides a transparent and replicable framework with broad potential for advancing cross-regional and comparative studies of spheroid production but also more broadly lithic technological research for any period and region.
editor_options: 
  chunk_output_type: console
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The actual document text starts here: -->

```{r setup, include=FALSE}

library(data.table)
library(NISTunits)
library(circular)
library(ggpubr)
library(ggplot2)
library(stringr)
library(ggtern)
library(dplyr)
library(here)
library(tidyverse)
library(tidyr)
library(ggrepel)
library(here)
library(readxl)
library(Hmisc)       
library(ggcorrplot)  
library(reshape2)

source(here('analysis/paper/scripts/McPherron_2018.r'))
source(here('analysis/paper/scripts/get_coordinates.r'))
source(here('analysis/paper/scripts/vector_stats.r'))
```

# Introduction

Spheroids are a widely distributed type of stone artifact, appearing across a broad temporal and geographic range, from the Oldowan and Acheulean to the Middle Paleolithic, and in diverse archaeological assemblages [@willoughby1985; @Cabanes2024]. @clark1955 pioneered the study of archaeological stone balls, then @kleindienst1962 proposed the sub-divisions of missile, polyhedron and bola. After that, the terminology of spheroid and subspheroid was formally introduced by @leakey1971 in his classification of the Developed Oldowan. At present, commonly used definitions of ball-like stone artifacts are as follows: spheroids are rounded lithic objects whose entire surface is covered with flake scars, while subspheroids are generally less symmetrical and may retain portions of the original cortex. Compared to spheroids, polyhedrons are characterized by multiple intersecting flake removals, producing a distinctly angular morphology; bolas exhibit smoother and more rounded surfaces with no visible crests [@leakey1971; @tittonSubspheroidsLithicAssemblage2020; @deweyer2017].

These stone balls are frequently grouped under the category “PSB” of Polyhedron, Spheroid and Bola (or “PSSB” when subspheroids are included) and are commonly interpreted as volumetrically reduced artifacts organized around a central point. This morphology-based classification has been widely accepted, but it has led to challenges. Research has shown that these forms may not represent a continuous *chaîne opératoire*: differences in raw material selection suggest divergent technological strategies and potentially distinct functional purposes [@deweyer2017; @jones1994]. This illustrates the limitations of typology in the classification and study of stone artifacts, as it is overly reliant on morphology. There is a need to establish new criteria to distinguish these artifacts and to determine their respective production purposes and strategies, if such purposes and strategies exist.

In addition, the technological category and function of spheroids remain central topics of debate. Broadly, spheroids have been interpreted as cores [@sahnouni1997], projectiles [@leakey1979], and hammerstones [@mussi2025; @schick1994], or a specialized tool for working animal bones [@assaf2025]. Closely tied to this debate is the question of their production strategy, which remains unclear. Experimental replication and site-specific diacritical analyses have produced divergent interpretations. One view suggests that spheroids emerged unintentionally as the by-products of core exhaustion, which represents a low-effort strategy aimed at flake production [@sahnouni1997]. Another perspective holds that spheroids were unconsciously produced through high-intensity battering [@schick1994; @mora2005; @clark1955]. In contrast, a third view proposes that spheroids reflect a conceptual template and were produced through a deliberate shaping strategy [@tittonSubspheroidsLithicAssemblage2020; @Muller2023; @texier2014].

This debate remains stalled for several reasons. Typological studies relied heavily on researchers' observations and experiential judgments, which lack objectivity. Some experiments attempted to demonstrate whether spheroids were intentionally or unintentionally produced, yet the researchers involved tend to introduce bias, making it impossible to achieve truly “unconscious” production. From an objective perspective, most studies can only reflect the characteristics of spheroids from a specific region or site, whereas spheroids themselves display considerable diversity in aspects such as raw materials and surface features. Also, conclusions drawn from their own analyses are rarely subjected to external validation or replication. As a result, both the research methods and the inherent diversity of spheroids have hindered the advancement of in-depth studies on spheroids.

To address these challenges, we developed a set of quantitative methods that integrate morphological and technological analyses to investigate spheroid production strategies. While previous morphological measures have focused on the shape of spheroids close to perfect sphere, contributing to discussions of spheroid standardization, they provided limited assistance in reflecting on production strategies. We therefore adopted spherical harmonics, a landmark-free method recently introduced to archaeology. This offers morphometric precision comparable to geometric morphometrics but does not rely on predefined landmarks, making it particularly suitable for artifacts like spheroids that lack homologous landmarks. Compared to previous studies, we employed rotation-invariant spectrum and UMAP to analyze spherical harmonics results, distinguishing the morphological variability of flaked pieces and thereby differentiating spheroids from intensively flaked cores, while extending the application of spherical harmonics. Additional technological analyses, including flake scar orientation analysis and reduction index calculation, further contribute to reconstructing the spheroid production process. All of the methods we present here are open-source to enable replication of our results and support unified, cross-regional quantitative studies in the future.

We demonstrate these methods through a case study of spheroids recovered from the recently excavated site of Qianshangying in the Nihewan Basin, northern China. Using a comparative framework, we examine spheroids alongside polyhedrons and multifacial cores to address two specific questions: first, whether spheroids represent a distinct production sequence, and second whether quantitative methods can distinguish spheroids from heavily reduced cores beyond traditional typological classifications. Further, we situated the Middle Pleistocene Qianshangying site within the broader context of East Asia to explore the technological behaviors and cultural traditions associated with spheroid production, also providing one of the first contributions to understanding the spatial and temporal distribution of spheroids in this region. Finally, and most generally, we offer an efficient and transparent framework combining morphological and technological analyses, enabling comparative studies of spheroid production strategies across regions and archaeological sites that can also be extended to other types of artefacts.

# Qianshangying and its spheroids

```{r, echo=FALSE}
#| label: fig-QSY-geography-chronology
#| fig-cap: "Geological Context and Chrono-Stratigraphy of the Qianshangying site complex): A-B) Geographic location of Nihewan basin. C) Google Earth image showing major sites in the Jijiazhuang Platform. D)  Landscape and different localities of Qianshangying site complex. E) Archaeostratigraphy sequence and ESR dating results of Qianshangyinig site."


knitr::include_graphics(here("analysis/paper/figures/QSY_geography_chronology.png"))

```

The Qianshangying site complex lies in the Nihewan Basin, a region in northern China situated between the Chinese Loess Plateau and the Inner Mongolian Plateau. The basin preserves extensive Quaternary fluvio-lacustrine and loess deposits [@barbour1926geological; @li2000; @deng2008timing; @yuan2009], hosts the highest concentrations of Pleistocene Paleolithic sites in East Asia, and is especially significant for preserving evidence of early hominin activities outside Africa dating back over one million years [@yang2020; @yang2017; @pei2019; @pei2017; @zhu2001; @zhu2004]. In recent years, nearly 20 Middle Pleistocene sites—including Jijiazhuang and Caijiagou—have been identified in the southeastern part of the basin [@pei2018preliminary; @Du2023; @ye2024], within the Yuxian Sub-basin, resulting in a long and detailed regional cultural sequence for the Nihewan Basin (@fig-QSY-geography-chronology).

```{r, echo=FALSE}

df <- tibble(
  material = c("Lava", "Dolomite", "Chert", "Other"),
  spheroids = c(11, 2, 0, 0),
  cores = c(60, 21, 4, 8),
  Polys_and_Multi_cores = c(19, 5, 3, 2),
  total = c(637, 209, 53, 56),
)

# 转换数据格式 - 按核心类型分组计算原料比例
df_long <- df %>%
  # 移除total列，因为我们要计算的是每种核心类型内的原料比例
  select(-total) %>%
  pivot_longer(cols = -material, names_to = "core_type", values_to = "count") %>%
  # 按核心类型分组计算百分比
  group_by(core_type) %>%
  mutate(prop = count / sum(count) * 100) %>%
  ungroup() %>%
  mutate(
    core_type = factor(core_type, 
                      levels = c("spheroids", "Polys_and_Multi_cores", "cores"),
                      labels = c("Spheroids", "Polys and Multi cores", "Cores")),
    material = factor(material, 
                      levels = c("Lava", "Dolomite", "Chert", "Other"))
  )

# 正确计算每种核心类型的总数
total_by_core_type_correct <- df_long %>%
  group_by(core_type) %>%
  summarise(total_count = sum(count)) %>%
  ungroup()


# 创建带数量的横坐标标签（使用正确总数）
core_type_labels_correct <- c(
  "Spheroids" = paste0("Sub/ Spheroids \n(n = ", 
                       total_by_core_type_correct$total_count[1], ")"),
  "Polys and Multi cores" = paste0("Polyhedrons/ Multifacils\n(n = ", 
                                   total_by_core_type_correct$total_count[2], ")"),
  "Cores" = paste0("Cores\n(n = ", 
                   total_by_core_type_correct$total_count[3], ")")
)

# 绘图
# 绘图
p_raw_material <- ggplot(df_long, 
       aes(x = core_type, 
           y = prop, 
           fill = material)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  
  labs(
    x = "",
    y = "Percentage (%)",
    fill = "Raw Material"  # 添加图例标题
  ) +
  
  # 添加带正确数量的横坐标标签
  scale_x_discrete(labels = core_type_labels_correct) +
  
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    limits = c(0, 100),
    expand = expansion(mult = c(0, 0.05))
  ) +
  
  scale_fill_manual(
    values = c(
      "Lava" = "orange",
      "Dolomite" = "#b2abd2",
      "Chert" = "gray",
      "Other" = "gray40"
    )
  ) +
  
  theme_minimal(base_size = 10) +
  theme(
    # 图例放在右上角
    legend.position = c(0.95, 0.95),
    legend.justification = c(1, 1),
    legend.background = element_rect(fill = "white", color = "black", size = 0.3),
    legend.key.size = unit(0.4, "cm"),
    legend.spacing.y = unit(0.1, "cm"),
    legend.margin = margin(3, 3, 3, 3),
    legend.title = element_text(size = 9),  # 调整图例标题大小
    
    # 其他样式
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 9, lineheight = 0.8)
  )



df_long1 <- df %>%
  pivot_longer(cols = -material, names_to = "category", values_to = "count") %>%
  group_by(category) %>%
  mutate(prop = count / sum(count) * 100) %>%
  ungroup() %>%
  mutate(
    category = factor(category, 
                      levels = c("spheroids","Polys_and_Multi_cores", "cores", "total")),
    material = factor(material, 
                      levels = c("Lava", "Dolomite", "Chert", "Other"))
  )

df_long1 <- df_long1 %>%
  mutate(text = paste0("n = ", count, ", ", round(prop, 1), "%"))

lava_total_text <- df_long1 %>% filter(material == "Lava", category == "total") %>% pull(text)
dolomite_total_text <- df_long1 %>% filter(material == "Dolomite", category == "total") %>% pull(text)
chert_total_text <- df_long1 %>% filter(material == "Chert", category == "total") %>% pull(text)
other_total_text <- df_long1 %>% filter(material == "Other", category == "total") %>% pull(text)

lava_spheroids_text <- df_long1 %>% filter(material == "Lava", category == "spheroids") %>% pull(text)
dolomite_spheroids_text <- df_long1 %>% filter(material == "Dolomite", category == "spheroids") %>% pull(text)
chert_spheroids_text <- df_long1 %>% filter(material == "Chert", category == "spheroids") %>% pull(text)
other_spheroids_text <- df_long1 %>% filter(material == "Other", category == "spheroids") %>% pull(text)

lava_multi_text <- df_long1 %>% filter(material == "Lava", category == "Polys_and_Multi_cores") %>% pull(text)
dolomite_multi_text <- df_long1 %>% filter(material == "Dolomite", category == "Polys_and_Multi_cores") %>% pull(text)
chert_multi_text <- df_long1 %>% filter(material == "Chert", category == "Polys_and_Multi_cores") %>% pull(text)
other_multi_text <- df_long1 %>% filter(material == "Other", category == "Polys_and_Multi_cores") %>% pull(text)


```

The Qianshangying site complex consists of four localities from QSY-A to QSY-D, discovered in 2015. It is among the region’s most artifact-rich archaeological site. Geomorphological and sedimentological evidence indicates that the stratigraphy at the site records a full cycle of lake expansion, retreat, re-expansion, and eventually disappearance of the ancient Nihewan lake, and hominin occupation occurred in a marginal lacustrine setting during a low lake-level episode [@zhou1991study; @deng2008timing; @yuan2009formation; @li2020paleoclimatic; @ye2024; @Ye2025Qianshangying]. The stratigraphic context of Qianshangying indicates a short-term occupation resulting from a single hominin activity event. Analyses of artefact orientations and size distributions indicates that the assemblage appears to be largely *in situ*, exhibiting minimal disturbance after deposition [@Ye2025Qianshangying]. ESR dating of the cultural layer places hominin activity at approximately 429 ± 39 ka [@Ye2025Qianshangying].

A total of 955 stone artifacts were recovered from four localities at Qianshangying. Following a widely used techno-typological framework [@Isaac1981; @Isaac1986; @delatorre2004; @de2018oldowan; @pei2017] (The numerical distribution and proportional composition of these categories are provided in the supplementary material), the distinction between spheroids and other lithic categories was independently assessed by two researchers. Spheroids and subspheroids are all faceted stone tools with intensive flake scars on the surface. Within this continuum, spheroids show a more symmetrical morphology and more extensive flake scar coverage, while subspheroids are characterized by lower symmetry and a less intensive degree of shaping. Compared to multifacial cores and polyhedrons, spheroids and subspheroids are characterized by more rounded edges rather than sharp angles, consistent with our consensus definition of near-spherical forms. Spheroids were confirmed by both researchers and classified as spheroids; together forming a spheroid group of 13 artifacts, including 6 spheroids and 7 subspheroids, accounting for 1.3% of the total lithic assemblage. Multifacial cores and polyhedrons are intensively flaked cores with more than three flaking surfaces, with polyhedrons generally regarded as approaching spherical forms [@de2011early]. In this study, artifacts with a thickness-to-length ratio greater than 0.6 are operationally classified as polyhedrons (n = 17), as these specimens tend to exhibit more comparable dimensions along the three principal axes, whereas the remaining pieces are classified as multifacial cores (n = 12). Importantly, this classification reflects a morphological continuum rather than discrete categories; the threshold value of 0.6 is adopted as a practical criterion to distinguish polyhedrons from multifacial cores, producing roughly comparable sample sizes for the two categories within the assemblage.


Raw materials at Qianshangying were classified into four categories following @pei2002 and @pei2017: lava, dolomite, chert, and others. The overall assemblage is dominated by lava ( `r lava_total_text` ), followed by dolomite ( `r dolomite_total_text` ), with smaller proportions of chert ( `r chert_total_text` ) and other materials ( `r other_total_text` ). The composition of cores closely mirrors this distribution, among them, polyhedrons and multifacial cores show higher frequency on chert ( `r chert_multi_text` ) and lower frequency on dolomite ( `r dolomite_multi_text` ). In contrast, spheroids and subspheroids exhibit a marked preference for lava (`r lava_spheroids_text`), with reduced use of siliceous dolomite ( `r dolomite_spheroids_text` ) and no use of chert. Compared to the cores, spheroids and subspheroids show a stronger reliance on lava and a diminished use of more fragile materials, suggesting a selective strategy favoring raw materials with more stable and homogeneous physical properties.

```{r, echo=FALSE}
#| label: fig-core-spheroid-size
#| fig-cap: "Box plot comparing core, spheroid, and multifacial core dimensions"

library(tidyverse)
library(readxl)
library(here)
library(dplyr)

file_path <- here("analysis/data/derived_data/cores_spheroids_size.xlsx")
data <- read_excel(file_path)

summary_vars <- data %>%
  select(core_length, core_width, core_thickness, core_weight,
         spheroid_length, spheroid_width, spheroid_thickness, spheroid_weight,
          multi_poly_length, multi_poly_width, multi_poly_thickness)

summary_stats <- summary_vars %>%
  summarise(across(everything(),
                   list(mean = ~mean(.x, na.rm = TRUE),
                        sd = ~sd(.x, na.rm = TRUE)),
                   .names = "{.col}_{.fn}"))

long_data <- data %>%
  select(core_length, core_width, core_thickness,
         spheroid_length, spheroid_width, spheroid_thickness,
         multi_poly_length, multi_poly_width, multi_poly_thickness) %>%
  pivot_longer(
    everything(),
    names_to = "type_metric",
    values_to = "value"
  ) %>%
  extract(type_metric, into = c("artifact", "metric"),
          regex = "^(core|spheroid|multi_poly)_(length|width|thickness)") %>%
  filter(!is.na(value)) %>%
  mutate(
    artifact = recode(artifact,
                      "core" = "Cores",
                      "spheroid" = "Sub/ Spheroids",
                      "multi_poly" = "Polyhedrons/ Multifacials"),
    metric = factor(metric, levels = c("length", "width", "thickness"))
  )


p_dimensions <- 
ggplot(long_data, aes(x = metric, y = value, fill = artifact)) +
  geom_boxplot(position = position_dodge(0.8), width = 0.5) +
  labs(
    x = "",
    y = "Measurement (mm)",
    fill = "Technological Type"
  ) +
  scale_fill_manual(values = c(
    "Cores" = "gray", 
    "Sub/ Spheroids" = "orange", 
    "Polyhedrons/ Multifacials" = "#b2abd2"
  )) +
  theme_minimal(base_size = 10) +
  theme(
    # 图例放在右上角
    legend.position = c(0.95, 0.95),
    legend.justification = c(1, 1),
    legend.background = element_rect(fill = "white", color = "black", size = 0.3),
    legend.key.size = unit(0.4, "cm"),
    legend.spacing.y = unit(0.1, "cm"),
    legend.margin = margin(3, 3, 3, 3),
    legend.title = element_text(size = 9),  # 调整图例标题大小
    
    # 其他样式
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 9)
  )



```

In terms of dimensions, the average length, width, thickness, and mass of spheroids and subspheroids were `r round(summary_stats$spheroid_length_mean, 1)` mm (SD = `r round(summary_stats$spheroid_length_sd, 1)`), `r round(summary_stats$spheroid_width_mean, 1)` mm (SD = `r round(summary_stats$spheroid_width_sd, 1)`), `r round(summary_stats$spheroid_thickness_mean, 1)` mm (SD = `r round(summary_stats$spheroid_thickness_sd, 1)`), and `r round(summary_stats$spheroid_weight_mean, 1)` g (SD = `r round(summary_stats$spheroid_weight_sd, 1)`), respectively, as shown in @fig-basic-characteristics. Few spheroids and subspheroids showed outlier values in size, being either unusually large or small, while the rest exhibited relatively concentrated size distributions. Polyhedrons and multifacial cores displayed similar variability in size, with standard deviations of `r round(summary_stats$multi_poly_length_sd, 1)` , `r round(summary_stats$multi_poly_width_sd, 1)` , and `r round(summary_stats$multi_poly_thickness_sd, 1)`for length, width, and thickness, respectively. However, spheroids and subspheroids tend to have similar values across length, width, and thickness, reflecting their overall symmetry. Polyhedrons and multifacial cores show marked differences among these dimensions, indicating more irregular and elongated forms.

```{r}
#| label: fig-basic-characteristics
#| fig-cap: "Basic characteristics of the Qianshangying assemblage. A: Raw material proportions. B: Box plot comparing basic metric dimensions of cores, spheroids, and multifacial cores"
#| echo: false

library(cowplot)

p_combined <- plot_grid(
  p_raw_material,
  p_dimensions,
  labels = "AUTO",
  ncol = 2
)

ggsave(
  filename = here("analysis/paper/figures/basic_characteristics2.png"),
  plot = p_combined,
  width = 9,   
  height = 4,  
  dpi = 300
)

knitr::include_graphics(here("analysis/paper/figures/basic_characteristics2.png"))
```

# Methods

We generated 3D models of the cores for morphometric and technological analysis. Digital data were captured using Artec Spider, and post-processing was carried out with Artec Studio 18. Methods and indicators used in this research are generally listed in supplementary material files methods_and_indicators_outline.xlsx. The 3D scan files and all the R (4.4.3) and Python (3.10.2) code used in the analyses reported here are openly available online at https://doi.org/10.17605/OSF.IO/CTNE9/. 

## Morphometric Analysis

```{r, echo=FALSE}

file_path <- here("analysis/data/derived_data/core_typology_morphological_parameters.xlsx")
data_raw <- read_excel(file_path)

# get Sphericity and SHE values from the Python workflow and join them on 
sphericity_results <- 
  here("analysis/data/raw_data/SPHARM_sphericity_curvature_result/sphericity_iso.csv") %>%  
  read_csv %>% 
  mutate(ID = str_replace_all(ID, "-", "_"))

she_results <- 
  here("analysis/data/raw_data/SPHARM_sphericity_curvature_result/SHE.csv") %>%  
  read_csv() %>% 
  mutate(ID = str_replace_all(filename, "-", "_"))

# import excel sheet with lithology, typology, etc.
file_path <- here("analysis/data/derived_data/core_typology_morphological_parameters.xlsx")
data_raw_0 <- read_excel(file_path)

# join with data from Python workflow (we never want to do this by hand and break the workflow)
data_raw <- 
data_raw_0 %>% 
  left_join(sphericity_results, by = "ID") %>% 
  left_join(she_results, by = "ID") %>% 
  select(ID, 
         Rock_type,
         `Blank type`,
         `Final morphology`,
          Typology = `Typology.x`,
         `typology by SPHARM`,
          Sphericity = sphericity,
          SHE)



data_clean <- data_raw |>
  mutate(across(
    where(is.character),
    ~ str_to_title(str_squish(trimws(.x)))
  ))


typology_counts <- data_clean |> 
  count(Typology, sort = TRUE)

n_total_typology <- data_clean |> 
  filter(!is.na(Typology)) |> 
  nrow()


group_counts <- data_clean |>
  filter(Typology %in% c("Polyhedron", "Multifacial", "Spheroid", "Subspheroid")) |>
  mutate(
    Group = case_when(
      Typology %in% c("Polyhedron", "Multifacial") ~ "Polyhedron + Multifacial",
      Typology %in% c("Spheroid", "Subspheroid") ~ "Spheroid + Subspheroid"
    )
  ) |>
  count(Group)

n_poly_multi <- group_counts$n[group_counts$Group == "Polyhedron + Multifacial"]
n_sub_spheroid <- group_counts$n[group_counts$Group == "Spheroid + Subspheroid"]


```

In our morphometric study, we used quantitative methods including the sphericity index, spherical harmonics with spherical harmonic energy (SHE) to show the shape features of spheroids and subspheroids. We assessed the degree of standardization of spheroids and subspheroids by calculating the coefficients of variation (CVs) of shape proxies, defined as the sample standard deviation divided by the sample mean [@Eerkens2001; @muller2023] of shape proxies. Following @Eerkens2001, a CV below 1.7% (0.017) was taken as threshold of standardized manual production. Furthermore, we compared the results of the typological classification and our new morphometric analyses.

### 3D spherical harmonics analysis

Spherical Harmonic (SPHARM) analysis is a method for describing 3D shapes using a series of mathematical functions defined on the surface of a sphere. It works like a 3D version of Fourier analysis, breaking down complex shapes into components of different spatial frequencies. Each shape $f(\theta, \phi)$ is first mapped onto a unit sphere and then expressed as a combination of spherical harmonic basis functions $Y_l^m(\theta, \phi)$ according to

$$
f(\theta, \phi) = \sum_{l=0}^{\infty} \sum_{m=-l}^{l} \hat{f}(l, m) \, Y_l^m(\theta, \phi)
$$

where the set of coefficients $\hat{f}(l, m)$ quantifies how much each basis function contributes to the overall shape. Here, θ and ϕ are angles in spherical coordinates, l and m are order and degree respectively. Lower-order terms describe the general shape, while higher-order terms capture finer details (@fig-SPHARM-Reconstruction-by-Degree). 

```{r, echo=FALSE}
#| label: fig-SPHARM-Reconstruction-by-Degree
#| fig-cap: "Shape reconstruction of selected archaeological spheroids using SPHARM (various lmax levels)"


library(here)
knitr::include_graphics(here("analysis/paper/figures/SPHARM_reconstruction.png"))

```

This method has been widely used in the field of biology, for example in the analysis of skull and cell morphology [@Link2024; @Medyukhina2020; @Harper2022; @Hewitt2024; @Grieb2022]. In contrast, archaeological applications of SPHARM remain limited and have followed a small number of distinct methodological pathways, including the use of SPHARM-based point distribution models to establish surface correspondence for asymmetry assessment (e.g. @sholts2017tracing), the application of spherical harmonics to test hypotheses of intentionality in lithic reduction (e.g. @Muller2023), and the construction of empirical morphospaces via PCA of SPHARM coefficients for descriptive shape analysis (e.g. @Noshita2025). Despite demonstrating the potential of SPHARM for archaeological materials, these studies commonly focus on descriptive interpretations of spherical harmonic coefficients or their principal components, and are largely confined to linear dimensionality reduction frameworks, which may limit the exploration of high-resolution or non-linear structure in shape variation. Moreover, open and fully reproducible analytical workflows are still rarely implemented in archaeological applications of SPHARM.

Our work builds on previous archaeological applications of SPHARM to present an open-source and fully reproducible workflow for quantitative shape analysis of stone artefacts. We extend existing approaches by combining rotation-invariant spherical harmonic power spectrum with non-linear dimensionality reduction using Uniform Manifold Approximation and Projection (UMAP), enabling feature-based exploration and unsupervised grouping of spheroids and cores, which substantially extends the depth of analysis provided by SPHARM.


```{r, echo=FALSE}
#| label: fig-SPHARM-steps
#| fig-cap: 'Schematic summary of the key steps of 3D spherical harmonics analysis. ① Spherical harmonic expansion: $f(\theta, \phi) = \sum_{l=0}^{\infty} \sum_{m=-l}^{l} \hat{f}(l, m) Y_l^m(\theta, \phi)$; ② Rotation-invariant power spectrum: $F(l) = \sum_{m=-l}^{l} \hat{f}_n^2(l, m)$; ③ Spherical harmonic energy (SHE): $E = \sum_{l=0}^{\infty} \sum_{m=-l}^{l} \hat{f}_n^2(l, m)$'
    
library(here)
knitr::include_graphics(here("analysis/paper/figures/SPHARM_steps.png"))

```

As shown in @fig-SPHARM-steps, following @Medyukhina2020 and @Link2024, scanned models of spheroids and cores were imported, clean ed, simplified, and normalized to obtain 3D mesh vertices. These vertices were converted from Cartesian (x, y, z) to spherical coordinates (r, θ, φ), and radial values were interpolated onto a regular N×N spherical grid. Spherical harmonic decomposition was then performed using the Driscoll–Healy sampling scheme [@wieczorek2018shtools], setting the maximum degree to 20 (lmax=20, @fig-SPHARM-Reconstruction-by-Degree). This choice ensures that sufficient geometric detail is captured while avoiding high-frequency noise and overfitting artifacts. After normalization, all models have their degree 0 (l=0) coefficient set to 1, allowing for meaningful comparison across different models.

From the normalized spherical harmonic coefficients, we computed the rotation-invariant power spectrum by summing the squared magnitudes of coefficients at each degree, yielding a multidimensional and orientation-independent shape descriptor for each model. Using these rotation-invariant power spectrum as input, we applied UMAP for non-linear dimensionality reduction and visualization [@Van2023], preserving both local and global similarity structure in the shape data. Clusters in the resulting UMAP space were identified using K-means clustering, providing a quantitative basis for grouping spheroids, polyhedrons, and multifacial cores. To aid interpretation of the morphospace and cluster assignments, a set of standard geometric reference models (sphere, rounded cube, ellipsoid, rounded box, and disc-like forms) were included in the analyses, allowing artefacts to be positioned relative to these reference shapes and facilitating morphological interpretation of groupings based on both cluster membership and shape similarity. The data acquisition related to SPHARM is all carried out using Python.

### Spherical Harmonic Energy and Sphericity Index

We computed the spherical harmonic energy (SHE), defined as the sum of squared normalized spherical harmonic coefficients for each degree. This provides a rotation-invariant measure of overall shape complexity and surface regularity. For normalized shapes, this total energy approaches a value of one for a perfect sphere, while more irregular shapes yield higher values.

we also employed a standardized sphericity index originally proposed by @Wadell1935 and later adapted for 3D digital models in geoscientific research. The index is calculated using volume and surface area of the artifact. This dimensionless metric yields a maximum value of 1 for a perfect sphere. While values closer to 1 generally indicate a more spherical geometry, sphericity is calculated solely from volume and surface area. We used Python to derive surface area and volume measurements from 3D mesh models.

Classic sphericity index [@Wadell1935] may exhibit limitations in differentiating morphotypes with equivalent surface-area-to-volume ratios. SHE supplements this by performing spherical harmonic decomposition of surface morphology, and this allows it to distinguish localized irregularities (like core edge or concave) from global shape deviations (e.g., elongation)-differences that classic sphericity metrics often fail to capture.

## Technological Analysis

We applied technological analysis of the production strategies of spheroids and subspheroids in Qianshangying [@Link2024; @Grieb2022]. Together these methods help determine whether the artifacts were intentionally shaped and whether their manufacture followed standardized procedures. Addressing this question is crucial for achieving our goal of determining whether or not spheroids and subspheroids represent a distinct technological category, separate from exhausted cores.

### Diacritical analysis

We used diacritical analysis to reconstruct the reduction sequence based on superimposition relationships among scars on spheroids and subsoheroids [@tittonSubspheroidsLithicAssemblage2020; @Cabanes2024]. This method enables the identification of the order of scar removal, allowing us to understand the organization of removals. All spheroids and subsoheroids were included in the analysis to assess whether their removal were organized systematically.

Following the reconstruction of reduction sequences, we adopted an inductive approach to infer exploitation models of spheroids, that is, the removal patterns and associated stages employed in a spheroid. If consistent patterns can be observed, they may indicate shared reduction schemes or conceptual templates. We also explored whether multifacial cores and polyhedrons may represent earlier stages in spheroid reduction sequences, contributing to understanding the technological relationship between these types.

### Orientation analysis

To further investigate technological strategies, we incorporated orientation statistics as a complementary approach. This method derives from fabric analysis originally used in sedimentology and has since been adapted to study the arrangement of flake scars on lithic artifacts. We followed the protocol developed by @lin2024. In our study, only those scars with a length greater than 5mm were recorded, after extracting scar vectors from each samples and calculating eigenvalues we computed the isotropic ratio and elongation ratio and visualized the result in a ternary plot. These steps were carried out in Geomagic Wrap 2021, Rhino8 and R 4.4.3 and documented in @ye2025workflow.

Results were visualized using ternary plots to compare orientation statistics between spheroids and other core types. Based on our hypothesis, if spheroids were shaped following a consistent reduction sequence, they should exhibit similar and patterned orientation results. In contrast, if they merely represented exhausted cores, the orientation patterns would appear random and highly variable, similar to those of undirected polyhedron and multifacial cores.

## Efficiency of shaping strategy

The following method aims to test a hypothesis regarding reduction strategy. We propose that knappers may have employed an efficient shaping strategy directed toward achieving a spherical form. If such a strategy existed, then across the assemblage of final products, we should observe that as reduction intensity increases, spheroid morphology progressively approximates a perfect sphere. To test this hypothesis, we established two sets of quantitative proxies: one for inferred reduction intensity and another for final morphology. Specifically, a significant positive correlation between these two sets of proxies would support the inference that increased reduction intensity was systematically associated with shapes closer to a sphere, implying a goal-directed reduction strategy.

### Intensity of reduction

To compute the degree of reduction we collected data on three metrics: scar number, removal ratio and scar density index (SDI). We measured scar number as total number of flake scars visible on the spheroid surface. Removal ratio was calculated as 1 minus cortex ratio, where the cortex ratio represents the proportion of cortical surface area to total surface area [@Cabanes2024]. We used the removal ratio instead of the traditional cortex ratio in order to maintain a positive correlation with other reduction intensity indicators. The scar density index (SDI), defined as the number of flake scars divided by the total surface area, serves as a robust indicator of core reduction intensity, effectively capturing the dynamic nature of the reduction process (following @clarksonMeasuringCoreReduction2013). In all three metrics, higher values represent more advanced stages of reduction. Scar counts and surface area measurements were extracted using Geomagic Wrap.

### Spheroid shape

We measured spheroid shape with four metrics: sphericity index, and spherical harmonic energy (SHE), along with mean edge angle, mean surface curvature. To assess mean edge angle, ten edge intersections were randomly sampled on each spheroid, and edge angles were calculated following @tittonSubspheroidsLithicAssemblage2020 by constructing triangles at ridge intersections, extracting vertex coordinates in Geomagic Wrap, and computing the angles from these coordinates using trigonometric functions in R. Higher mean edge angles indicate a more spherical geometry. We estimated local curvature for each triangular face of the 3D mesh model using a k-nearest neighbors approach in Python. For each triangle, a best-fit plane was fitted to its neighboring triangle centers, and the angle between the triangle’s normal and the best-fit plane’s normal was computed. The average of these angles across all triangles was served as mean surface curvature and quantified overall surface roughness, with larger values indicating greater roughness. Together, these four variables allowed us to assess whether more extensively reduced spheroids display more standardized, symmetrical, and regular morphologies-characteristics expected in deliberate shaping strategies.

We conducted Spearman’s rank correlation analysis between two sets of variables, reduction intensity indicators and morphological attributes. This non-parametric method is appropriate for small sample sizes and data that do not follow a normal distribution. Spheroids and subspheroids from Qianshangying were included in the analysis.

# Results

## Morphometric analysis

```{r tbl-1, echo=FALSE}

knitr::kable(data_raw %>% 
               mutate(across(where(is.numeric), round, 3)), 
             caption = "Summary of core typology and morphological parameters.")

```

```{r, echo=FALSE}

# Groups

mean_sphericity_tbl <- data_clean |>
  filter(Typology %in% c("Polyhedron", "Multifacial", "Spheroid", "Subspheroid")) |>
  mutate(
    Group = case_when(
      Typology %in% c("Polyhedron", "Multifacial") ~ "Polyhedron + Multifacial",
      Typology %in% c("Spheroid", "Subspheroid") ~ "Spheroid + Subspheroid"
    )
  )

#view(mean_sphericity_tbl)

# Mean Sphericity

mean_sphericity_summary <- mean_sphericity_tbl |>
  group_by(Group) |>
  summarise(mean_sphericity = mean(Sphericity, na.rm = TRUE)) |>
  ungroup()


mean_sphericity_poly_multi <- mean_sphericity_summary$mean_sphericity[mean_sphericity_summary$Group == "Polyhedron + Multifacial"] |> round(3)
mean_sphericity_sub_spheroid <- mean_sphericity_summary$mean_sphericity[mean_sphericity_summary$Group == "Spheroid + Subspheroid"] |> round(3)
```

```{r, include=FALSE} 

# Mann-Whitney U test
# between sphericity_poly_multi and sphericity_sub_spheroid

group_poly_multi <- mean_sphericity_tbl$Sphericity[mean_sphericity_tbl$Group == "Polyhedron + Multifacial"]
group_sub_spheroid <- mean_sphericity_tbl$Sphericity[mean_sphericity_tbl$Group == "Spheroid + Subspheroid"]


mann_whitney_result_sphericity <- wilcox.test(group_poly_multi, group_sub_spheroid, exact = FALSE)

U_value <- mann_whitney_result_sphericity$statistic  
p_value <- mann_whitney_result_sphericity$p.value    

pretty_print_sci <- function(num) {
  sci_str <- sprintf("%.2e", num)
  parts <- strsplit(sci_str, "e")[[1]]
  base <- parts[1]
  exponent <- as.integer(parts[2])
  paste0(base, " \\times 10^{", exponent, "}")
}

p_value_Mann_sci <- pretty_print_sci(p_value)


# 从 data_clean 中直接提取三组数据
group_multifacial <- data_clean$Sphericity[data_clean$Typology == "Multifacial"]
group_polyhedron <- data_clean$Sphericity[data_clean$Typology == "Polyhedron"]
group_sub_spheroid <- data_clean$Sphericity[data_clean$Typology %in% c("Spheroid", "Subspheroid")]

# 检查数据
cat("=== 数据检查 ===\n")
cat("Multifacial 样本量:", length(group_multifacial[!is.na(group_multifacial)]), "\n")
cat("Polyhedron 样本量:", length(group_polyhedron[!is.na(group_polyhedron)]), "\n")
cat("Spheroid/Subspheroid 样本量:", length(group_sub_spheroid[!is.na(group_sub_spheroid)]), "\n\n")

# Mann-Whitney U检验1: Multifacial vs Spheroids/Subspheroids
if (length(group_multifacial[!is.na(group_multifacial)]) > 0 && 
    length(group_sub_spheroid[!is.na(group_sub_spheroid)]) > 0) {
  
  cat("=== Multifacial vs Spheroids/Subspheroids ===\n")
  mann_whitney_multifacial <- wilcox.test(
    group_multifacial[!is.na(group_multifacial)], 
    group_sub_spheroid[!is.na(group_sub_spheroid)], 
    exact = FALSE
  )
  print(mann_whitney_multifacial)
  cat("\n")
  
} else {
  cat("Multifacial vs Spheroids/Subspheroids: 数据不足\n\n")
}

# Mann-Whitney U检验2: Polyhedron vs Spheroids/Subspheroids
if (length(group_polyhedron[!is.na(group_polyhedron)]) > 0 && 
    length(group_sub_spheroid[!is.na(group_sub_spheroid)]) > 0) {
  
  cat("=== Polyhedron vs Spheroids/Subspheroids ===\n")
  mann_whitney_polyhedron <- wilcox.test(
    group_polyhedron[!is.na(group_polyhedron)], 
    group_sub_spheroid[!is.na(group_sub_spheroid)], 
    exact = FALSE
  )
  print(mann_whitney_polyhedron)
  
} else {
  cat("Polyhedron vs Spheroids/Subspheroids: 数据不足\n")
}

# Mann-Whitney U检验3: Multifacial vs Polyhedron
if (length(group_multifacial[!is.na(group_multifacial)]) > 0 && 
    length(group_polyhedron[!is.na(group_polyhedron)]) > 0) {
  
  cat("\n=== Multifacial vs Polyhedron ===\n")
  mann_whitney_multi_poly <- wilcox.test(
    group_multifacial[!is.na(group_multifacial)], 
    group_polyhedron[!is.na(group_polyhedron)], 
    exact = FALSE
  )

  
} else {
  cat("\nMultifacial vs Polyhedron: 数据不足\n")
}

U_multi_poly <- mann_whitney_multi_poly$statistic  
p_multi_poly <- mann_whitney_multi_poly$p.value    

p_multi_poly_sci <- pretty_print_sci(p_multi_poly)

```

```{r, echo=FALSE}

mean_SHE_tbl <- data_clean |>
  filter(Typology %in% c("Polyhedron", "Multifacial", "Spheroid", "Subspheroid")) |>
  mutate(
    Group = case_when(
      Typology %in% c("Polyhedron", "Multifacial") ~ "Polyhedron + Multifacial",
      Typology %in% c("Spheroid", "Subspheroid") ~ "Spheroid + Subspheroid"
    )
  )

# Mean SHE

mean_SHE_summary <- mean_SHE_tbl |>
  group_by(Group) |>
  summarise(mean_SHE = mean(SHE, na.rm = TRUE)) |>
  ungroup()


mean_SHE_poly_multi <- mean_SHE_summary$mean_SHE[mean_SHE_summary$Group == "Polyhedron + Multifacial"] |> round(3)
mean_SHE_sub_spheroid <- mean_SHE_summary$mean_SHE[mean_SHE_summary$Group == "Spheroid + Subspheroid"] |> round(3)

```

```{r, echo=FALSE}

# Mann-Whitney U test
# between SHE_poly_multi and SHE_sub_spheroid

group_poly_multi2 <- mean_SHE_tbl$SHE[mean_SHE_tbl$Group == "Polyhedron + Multifacial"]
group_sub_spheroid2 <- mean_SHE_tbl$SHE[mean_SHE_tbl$Group == "Spheroid + Subspheroid"]

mann_whitney_result_SHE <- wilcox.test(group_poly_multi2, group_sub_spheroid2, exact = FALSE)

U_value2 <- mann_whitney_result_SHE$statistic  
p_value2 <- mann_whitney_result_SHE$p.value    


p_value_Mann_sci2 <- pretty_print_sci(p_value2)

```

```{r, echo=FALSE}

# Kruskal–Wallis test
# on sphericity among clusters

kruskal_result <- kruskal.test(Sphericity ~ `typology by SPHARM`, data = data_clean)

H_value <- kruskal_result$statistic
df_kruskal <- kruskal_result$parameter
p_value_kruskal <- kruskal_result$p.value
p_value_kruskal_sci <- pretty_print_sci(p_value_kruskal)

```

```{r, include=FALSE}

# Pearson correlation test

cor_test_pearson <- cor.test(data_clean$Sphericity, data_clean$`SHE`, method = "pearson")


t_value <- cor_test_pearson$statistic
df_value <- cor_test_pearson$parameter
p_value <- cor_test_pearson$p.value
correlation <- cor_test_pearson$estimate

p_value_pearson_sci <- pretty_print_sci(p_value)

# --- Label 1: The 'r' value ---
label_r <- bquote(italic(r) == .(round(correlation, 3)))

# --- Label 2: The 'p' value (formatted) ---
exponent <- floor(log10(p_value))
mantissa <- round(p_value / 10^exponent, 2)
label_p <- bquote(italic(p) == .(mantissa) %*% 10^.(exponent))

# --- Label 3: The 'n' value ---
label_n <- bquote(n == .(nrow(data_clean)))

# Define the position for the text block
x_pos <- 0.875
y_pos_start <- 1.06
v_spacing <- 0.005 

p_corr_sphericity_she <- 
ggplot(data_clean, aes(x = Sphericity, y = `SHE`)) +
  geom_point(size = 3, alpha = 0.9, color = "grey60") +
  geom_smooth(method = "lm", 
              se = TRUE, 
              color = "black", 
              fill = "#A6CEE3") +
  scale_x_continuous(breaks = seq(0.4, 1.0, by = 0.04)) +
  theme_minimal(base_size = 12)  +
  labs(x = "Sphericity", 
       y = "Spherical Harmonic Energy") +
# --- Annotation Layer 1: 'r' value ---
  annotate("text",
    x = x_pos,
    y = y_pos_start,
    label = as.expression(label_r),
    hjust = 0,  
    size = 5,
    color = "#1C3041"
  ) +
  
  # --- Annotation Layer 2: 'p' value ---
  annotate("text",
    x = x_pos,
    y = y_pos_start - v_spacing, 
    label = as.expression(label_p),
    hjust = 0,  
    size = 5,
    color = "#1C3041"
  ) +
  
  # --- Annotation Layer 3: 'n' value ---
  annotate("text",
    x = x_pos,
    y = y_pos_start - (2 * v_spacing), 
    label = as.expression(label_n),
    hjust = 0,
    size = 5,
    color = "#1C3041"
  )
```

```{r, include=FALSE}


df_long <- mean_sphericity_tbl %>%
  select(Group, Sphericity, `SHE`) %>%
  pivot_longer(cols = c(Sphericity, `SHE`),
               names_to = "Variable",
               values_to = "Value")


df_long <- df_long %>%
  mutate(Group = factor(Group, 
                        levels = c("Spheroid + Subspheroid", 
                                   "Polyhedron + Multifacial"),
                        labels = c("Spheroid + Subspheroid", 
                                   "Polyhedron + Multifacial"))) %>% 
  mutate(
    Group = case_when(
      Group == "Spheroid + Subspheroid" ~  "Spheroid\nSubspheroid", 
      Group == "Polyhedron + Multifacial" ~  "Polyhedron\nMultifacial",
      TRUE ~ NA_character_
    )
  )


p_sphericity_and_she <- 
ggplot(df_long, aes(x = Group, 
                    y = Value, 
                    fill = Group,
                    colour = Group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.5) +
  geom_jitter(width = 0.15, 
              alpha = 1, 
              size = 1) +
  facet_wrap(~ Variable, scales = "free_y") +
  scale_fill_manual(values = c("Spheroid\nSubspheroid" = "orange", 
                               "Polyhedron\nMultifacial" = "#b2abd2")) +
  scale_colour_manual(values = c("Spheroid\nSubspheroid" = "orange", 
                               "Polyhedron\nMultifacial" = "#b2abd2")) +
  labs(x = "",
       y = "",
       fill = "Group", 
       ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none"
  )
```

```{r, include=FALSE}

df <- read_csv(
  here("analysis", "data", "derived_data", "variance_per_degree.csv")
)

p_variance_per_degreee <- 
ggplot(df, aes(x = degree, y = variance)) +
  geom_line(size = 1.3, colour = "black") +          
  geom_point(size = 3, colour = "grey60") +  
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +    
  scale_y_continuous(breaks = scales::pretty_breaks(n = 8)) +      
  labs(
   # title = "Variance per Degree",
    x = "Spherical Harmonic Degree",
    y = "Variance"
  ) +
  theme_minimal(base_size = 12) 

```

```{r, echo=FALSE}

data_dir <- here("analysis", "data", "derived_data", "power_spectrum")
csv_files <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)


all_data <- map_dfr(csv_files, function(file) {
  df <- read.csv(file, header = FALSE)
  colnames(df) <- c("degree", "total_power", "max_amplitude", "total_amplitude")
  df$file <- basename(file)
  return(df)
})

#l_2_3_power <- all_data %>%
  #filter(degree %in% c(2, 3)) %>%
  #select(file, degree, total_power) %>%
  #pivot_wider(names_from = degree, values_from = total_power, names_prefix = "l_")

#View(l_2_3_power)

# group of polyhedrons and spheroids
all_data <- all_data %>%
  mutate(
    group = case_when(
      str_detect(file, regex("Polyhedron|Multifacial", ignore_case = TRUE)) ~ "Polyhedron/Multifacial",
      str_detect(file, regex("Spheroid|Subspheroid", ignore_case = TRUE)) ~ "Spheroid/Subspheroid",
      TRUE ~ NA_character_
    )
  )

# group of all specimens
all_data_all <- all_data %>%
  mutate(group = "All specimens")

# combine groups
combined_data <- bind_rows(all_data, all_data_all) %>%
  filter(!is.na(group))

# mean vaule and sd of degrees
summary_df <- combined_data %>%
  group_by(group, degree) %>%
  summarise(
    mean_power = mean(total_power, na.rm = TRUE),
    sd_power = sd(total_power, na.rm = TRUE),
    .groups = "drop"
  )


p_power_spectrum <- 
ggplot(summary_df, aes(x = degree, y = mean_power, color = group, fill = group)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(
    ymin = pmax(mean_power - sd_power, 1e-10),
    ymax = mean_power + sd_power
  ), alpha = 0.2, linetype = 0) +
  scale_y_log10(
  breaks = c(1e-8, 1e-6, 1e-4, 1e-2, 1),
  labels = parse(text = c("10^-8", "10^-6", "10^-4", "10^-2", "10^0"))
  )+
  scale_x_continuous(
    limits = c(0, 20),
    breaks = seq(0, 20, by = 4),
    expand = c(0, 0)
  ) +
  coord_cartesian(clip = "on") +
  scale_color_manual(values = c(
    "All specimens" = "grey60",
    "Spheroid/Subspheroid" = "orange",
    "Polyhedron/Multifacial" = "#b2abd2"
  )) +
  scale_fill_manual(values = c(
    "All specimens" = "grey60",
    "Spheroid/Subspheroid" = "orange",
    "Polyhedron/Multifacial" = "#b2abd2"
  )) +
  labs(
   # title = "Mean Power Spectrum with Standard Deviation",
    x = "Degree (l)",
    y = "Mean Total Power (log scale)",
    color = "Group",
    fill = "Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
  legend.position = c(0.95, 0.4),
  legend.justification = c("right", "top"),
  legend.background = element_rect(fill = alpha("white", 0.8), color = NA),
  legend.box.background = element_rect(color = "gray80"),
  legend.box.margin = margin(5, 5, 5, 5)
  )

```


```{r, echo=FALSE}

# CV of sphericity and SHE

group_sub_spheroids <- mean_sphericity_tbl %>% filter(Group == "Spheroid + Subspheroid")

# sphericity on spheroids
mean_sph_sub_spheroids <- mean(group_sub_spheroids$Sphericity, na.rm = TRUE)
sd_sph_sub_spheroids <- sd(group_sub_spheroids$Sphericity, na.rm = TRUE)
cv_sph_sub_spheroids <- sd_sph_sub_spheroids / 
mean_sph_sub_spheroids

# SHE on spheroids
mean_she_sub_spheroids <- mean(group_sub_spheroids$`SHE`, na.rm = TRUE)
sd_she_sub_spheroids <- sd(group_sub_spheroids$`SHE`, na.rm = TRUE)
cv_she_sub_spheroids <- sd_she_sub_spheroids /
mean_she_sub_spheroids


group_poly_multi <- mean_sphericity_tbl %>% filter(Group == "Polyhedron + Multifacial")

mean_sph_poly_multi <- mean(group_poly_multi$Sphericity, na.rm = TRUE)
sd_sph_poly_multi <- sd(group_poly_multi$Sphericity, na.rm = TRUE)
cv_sph_poly_multi <- sd_sph_poly_multi / mean_sph_poly_multi


mean_she_poly_multi <- mean(group_poly_multi$`SHE`, na.rm = TRUE)
sd_she_poly_multi <- sd(group_poly_multi$`SHE`, na.rm = TRUE)
cv_she_poly_multi <- sd_she_poly_multi / mean_she_poly_multi


```

```{r setup_umap_data, include=FALSE, message=FALSE, warning=FALSE}


umap_data <- read_csv(here("analysis/data/derived_data/umap_lmax20.csv"))


umap_data <- umap_data %>%
  mutate(category_lower = tolower(category)) %>%
  mutate(category_lower = fct_relevel(category_lower,
    "polyhedron", "multifacial", "idealmodel", "subspheroid", "spheroid"
  ))

# Set point size (highlight ideal model)
umap_data <- umap_data %>%
  mutate(point_size = if_else(category_lower == "idealmodel", 4.5, 3))


umap_data %>%
  count(category_lower)
# Elbow method for optimal K
#wss <- numeric(10)  

#for (k in 1:10) {
  #set.seed(123)  
  #km <- kmeans(umap_data[, c("x", "y")], centers = k)
  #wss[k] <- km$tot.withinss  }

#elbow_test <-
  #plot(1:10, wss, type="b", pch=19, frame=FALSE,
       #xlab="Number of clusters K",
       #ylab="Total within-cluster sum of squares (WSS)",
       #main="Elbow Method for Optimal K")

# KMeans clustering (k=4)
set.seed(123)
kmeans_result <- kmeans(umap_data[, c("x", "y")], centers = 3)

# Add clustering results
umap_data <- umap_data %>%
  mutate(
    cluster = factor(kmeans_result$cluster),
    is_idealmodel = if_else(category_lower == "idealmodel", "yes", "no")
  )

x_limits <- range(umap_data$x)
y_limits <- range(umap_data$y)

expand_range <- function(lim, ratio) {
  range_width <- diff(lim)
  return(c(lim[1] - range_width * ratio, lim[2] + range_width * ratio))
}

x_limits <- range(umap_data$x)
y_limits <- range(umap_data$y)

x_limits_expanded <- expand_range(x_limits, 0.10) 
y_limits_expanded <- expand_range(y_limits, 0.15)  

label_data <- umap_data %>%
  filter(category_lower %in% c("idealmodel", "spheroid", "subspheroid"))

```

```{r}
#| echo: false
#| label: fig-umap-by-category
#| include: false

library(dplyr)
library(ggimage)

category_colors <- c(
  "ideal model" = "black",
  "spheroid" = "#e66101",
  "subspheroid" = "#fdb863",
  "multifacial" = "#b2abd2",
  "polyhedron" = "#5e3c99"
)

p_umap_by_category <- 
ggplot(umap_data %>% 
         mutate(category =
                if_else(category == "idealmodel",
                       "ideal model",
                       category)) %>% 
         mutate(category_lower =
                if_else(category_lower == "idealmodel",
                       "ideal model",
                       category_lower)), 
       aes(x = x, y = y)) +
  geom_point(aes(color = category_lower, 
                 size = point_size), 
             alpha = 0.9, 
             shape = 16) +
  scale_color_manual(values = category_colors, 
                     name = "Category") +
  scale_size_identity() +
  coord_cartesian(xlim = x_limits_expanded, 
                  ylim = y_limits_expanded)+ 
  theme_minimal(base_size = 14) +
  theme(legend.position = c(.2,.75),
         legend.background = element_rect(fill = alpha("white", 0.6), color = NA),  
         legend.box.background = element_rect(color = "black"),
         legend.box.margin = margin(0, 0, 0, 0)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  labs(
    x = "UMAP 1",
    y = "UMAP 2"
  ) 


p_umap_by_category <- p_umap_by_category +
  geom_text_repel(
    data = filter(umap_data, category_lower %in% c("spheroid", "subspheroid")),
    aes(
      x = x,
      y = y,
      label = filename
    ),
    size = 3.5,
    segment.color = "grey",
    box.padding = 0.5,
    point.padding = 0.5
  )

selected_files <- c("QSY-A-2797", "QSY-A-2048", "QSY-A-1098", "QSY-B-003")

segments <- umap_data %>%
  filter(filename %in% selected_files) %>%
  mutate(
    xend = case_when(
      filename == "QSY-A-2797" ~ x + 4.7,   
      filename == "QSY-B-003"  ~ x + 3,   
      filename == "QSY-A-1098" ~ x,       
      filename == "QSY-A-2048" ~ x,       
      TRUE ~ x
    ),
    yend = case_when(
      filename == "QSY-A-2797" ~ y,       
      filename == "QSY-B-003"  ~ y,       
      filename == "QSY-A-1098" ~ y - 4,  
      filename == "QSY-A-2048" ~ y - 2,  
      TRUE ~ y
    )
  )

p_umap_by_category <- p_umap_by_category +
  geom_segment(
    data = segments,
    aes(x = x, y = y, xend = xend, yend = yend),
    color = "black",
    linewidth = 0.5
  )

image_data <- data.frame(
  x = c(6, 6, 14.8, 11),
  y = c(1.5, 3.5, 2.8, 2.8),
  image = c(
    here("analysis", "paper", "figures", "QSY-A-2797.png"),
    here("analysis", "paper", "figures", "QSY-B-003.png"),
    here("analysis", "paper", "figures", "QSY-A-1098.png"),
    here("analysis", "paper", "figures", "QSY-A-2048.png")
  )
)

p_umap_by_cluster_with_images <- p_umap_by_category + 
  geom_image(
    data = image_data,
    aes(x = x, y = y, image = image),
    size = 0.2
  )


ggsave(here("analysis/paper/figures/p_umap_by_category1.png"),
       plot = p_umap_by_cluster_with_images,
       width = 10, height = 6, dpi = 300)


```

```{r}
#| echo: false
#| label: fig-umap-by-cluster
#| include: false 

cluster_colors <- RColorBrewer::brewer.pal(4, "Set2")

library(ggforce)
library(ggrepel)
library(ggimage)

umap_data_to_plot <- 
umap_data %>%  
         mutate(category_lower =
                if_else(category_lower == "idealmodel",
                       "ideal model",
                       category_lower),
                filename = case_when(
                  filename == "Rounded_cube" ~ "Cube",
                  filename == "Discoid_like" ~ "Discoid-like",
                 .default = filename)
                )

sphere_data <- filter(umap_data_to_plot, filename == "Sphere")

ellipsoid_data <- filter(umap_data_to_plot, filename == "Ellipsoid")


sphere_data <- sphere_data %>%
  mutate(
    label_x = x + 2.7,    
    label_y = y + 1,      
    mid_x   = x + 1,      
    mid_y   = y + 1      
  )

ellipsoid_data <- ellipsoid_data %>%
  mutate(
    label_x = x + 0.5,    
    label_y = y - 3,      
    mid_x   = x + 0.5,      
    mid_y   = y - 1.6      
  )


p_umap_by_cluster <- ggplot(umap_data_to_plot, aes(x = x, y = y)) +
  
  geom_point(
    data = filter(umap_data_to_plot, is_idealmodel == "no"),
    aes(color = cluster),
    alpha = 0.2,
    size = 2.5
  ) +
  
  geom_point(
    data = filter(umap_data_to_plot, is_idealmodel == "yes"),
    aes(color = cluster),
    size = 4,
    shape = 16,
    alpha = 1,
    shape = 21,                          
    color = "black",                    
    stroke = 1.2,     
    show.legend = FALSE
  ) +

  
  stat_ellipse(aes(color = cluster), type = "norm", level = 0.95, size = 0.7) +
  
  geom_point(aes(color = cluster), size = 3) +


  geom_segment(
    data = sphere_data,
    aes(x = x, y = y, xend = mid_x, yend = mid_y, color = cluster)
  ) +
  geom_segment(
    data = sphere_data,
    aes(x = mid_x, y = mid_y, xend = label_x, yend = label_y, color = cluster)
  ) +
  geom_text(
    data = sphere_data,
    aes(x = label_x, y = label_y, label = filename, color = cluster),
    size = 5,
    hjust = 0
  ) +

  geom_segment( 
    data = filter(umap_data_to_plot, is_idealmodel == "yes", 
                  filename == "Cube"), 
    aes(x = x + 2, y = y, xend = x, yend = y, color = cluster) 
  ) + 
  geom_text( 
    data = filter(umap_data_to_plot, is_idealmodel == "yes", 
                  filename == "Cube"), 
    aes(x = x + 2, y = y, label = filename, color = cluster), 
    size = 5, 
    hjust = 0 
  ) +
  
  

  geom_text_repel( 
    data = filter(umap_data_to_plot, is_idealmodel == "yes", 
                  filename %in% c("Discoid-like", "Box")), 
    aes(color = cluster, label = filename), 
    size = 5, 
    nudge_x = 0, 
    box.padding = 0.5, 
    nudge_y = -2, 
    ylim = c(4, 4) 
  ) +

  
    geom_segment(
    data = ellipsoid_data,
    aes(x = x, y = y, xend = mid_x, yend = mid_y, color = cluster)
  ) +
  geom_segment(
    data = ellipsoid_data,
    aes(x = mid_x, y = mid_y, xend = label_x, yend = label_y, color = cluster)
  ) +
  geom_text(
    data = ellipsoid_data,
    aes(x = label_x, y = label_y-0.2, label = filename, color = cluster),
    size = 5,
    hjust = 0.5
  ) +


  scale_color_manual(values = cluster_colors, name = "Cluster") +
  coord_cartesian(xlim = x_limits_expanded, ylim = y_limits_expanded) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  labs(x = "UMAP 1", y = "UMAP 2")


image_data <- data.frame(
  x = c(12.5, 5.5, 5.5, 9.5, 15.5),
  y = c(3, 1, 2.8, 3, 3),
  image = c(
    here("analysis", "paper", "figures", "ideal_box.png"),
    here("analysis", "paper", "figures", "ideal_cube.png"),
    here("analysis", "paper", "figures", "ideal_sphere.png"),
    here("analysis", "paper", "figures", "ideal_discoid.png"),
    here("analysis", "paper", "figures", "ideal_ellipsoid.png")
  )
)

p_umap_by_cluster_with_images <- p_umap_by_cluster + 
  geom_image(
    data = image_data,
    aes(x = x, y = y, image = image),
    size = 0.2
  )


cluster_summary <- umap_data_to_plot %>%
  select(filename, category_lower, cluster) %>%
  arrange(cluster, category_lower, filename)



ggsave(here("analysis/paper/figures/umap_by_cluster1.png"),
       plot = p_umap_by_cluster_with_images,
       width = 10, height = 6, dpi = 300)



```


@tbl-1 summarizes the basic information (rock type, blank type, final morphology, and cortex coverage) and morphological analysis results (classifications derived from SPHARM, values for sphericity and spherical harmonic energy) of the spheroids, subspheroids, polyhedrons and multifacial cores involved in the research.

Sphericity results reveals no significant difference between multifacial cores and polyhedrons(a Wilcoxon rank-sum test yielding W = `r U_multi_poly`, p = $`r p_multi_poly_sci`$). Accordingly, for subsequent analysis, we combined these two into a single group, which is then compared with the group of spheroids and subspheroids. A clear difference is shown between the group of spheroids and subspheroids and the group of polyhedrons and multifacial cores. The mean sphericity of spheroids (`r mean_sphericity_sub_spheroid`) is notably higher than that of polyhedrons and multifacial cores (`r mean_sphericity_poly_multi`), with a Wilcoxon rank-sum test yielding W = `r U_value`, p = $`r p_value_Mann_sci`$. This result indicates that spheroids possess a more spherical geometry overall, supporting their typological classification as a distinct type.



```{r}
#| label: fig-sp-summary
#| fig-cap: "A. Mean spherical harmonic power spectrum. B. Variance distribution by spherical harmonic degree. C. Distribution of SHE and sphericity by artefact type. D. Correlation of sphericity and spherical harmonic energy(r refers to the correlation coefficient; p refers to the p-value; n refers to the sample size)"
#| echo: false

# combine plots
library(cowplot)
p_panel_spharm <- 
plot_grid(p_power_spectrum, 
          p_variance_per_degreee,
          p_sphericity_and_she,
          p_corr_sphericity_she,
          labels = 'AUTO'
           )

ggsave(plot = p_panel_spharm,
       filename = here("analysis/paper/figures/panel_spharm_plots.png"),
       h = 8, 
       w = 9)

knitr::include_graphics(here("analysis/paper/figures/panel_spharm_plots.png"))

```

Subsequently, we computed the rotation-invariant power spectrum. Here we present the power spectrum of different groups, including the group of spheroids and spheroids, group of polyhedrons and multifacial cores, and the total of all these categories combined (@fig-sp-summary). The results show that the spheroids and subspheroids have significantly lower power than polyhedrons and multifacial cores at both low and high degrees (panel A @fig-sp-summary), indicating that spheroids and subspheroids possess a more symmetrical overall shape and more regular local features. In addition, the spheroid and subspheroid group exhibits smaller inter-group morphological variation than polyhedrons and multifacial cores, particularly at low degrees. Then we performed a Variance Analysis on the power of each harmonic degree. The results indicate that l=2 and l=3 exhibit the highest variance across the sample (panel B @fig-sp-summary), suggesting that these low-degrees capture the most significant shape variation. Specifically, l=2 reflects elongation or flattening, while l=3 reflects a sphere with octupole (pear-shaped) deformation exhibits a triaxial asymmetry that departs from both spherical and ellipsoidal symmetry.

The spherical harmonic energy (SHE) demonstrates significant negative correlation with classic sphericity index (r = `r round(correlation, 2)`, df = `r df_value`, p = $`r p_value_pearson_sci`$)), validating its efficacy as a proxy for how closely an object approximates a spherical form (panel D @fig-sp-summary). Statistical comparisons reveal distinct SHE distributions between groups: spheroids and spbspheroids exhibit a mean SHE of `r mean_SHE_sub_spheroid`, whereas multifacial cores and polyhedron demonstrate significantly higher irregularity (mean SHE = `r mean_SHE_poly_multi`) (panel C @fig-sp-summary). The Wilcoxon rank-sum test confirms robust inter-group divergence (W = `r U_value2`, p = $`r p_value_Mann_sci2`$), confirming the distinguishability of spheroid and subspheroid group from Qianshangying.

The pursuit of a standardized and distinct spherical form among spheroids and subspheroids is supported by Coefficient of Variation (CV). Both sphericity and SHE values yielded low CVs of under 1.7% (`r round(cv_sph_sub_spheroids, 3)` and `r round(cv_she_sub_spheroids, 3)`, respectively), indicating that group of spheroids and subspheroids maintain a highly standardized rounded shape (panel C @fig-sp-summary). In contrast, the group of multifacial cores and polyhedron has a higher CV of `r round(cv_sph_poly_multi, 3)` and `r round(cv_she_poly_multi, 3)` respectively.



```{r}
#| label: fig-UMAP-combined
#| fig-cap: "A. UMAP plot showing distinct clusters of shapes derived from SPHARM. B. UMAP plot of SPHARM-derived shape features colored by types. UMAP plot axes represent relative positions in a reduced-dimension morphospace and do not have a direct physical interpretation."
#| echo: false

library(magick)    
library(cowplot)

p_panel_spharm <- plot_grid(
  ggdraw() + draw_image(here("analysis/paper/figures/umap_by_cluster1.png")),
  ggdraw() + draw_image(here("analysis/paper/figures/p_umap_by_category1.png")),
  labels = "AUTO",
  ncol = 1
)

ggsave(
  plot = p_panel_spharm,
  filename = here("analysis/paper/figures/UMAP_combined.png"),
  width = 9,
  height = 10,
  dpi = 300
)

knitr::include_graphics(here("analysis/paper/figures/UMAP_combined.png"))

```

We then applied a Uniform Manifold Approximation and Projection (UMAP) to the rotation-invariant power spectrum, followed by K-means clustering to identify and characterize distinct morphological groups. The result reveals distinct clusters in the first two dimensions of the shape space. These clusters correspond to reference models of sphere, rounded cube, ellipsoid, rounded box and disc-like (@fig-UMAP-combined). This demonstrates that these flaked pieces occupy distinguishable regions in the shape space, with proximity to the sphere or elongation or flattening along specific axes emerging as key differentiating features. Most artifacts typologically classified as spheroids or subspheroids were grouped into the “sphere” and “rounded cube”, and few into "ellipsoid" and "box" clusters, indicating their consistent, near-spherical shapes (@fig-UMAP-combined).

However, a few Multifacial cores and Polyhedrons also appeared in the near-spherical region. This can be attributed to their high cortex coverage or limited flake removals, which likely preserved their originally rounded shapes and led to their grouping alongside spheroids. Some artifacts are identified as spheroids or subspheroids but grouped as ellipsoid or rounded box, because they exhibit a long axis. This reflects the use of different classification criteria in typological and quantitative approaches: typological assessments consider artifacts close to spherical, particularly when they exhibit large edge angles and rounded surfaces, whereas spherical harmonic analysis emphasizes aspects such as absolute symmetry.

The UMAP-based groupings correspond to significant differences in sphericity, as indicated by a Kruskal–Wallis test ($\chi^2$ = `r round(H_value, 2)`, df = `r df_kruskal`, p = $`r p_value_kruskal_sci`$). The result shows statistically significant differences in sphericity among the shape clusters, further supporting the effectiveness of the spherical harmonic approach in capturing meaningful morphological variation.

## Technological analysis

```{r, echo = FALSE}
get_coordinates <- function(filename) {
  temp_file <- readLines(filename, encoding = "UTF-8")  
  xyz1 <- data.frame(X1 = numeric(), Y1 = numeric(), Z1 = numeric())
  xyz2 <- data.frame(X2 = numeric(), Y2 = numeric(), Z2 = numeric())
  
  for (line in temp_file) {
    if (grepl("^\\s*start\\s*=", line)) {
      coordinates <- gsub(".*\\(([^()]*)\\).*", "\\1", line)
      coords <- as.numeric(strsplit(coordinates, ",")[[1]])
      xyz1 <- rbind(xyz1, data.frame(X1 = coords[1], Y1 = coords[2], Z1 = coords[3]))
    }
    if (grepl("^\\s*end\\s*=", line)) {
      coordinates <- gsub(".*\\(([^()]*)\\).*", "\\1", line)
      coords <- as.numeric(strsplit(coordinates, ",")[[1]])
      xyz2 <- rbind(xyz2, data.frame(X2 = coords[1], Y2 = coords[2], Z2 = coords[3]))
    }
  }


  # extract ID, type from file name
  xyz <- round(cbind(xyz1, xyz2), 5)
  filename_base <- basename(filename) 
  xyz$ID <- sub("_(.*)", "", filename_base)  
  xyz$type <- sub(".*_(.*)\\.txt", "\\1", filename_base)  
  
  # compute length from coordinates, normalization 
  xyz$length <- sqrt((xyz$X2 - xyz$X1)^2 + (xyz$Y2 - xyz$Y1)^2 + (xyz$Z2 - xyz$Z1)^2)
  xyz$length_scaled <- xyz$length / sum(xyz$length)

  xyz <- xyz %>%
    filter(complete.cases(.)) %>%
    distinct(.keep_all = TRUE)
  
  return(xyz)
}


folder_path <- here("analysis/data/raw_data/scar_orientation")
temp_file_list <- list.files(folder_path, pattern = "\\.txt$") 

std <- list()


for (i in seq_along(temp_file_list)) {
  filepath <- file.path(folder_path, temp_file_list[i])
  std[[i]] <- get_coordinates(filepath)
}

# run benn function and output data frame
benn.output <- as.data.frame(t(sapply(std, benn, min_sample = 0)))
benn.output$type <- sapply(std, function(x) if ("type" %in% names(x)) x$type[1] else NA)
benn.output$ID <- sapply(std, function(x) if ("ID" %in% names(x)) x$ID[1] else NA)
colnames(benn.output) <- c('Scar_count', 'E1', 'E2', 'E3', 'IS', 'EL', 'type', 'ID')


spheroids <- benn.output %>% filter(type %in% c("spheroid"))
elongation_min <- 
  round(min(spheroids$E1, spheroids$E2, spheroids$E3, na.rm = TRUE), 3)
elongation_max <- 
  round(max(spheroids$E1, spheroids$E2, spheroids$E3, na.rm = TRUE), 3)
isotropy_min <- 
  round(min(spheroids$IS, spheroids$EL, na.rm = TRUE), 3)
isotropy_max <- 
  round(max(spheroids$IS, spheroids$EL, na.rm = TRUE), 3)


write.csv(benn.output,
          here("analysis/data/derived_data/benn_output.csv"), row.names = FALSE)
```


```{r, echo=FALSE}
#| label: fig-spheroids-2797-1098
#| fig-cap: "Diacritical analysis of Qianshangying spheroids"

library(here)
knitr::include_graphics(here("analysis/paper/figures/spheroids_2797_1098.png"))

```

```{r, echo=FALSE}
#| label: fig-shaping-process
#| fig-cap: "Hypothetical spheroid shaping process at Qianshangying"

library(here)
knitr::include_graphics(here("analysis/paper/figures/shaping_process.png"))

```

Diacritical analysis of spheroid and subspheroid surfaces reveals a structured and recurrent reduction sequence comprising three phases (@fig-spheroids-2797-1098). Phase one was a unidirectional or bidirectional total exploitation, belonging to one kind of volume exploitation. Large and flat surfaces of the cobble were selected as platforms for striking toward the opposite surface. Knapping proceeded until the peripheral volume was fully exploited, resulting in an approximately cubic form. Phase two was peripheral centripetal exploitation. In this phase, previous removals in phase one serve as platforms for centripetal flaking around the core periphery. This represents a surface exploitation stage. A notable feature is the angle between the flaking surface and platform (i.e. core edge angle), which often exceeds 90°. This phase contributes significantly to the increasingly spherical shape of the artifact. Phase three was the production of small scars on ridges or intersections of previous flake scars, resulting in a rounding and smoother surface, further enhancing roundness.

At the Qianshangying site, all spheroids fall within Phase 3 of the reduction sequence, with one specimen appearing to have skipped Phase 2 and proceeded directly to edge refinement. In contrast, subspheroids display greater variability in their reduction sequences: Four specimens are assigned to Phase 3, of which two appear to have skipped Phase 2; one specimen falls within Phase 2, and one specimens within Phase 1 (see supplementary material files spheroids_metrics.xlsx). However, one subspheroid bypassed Phase 1 and instead employed a strategy of bifacial centripetal exploitation combined with edge refinement. Notably, in this case the angle between the two flaking surfaces approaches 90°, distinguishing this subspheroid from typical core of discoid. This suggests that the purpose of reduction was not the production of flakes, but rather the direct shaping of the artifact into its final spherical form. Also, it is important to note that due to the high degree of reduction intensity observed in some spheroids, phases prior to the visible sequence were often obliterated. We hypothesize the existence of a Phase zero, potentially involving roughing-out of the cobble or an earlier cycle of Phases one to three [@fig-shaping-process].


```{r, echo=FALSE}
#| label: fig-benn-ternary-plot
#| fig-cap: "Ternary plot showing flake scar orientation analysis"
library(dplyr)
library(ggtern)


n  = 11      
nv = 0.06    
pn = position_nudge_tern(y = nv, x = nv, z = -nv / 2)


benn.output <- benn.output %>%
  mutate(Z = 1 - EL - IS)

get_hull <- function(df) {
  if(nrow(df) < 3) return(df)  
  hull_idx <- chull(df$Z, df$IS)
  df[hull_idx, ]
}

hull_data <- benn.output %>%
  group_by(type) %>%
  do(get_hull(.)) %>%
  ungroup()

type_colors <- c(
  "multifacial" = "#b2abd2",
  "polyhedron" = "#5e3c99", 
  "subspheroid" = "#fdb863",
  "spheroid" = "#e66101"
)

fill_colors <- c(
  "multifacial" = "#b2abd2",
  "polyhedron" = "#5e3c99", 
  "subspheroid" = "#fdb863",
  "spheroid" = "#e66101"
)

# 绘图
p_benn_ternary <- ggtern(data = benn.output, aes(x = Z, y = IS, z = EL)) +

  geom_mask() +

  geom_polygon(
    data = hull_data,
    aes(fill = type, group = type),
    color = NA,
    alpha = 0.2
  ) +

  geom_polygon(
    data = hull_data,
    aes(color = type, group = type),
    fill = NA,
    size = 0.8,
    alpha = 0.8
  ) +

  geom_point(
    aes(color = type),
    size = 3,
    alpha = 0.8
  ) +

  theme_bw() +
  theme_showarrows() +
  theme_clockwise() +

  labs(
    x = "Planar",
    xarrow = "Planarity",
    y = "Isotropic", 
    yarrow = "Isotropy",
    z = "Linear",
    zarrow = "Elongation",
    color = "Type",
    fill = "Type"
  ) +
  
  scale_color_manual(
    values = type_colors,
    limits = names(type_colors)
  ) +
  
  # 填充颜色映射
  scale_fill_manual(
    values = fill_colors,
    limits = names(fill_colors)
  ) +

  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.key = element_rect(fill = "white")
  )


output_dir <- here("analysis", "paper", "figures")
if(!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

ggsave(
  filename = file.path(output_dir, "benn_ternary_plot.jpg"),
  plot = p_benn_ternary,
  width = 10,
  height = 6,
  dpi = 300,
  bg = "white"
)


knitr::include_graphics(file.path(output_dir, "benn_ternary_plot.jpg"))


```

Scar orientation analysis further supports the interpretation of a systematic reduction sequence in the production of Qianshangying spheroids and subspheroids. @fig-benn-ternary-plot shows that spheroids tend to cluster together, with elongation ratios ranging from `r elongation_min` to `r elongation_max` and isotropy ratios from `r isotropy_min` to `r isotropy_max`. These elongation ratios suggest that the spheroids underwent unidirectional or bidirectional total exploitation, typical of Phase one, resulting in relatively high elongation values. Then the peripheral centripetal exploitation, namely Phase two, appears to have contributed to a certain degree of isotropy in scar orientation, and higher isotropy ratios are associated with more spherical forms. Subspheroids exhibit greater variability in both elongation and isotropy ratios, reflecting less standardized reduction than spheroids. They remain more morphologically clustered than multifacial cores and polyhedrons, though this distinction is subtle.

Multifacial cores and polyhedrons display a wide and dispersed distribution in the ternary plot, without forming any distinctive cluster. Their scar patterns show considerable variability in both elongation and isotropy, reinforcing the interpretation that these cores lack removal organization. Multifacial cores typically exploit natural angles with core rotation occurring without a predetermined plan, which belongs to an opportunistic flaking strategy, while polyhedrons, despite showing a higher degree of reduction, follow a similarly unstructured sequence. This distinction highlights the fundamental technological difference between group of polyhedrons and multifacial cores and group of spheroids at Qianshangying. While they used to be considered as a continuous reduction process, our results show that in fact polyhedrons and multifacial cores represent exhausted cores, whereas spheroid group reflects the presence of a distinct conceptual template and systematic reduction plan.

## Shaping strategy efficiency

```{r tbl-2, echo=FALSE}

file_path <- here("analysis/data/derived_data/flaking_intensity_and_shape_spheroid.xlsx")
data_raw2 <- 
  read_excel(file_path) %>% 
  drop_na() %>% 
  mutate(across(where(is.numeric), \(x) round(x, 3)))

knitr::kable(data_raw2, caption = "Summary of spheroid shaping intensity and shape features. SDI = scar density index, SHE = spherical harmonic energy")

```

```{r, echo=FALSE}
#| label: fig-spearman-correlation-matrix
#| fig-cap: "Spearman correlation matrix of shape variables. Left: Spheroids and subspheroids. Right: Polyhedrons and multifacial cores. Circle indicates p < 0.1, with size representing correlation magnitude. Non-significant correlations (p ≥ 0.1) are shown without circles"


library(png)

file_path <- here("analysis/data/derived_data/flaking_intensity_and_shape_spheroid.xlsx")
data <- read_excel(file_path)
colnames(data) <- make.names(colnames(data))


selected_names <- c("Scar.number", "Removal.ratio", "SDI",
                    "Mean.edge.angle", "Curvature", "Sphericity", "SHE")
selected_cols <- data[, selected_names]


rcorr_result <- rcorr(as.matrix(selected_cols), type = "spearman")
cor_matrix <- rcorr_result$r
p_matrix   <- rcorr_result$P


var_order <- selected_names
cor_matrix <- cor_matrix[var_order, var_order]
p_matrix   <- p_matrix[var_order, var_order]


labels_long <- melt(cor_matrix)
labels_long$p <- melt(p_matrix)$value
colnames(labels_long) <- c("Var1", "Var2", "cor", "p")


labels_long$Var1 <- factor(labels_long$Var1, levels = rev(var_order)) 
labels_long$Var2 <- factor(labels_long$Var2, levels = var_order)     

labels_long$star <- ifelse(labels_long$p < 0.05 & labels_long$Var1 != labels_long$Var2, "*", "")
labels_long$cor_label <- sprintf("%.2f", labels_long$cor)

# scar number ~ Removal ratio
val1 <- labels_long[labels_long$Var1 == "Scar.number" & labels_long$Var2 == "Removal.ratio", ]
cor_scar_removal <- sprintf("%.2f", val1$cor)
p_scar_removal <- pretty_print_sci(val1$p)

# scar number ~ SDI
val2 <- labels_long[labels_long$Var1 == "Scar.number" & labels_long$Var2 == "SDI", ]
cor_scar_sdi <- sprintf("%.2f", val2$cor)
p_scar_sdi <- sprintf("%.3f", val2$p)

# removal ratio ~ SDI
val3 <- labels_long[labels_long$Var1 == "Removal.ratio" & labels_long$Var2 == "SDI", ]
cor_removal_sdi <- sprintf("%.2f", val3$cor)
p_removal_sdi <- sprintf("%.3f", val3$p)

# edge angle ~ sphericity
val4 <- labels_long[labels_long$Var1 == "Mean.edge.angle" & labels_long$Var2 == "Sphericity", ]
cor_angle_sph <- sprintf("%.2f", val4$cor)
p_angle_sph <- sprintf("%.3f", val4$p)

# edge angle ~ SHE
val5 <- labels_long[labels_long$Var1 == "Mean.edge.angle" & labels_long$Var2 == "SHE", ]
cor_angle_she <- sprintf("%.2f", val5$cor)
p_angle_she <- sprintf("%.3f", val5$p)

# curvature ~ Sphericity
val6 <- labels_long[labels_long$Var1 == "Curvature" & labels_long$Var2 == "Sphericity", ]
cor_cur_sph <- sprintf("%.2f", val6$cor)
p_cur_sph <- sprintf("%.3f", val6$p)

# Edge angle ~ Scar number
val_edge_scar <- labels_long[labels_long$Var1 == "Mean.edge.angle" & labels_long$Var2 == "Scar.number", ]
cor_edge_scar <- sprintf("%.2f", val_edge_scar$cor)
p_edge_scar <- sprintf("%.3f", val_edge_scar$p)

# Edge angle ~ Removal ratio
val_edge_removal <- labels_long[labels_long$Var1 == "Mean.edge.angle" & labels_long$Var2 == "Removal.ratio", ]
cor_edge_removal <- sprintf("%.2f", val_edge_removal$cor)
p_edge_removal <- sprintf("%.3f", val_edge_removal$p)

# SHE ~ Removal ratio
val_she_removal <- labels_long[labels_long$Var1 == "SHE" & labels_long$Var2 == "Removal.ratio", ]
cor_she_removal <- sprintf("%.2f", val_she_removal$cor)
p_she_removal <- sprintf("%.3f", val_she_removal$p)

# SHE ~ SDI
val_she_sdi <- labels_long[labels_long$Var1 == "SHE" & labels_long$Var2 == "SDI", ]
cor_she_sdi <- sprintf("%.2f", val_she_sdi$cor)
p_she_sdi <- sprintf("%.3f", val_she_sdi$p)

labels_long <- labels_long %>% 
  mutate(Var1_label = str_replace_all(Var1, "\\.", " "),
         Var2_label = str_replace_all(Var2, "\\.", " "))


var_order_label <- str_replace_all(var_order, "\\.", " ")
labels_long$Var1_label <- factor(labels_long$Var1_label, levels = rev(var_order_label))
labels_long$Var2_label <- factor(labels_long$Var2_label, levels = var_order_label)

p_combined <- plot_grid(
  ggdraw() + draw_image(here("analysis/paper/figures/spearman_correlation_matrix_spheroid.png")),
  ggdraw() + draw_image(here("analysis/paper/figures/spearman_correlation_matrix_core.png")),
  ncol = 2  
)

output_dir <- here("analysis", "paper", "figures")
if(!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

ggsave(
  plot = p_combined,
  filename = here("analysis/paper/figures/combined_spearman_correlation_matrices.png"),
  width = 12,
  height = 6,
  dpi = 300,
  bg = "white"
)

knitr::include_graphics(here("analysis/paper/figures/combined_spearman_correlation_matrices.png"))

```

```{r, include=FALSE, fig.show = "hide"}



file_path <- here("analysis/data/derived_data/flaking_intensity_and_shape_spheroid.xlsx")
data <- read_excel(file_path)
colnames(data) <- make.names(colnames(data))

selected_names <- c("Scar.number", "Removal.ratio", "SDI",
                    "Mean.edge.angle", "Curvature", "Sphericity", "SHE")
selected_cols <- data[, selected_names]

rcorr_result <- rcorr(as.matrix(selected_cols), type = "spearman")
cor_matrix <- rcorr_result$r
p_matrix   <- rcorr_result$P

var_order <- selected_names
cor_matrix <- cor_matrix[var_order, var_order]
p_matrix   <- p_matrix[var_order, var_order]

# 使用corrplot包绘制相关性矩阵
library(corrplot)

# 设置颜色渐变
my_colors <- colorRampPalette(c("#5e3c99", "white", "#e66101"))(100)


png(here("analysis/paper/figures/spearman_correlation_matrix.png"), 
    width = 8, height = 6, units = "in", res = 300)
corrplot(cor_matrix, 
         method = "circle",
         type = "upper",
         order = "original",
         tl.col = "black",
         tl.srt = 45,
         diag = FALSE,
         col = my_colors,
         addCoef.col = "black",
         number.cex = 0.7,
         p.mat = p_matrix,
         insig = "blank",
         sig.level = 0.1,
         mar = c(0, 0, 0, 0),
         cl.pos = "r")
dev.off()
```

``` {r, include=FALSE, fig.show = "hide"}



# 保存为PNG文件
png(here("analysis/paper/figures/removal_ratio_vs_SHE.png"), 
    width = 1000, height = 500, res = 150)

# 设置图形参数
par(mfrow = c(1, 2), mar = c(4, 4, 3, 1))

# 计算相关系数
pearson_cor <- cor(data$Removal.ratio, data$SHE, use = "complete.obs")
spearman_cor <- cor(data$Removal.ratio, data$SHE, method = "spearman", use = "complete.obs")

# 左边图：Pearson相关系数
plot(data$Removal.ratio, data$SHE,
     main = "Removal.ratio vs SHE (Pearson)",
     xlab = "Removal.ratio",
     ylab = "SHE",
     pch = 19,
     col = "blue",
     ylim = c(1.004, 1.021),
     xlim = c(0.6, 1.0),
     cex = 1.2)
abline(lm(SHE ~ Removal.ratio, data = data), col = "red", lwd = 2)
text(0.75, 1.018, paste("r =", round(pearson_cor, 4)), 
     cex = 0.9, col = "darkred")

# 右边图：Spearman相关系数（排序后）
sorted_data <- data[order(data$Removal.ratio), ]
plot(sorted_data$Removal.ratio, sorted_data$SHE,
     main = "Removal.ratio vs SHE (Spearman)",
     xlab = "Removal.ratio",
     ylab = "SHE",
     type = "o",
     pch = 19,
     col = "darkgreen",
     lwd = 2,
     ylim = c(1.004, 1.021),
     xlim = c(0.6, 1.0),
     cex = 1.2)
text(0.75, 1.018, paste("ρ =", round(spearman_cor, 4)), 
     cex = 0.9, col = "darkgreen")

# 关闭图形设备
dev.off()

```


```{r, include=FALSE, fig.show = "hide"}


file_path <- here("analysis/data/derived_data/flaking_intensity_and_shape_core.xlsx")
data <- read_excel(file_path)
colnames(data) <- make.names(colnames(data))

selected_names <- c("Scar.number", "Removal.ratio", "SDI",
                    "Mean.edge.angle", "Curvature", "Sphericity", "SHE")
selected_cols <- data[, selected_names]

rcorr_result <- rcorr(as.matrix(selected_cols), type = "spearman")
cor_matrix <- rcorr_result$r
p_matrix   <- rcorr_result$P

var_order <- selected_names
cor_matrix <- cor_matrix[var_order, var_order]
p_matrix   <- p_matrix[var_order, var_order]

# 使用corrplot包绘制相关性矩阵
library(corrplot)

# 设置颜色渐变
my_colors <- colorRampPalette(c("#5e3c99", "white", "#e66101"))(100)

# 创建corrplot图形
# 保存为PNG

png(here("analysis/paper/figures/spearman_correlation_matrix2.png"), 
    width = 8, height = 6, units = "in", res = 300)
corrplot(cor_matrix, 
         method = "circle",
         type = "upper",
         order = "original",
         tl.col = "black",
         tl.srt = 45,
         diag = FALSE,
         col = my_colors,
         addCoef.col = "black",
         number.cex = 0.7,
         p.mat = p_matrix,
         insig = "blank",
         sig.level = 0.1,
         mar = c(0, 0, 0, 0),
         cl.pos = "r")
dev.off()

```


For group of spheroids and subspheroids, we conducted shaping efficiency analysis.The same analysis was conducted on group of polyhedrons and multifacial cores as a comparison. @fig-spearman-correlation-matrix shows the results. Among reduction intensity descriptors, removal ratio and SDI incorporate surface area in their calculation, making them more effective in capturing the density and intensity of reduction, and therefore more comparable indicators of the reduction process compared to scar number.

Among the shape descriptors, we observed several significant correlations in the group of spheroids and subspheroids. Mean edge angle was positively correlated with sphericity (ρ = `r cor_angle_sph`, p = $`r p_angle_sph`$) and negatively correlated with Spherical Harmonics Power (SHE) (ρ = `r cor_angle_she`, p = $`r p_angle_she`$), indicating that greater edge angles are associated with more spherical and regular forms. Curvature was not significantly correlated with other variables, which may reflect its focus on local surface texture, while edge angle, sphericity and SHE capture broader aspects of shape regularity and symmetry. The weak correlation between sphericity and SHE may result from the small sample size or their different sensitivities: sphericity, based on area and volume, tolerates surface variation, while SHE responds more to asymmetry and shape irregularity. Thus, even in specimens with similar sphericity, surface differences can produce substantial variation in SHE. The analysis of spheroid shape variables indicates that mean edge angle, curvature, sphericity, and SHE each capture distinct aspects of spheroid morphology, which explains the varying strengths of correlation observed among them.

Significant correlations were found between removal ratio and mean edge angle in the group of spheroids and subspheroids. Mean edge angle was positively correlated with both scar number (ρ = `r cor_edge_scar`, p = $`r p_edge_scar`$) and removal ratio (ρ = `r cor_edge_removal`, p = $`r p_edge_removal`$). SHE showed a negative correlation trend with removal ratio (ρ = `r cor_she_removal`, $`r p_she_removal`$). Although this correlation did not reach the conventional significance threshold of $p < 0.05$, likely due to the small sample size, the relatively strong Pearson correlation suggests this negative relationship warrants attention. These results suggest that as reduction progresses, spheroids develop larger edge angles and lower SHE.

However, no significant correlations were observed between reduction intensity variables and sphericity or curvature. This implies that increased reduction does not necessarily produce smoother surfaces. Such patterns likely reflect the technological nature of the samples: the analyzed spheroids and subspheroids are "faceted" products of flake removal. Flaking increases surface complexity by adding edges and angular intersections, which may elevate curvature while also expanding surface area, factors that can distort sphericity values. 

In contrast, the polyhedron and multifacial cores group exhibits a distinct morphological trajectory: higher core reduction intensity correlated with lower sphericity and higher SHE values. This pattern suggests that sustained flaking activity in polyhedral cores leads to increasingly irregular forms that deviate from spherical geometry. This comparative analysis allows us to address our initial research question: spheroids do not represent a product of intensive flaking in the same manner as polyhedrons. 

# Discussion

## Do the Qianshangying spheroids represent a shaping strategy?

According to the results of technological analysis, we can summarize the technical strategy employed in the production of faceted spheroids and subspheroids from Qianshangying. This strategy consists of a series of sequential phases (@fig-shaping-process): a potential rough-out phase, volume exploitation aimed at forming a symmetrical cubic shape, surface exploitation to approximate a spherical geometry, edge refinement, and potentially the repetition of earlier phases. The existence of a repetitive phase is supported by the observation that while the original cobble blanks from Qianshangying display considerable size variation, the finished spheroids, although few of them are relatively large or small, mostly cluster around a diameter of 6–9 cm [@fig-basic-characteristics]. This suggests that the production of spheroids may have involved multiple cycles of reduction, and further implies that a diameter of 6–9 cm was considered an optimal or intended size in the knapping process.

The symmetrical and standardized shape of spheroids and subspehroids is observed in Qianshangying.The observed relationships between reduction intensity and shape descriptors support the interpretation that spheroid shaping was an efficient and purposeful process. The goal was to produce well-structured, globally spherical spheroids rather than smooth objects. By comparing group of spheroids and subspheroids and group of polyhedrons and multifacial cores, we can conclude that while spheroids must undergo significant reduction to achieve their near-spherical morphology, conversely, not all exhausted cores acquire spherical morphology.

Therefore, our results indicate that the Qianshangying hominins deliberately employed a standardized production approach to create spheroids with consistent and formalized shapes. The technological strategy reflected in the Qianshangying faceted spheroids and subspheroids includes the use of a conceptual template, standardized production, and the achievement of a target product, which together demonstrate that this was a shaping strategy. This stands in contrast to flaking strategies, where the primary objective is the removal of usable flakes rather than the shaping of a cobble into a predetermined morphology [@inizan1999; @duke2021].

These findings also contribute to the long-standing debate over the nature of spheroids--whether they should be interpreted as byproducts of flake production, or as targeted end products of shaping strategies. In the case of the Qianshangying faceted spheroids and subspherois, the evidence strongly supports the latter. Faceted spheroids recovered from other Early Pleistocene sites in Barranco Leon and ‘Ubeidiya have also been reported to show evidence consistent with shaping strategy [@Muller2023; @tittonSubspheroidsLithicAssemblage2020]. These intentionally shaped spheroids appear contemporaneous with, or even predate, the emergence of Acheulean technology, which is commonly considered the hallmark of the formalization of shaping strategies. 

It is important to note, however, that many spheroids from East Africa may not fall into this category. As noted by @mora2005, these quartz spheroids may have been produced through percussive techniques. They are often covered with battering marks, exhibit smoother surfaces and lack ridges, features that suggest they may be better classified as bolas within a typological framework [@leakey1971]. It may be more appropriate to describe these artifacts in technological terms, rather than relying on morphology-based typologies that can lead to confusion. For instance, referring to them as battering spheroids could help distinguish them from faceted spheroids.

Another question our results are relevant to is the relationship between polyhedrons, spheroids, and bolas. While no bolas were identified at Qianshangying, our quantitative analyses clearly differentiated polyhedrons from spheroids or subspheroids. These two artifact types differ in size, morphology, and production sequence. Polyhedrons at Qianshangying represent heavily reduced cores, whose edge angle increase results from extensive flake removal. Their primary purpose lies in producing flakes, placing them within a flaking strategy. In contrast, spheroids and subspheroids were intentionally shaped as end products, reflecting a shaping strategy. These two technological approaches of flaking and shaping strategies coexisted at Qianshangying, indicating a diversity of reduction goals.

However, we found that although the morphology and reduction technology of spheroid group and polyhedrons can be clearly distinguished, spheroids in early phases may be difficult to differentiate from cores. In their initial phases of reduction, spheroids often resemble cores due to similar flake removal patterns. At this stage, they may be classified as cores, especially since the flakes produced during the initial shaping are themselves usable. As @cabanès2022 mentioned, they could share a common operative chain before completing the final product. However, it remains unclear whether this typological transformation was intentional or unplanned.

## Qianshangying spheroids in the context of East Asia

::: {#fig-Spheroids-distribution-China}
```{r, echo=FALSE}

library(here)
knitr::include_graphics(here("analysis/paper/figures/Spheroids_distribution_China.png"))

```

Map of Paleolithic Sites with Spheroids in China and Their Associated Lithic Industries. 1. Mujiaqiao, [@Wei1984]; 2. Liaohe river region, [@Li1991]; 3. Deshan Second Brick factory, [@Xi1994]; 4. Zhangjiatan, [@LixianMuseum1992]; 5. Huzhua Mount., [@Tan1999]; 6. Fangniu Mount., [@Fang2002]; 7. Fanba, [@Xia2022Fanba]; 8. Xiaokongshan, [@XiaokongshanTeam1988]; 9. Hejialiang, [@Wang2014Hanzhong]; 10. Longgangsi, [@Lu2006Liangshan]; 11. Shangdan basin, [@Wang2013Danjiang]; 12. Yaoshi basin, [@Wang2000Yaoshi]; 13. Choushuihe, [@Dai1973Lantian]; 14. Kehe, [@Jia1962Kehe]; 15. Shuigou, [@Huang1964Sanmenxia]; 16. Hezhigou, [@Liu1984Jingchuan]; 17. Xigou, [@Jia1959Xigou]; 18. Dingcun, [@SXA2014Dingcun; @Tao1984Dingcun]; 19. Liujiacha, [@Xie1982Liujiacha]; 20. Dangcheng, [@Wu1989Dangcheng]; 21. Zhoukoudian Loc.1, [@NIGPAS1985PekingMan];22. Qianshangying, [@Ye2025Qianshangying]; 23. Xujiayao, [@Jia1976Xujayao; @Jia1979Xujayao; @Ma2011Xujayao; @Wang2016Houjiayao]); 24. Jinsitai, [@Wang2010Jinstai]
:::

In East Asia, spheroids constitute a technological category with broad temporal and spatial distribution [@Yi2012Spheroids], as shown in @fig-Spheroids-distribution-China (see the supplementary materials for a table of more information about these sites). In addition to the one spheroid collected near the Gongwangling site in Shanxi [@Dai1973Lantian], the earliest dated spheroids originate from Zhoukoudian Locality 1 (ZKD Loc.1) [@NIGPAS1985PekingMan], attributed to the early Middle Pleistocene, and not far from Qianshangying. In terms of geographic range, the southernmost and westernmost occurrences of spheroids are found at the Mujiaqiao site (MJQ) in Yunnan [@Wei1984], while the northernmost spheroids come from the Jinsitai site (JST) in Inner Mongolia [@Wang2010Jinstai]. The widespread occurrence of spheroids across time and space in East Asia may indicate their role as a generalized or multipurpose tool within Pleistocene contexts, capable of serving diverse functions in varying ecological and cultural settings.

Over 1522 spheroids have been identified across more than 23 archaeological sites or localities in East Asia However, many of these findings derive from surface surveys rather than systematic excavations, and the recovered quantities are often limited. Thus, the number of spheroids per site varies considerably: 19 sites have yielded fewer than ten specimens each. Qianshangying is typical with six spheroids and seven subspheroids. By contrast, three sites--Xujiayao (XJY), Dingcun (DC), and JST—-have produced substantial assemblages, each exceeding 100 spheroids [@Wang2016Houjiayao; @Wang2010Jinstai; @SXA2014Dingcun]. Notably, XJY alone has yielded over 1,000 specimens [@Wang2016Houjiayao].

The raw materials used for spheroids at these archaeological sites primarily include quartz, quartzite, sandstone, and limestone, with occasional occurrences of lava and dolomite at a few localities, such as Qianshangying. Among these, quartz and quartzite are the most widely used materials, found at 18 sites across China. In contrast, spheroids made of sandstone and limestone are mainly concentrated at sites distributed along the Fen River and Li River basins in Central China. Previous researches have observed that the morphological characteristics of spheroids are influenced by the physical properties of the raw materials [@Tao1984Dingcun]. For example, at the DC site, spheroids made from quartz tend to be irregular and angular, possibly due to the fragile nature of quartz. In comparison, those made from softer materials such as limestone and sandstone are generally more rounded and smoother, with flake scars that appear more diffuse or less distinct [@Tao1984Dingcun].

Three primary techniques have been identified in the manufacture of spheroids in China: flaking, involving the removal of flakes to shape the object (e.g., Qianshangying, MJQ, [@Wei1984]); pecking, where two blanks are struck together to round off edges, sometimes by splitting a cobble and using the halves against each other (e.g., DC, [@SXA2014Dingcun]); and battering, involving repeated percussion of a polyhedrons (e.g., ZKD Loc.1, [@NIGPAS1985PekingMan]). Experimental studies suggest that pecking and battering yield similar efficiency and spherical form [@Lu2021Spheroids]. Many sites, such as XJY and DC, show evidence of multiple techniques, including combined or sequential methods like pecking after flaking to improve roundness [@Tao1984Dingcun; @NIGPAS1985PekingMan]. No clear relationship has yet been established between raw material types and specific production methods.

We found six sites exhibiting similar strategies to Qianshangying. For example, at DC and MJQ, thick and flat cobbles were selected and shaped through peripheral flaking, producing roughly approximately cubic shape [@Wei1984; @Tao1984Dingcun]. MJQ specimens retain parts of the cortex, while at DC, flakes with large exterior and small interior platform angles were removed from blanks to increase edge angles and enhance roundness [@Tao1984Dingcun; @Wei1984]. Among the six sites, all but MJQ are located within the Fen River and Lishui River regions. These sites were grouped into the Keheng–Dingcun techno-complexes and Lishui techno-complexes, characterized by trihedral picks [@LixianMuseum1992; @Tan1999; @Fang2002; @SXA2014Dingcun; @Jia1962Kehe]. The trihedral picks were produced by striking the dorsal surfaces of large flakes to concentrate edges at the tip, resulting in triangular outlines and robust pointed ends, classifying them as large cutting tools (LCTs)[@kuman2014large; @li2018currently; @yang2016late]. This is a significant observation, as it implies that spheroid production techniques similar to those at Qianshangying are more frequently associated with lithic assemblages characterized by intentional shaping strategies.

It should be emphasized, however, that we do not intend to imply a direct association between faceted spheroids and Acheulean technology. We infer that faceted spheroids in China appear to represent a shaping tradition that shares the same crucial technological competencies as LCTs [@leakey1971; @Cabanes2024; @Isaac1986], and this could explain why they often occur in Acheulean techno-complex. We now find that faceted spheroids and subspheroids occur at Qianshangying within the context of a small flake tool industry. This industry, based on a core and flake technology, has been attributed to Mode 1 in north China. The presence of faceted spheroids, however, suggests that this technocomplex was more complex and exhibited greater variability than previously thought.

Similarly, we may need to reconsider the technological complexity implied by faceted spheroids. Faceted spheroids appear in what is considered the Late Oldowan, if a chronological boundary is set at 2.0 Ma to distinguish between Early and Late Oldowan [@gallotti2018emergence]. The growing recognition of technological diversity within the Oldowan has led to a broader consensus that the Late Oldowan includes signs of innovation, such as more complex flaking patterns and decreased morphological variability in flakes [@braun2019; @gallotti2018emergence]. Faceted spheroids, we propose here, may represent one of the key indicators of this increasing technological complexity during the Late Oldowan [@tittonSubspheroidsLithicAssemblage2020].

# Conclusion

Quantitative approaches to studying spheroids remain limited [@Muller2023; @deweyer2017; @tittonSubspheroidsLithicAssemblage2020]. We propose a complete, efficient, reproducible and transparent methodological framework here based on spherical harmonics to quantitatively assess morphological variation among flaked pieces, allowing for the distinction between cores and spheroids and evaluating the degree of morphological standardization in spheroids. Past approaches to analyzing the morphology of flaked pieces have been limited, with geometric morphometrics being the most recent major method innovation [@hallinan2025; @cao2025; @lycett2013]. However, this method has significant constraints, including the requirement for homologous landmarks, which limits its applicability to artifacts like cores of various shapes and spheroids. Spherical harmonics offer a viable alternative, showing strong potential for precision and interpretability. We can reasonably expect broader applications of this method across a wide range of archaeological artifacts in the future.

In principle, any closed three-dimensional object can be analyzed using spherical harmonics. In archaeology, materials such as spheroids or cores, ceramic vessels, plant seeds, and animal crania are particularly well suited to this approach, as their overall forms approximate spheres or ellipsoids, making them readily mappable onto the unit sphere for spherical harmonic expansion. Low-order expansions efficiently capture their primary morphological features, while the combination of low-order and high-order coefficients allows for a distinction between overall shape (e.g., symmetry, inflation, elongation) and local details (e.g., decorations, ridges, protrusions). Moreover, these objects generally do not emphasize orientation, enabling the use of rotationally invariant spherical harmonic power spectra to quantify shape variation. For objects with weaker symmetry or greater surface complexity, however, higher-order expansions are required, increasing computational cost and complicating the interpretation of coefficients. As a tool for morphological research, spherical harmonics are particularly effective in addressing issues of shape symmetry and standardization [@Muller2023; @Grieb2022]. Moreover, owing to the high precision of spherical harmonic decomposition, they offer significant advantages in investigating morphological variation and evolution both within and between groups [@Medyukhina2020; @Link2024; @Noshita2025].

By applying a range of quantitative methods, we conducted an integrated morphological and technological study of the Qianshangying spheroids. Our results demonstrate that these spheroids were produced through a programmed reduction strategy aimed at achieving standardized spherical forms, primarily using hard-hammer direct percussion. The evidence of shaping strategies on Qianshangying spheroids even subspheroids confirms that they were intentionally made tools with conceptual template, rather than exhausted cores. This distinguishes them from polyhedrons or multifacial cores in their terminal reduction stages. Traditionally, lithic technology in northern China prior to the Late Pleistocene has been considered stagnant and generally classified as simple core and flake industry. However, the Qianshangying assemblage from \~429ka clearly reveals a higher level of technological complexity.

This paper also presents one of the first systematic overviews of the spatial and temporal distribution and technological variability of spheroids within East Asia. We found that East Asian spheroids display considerable diversity in raw materials, production techniques, and morphology. Some assemblages contain spheroids that may be comparable to those from Qianshangying and tend to appear within Acheulean or shaping-oriented techno-complexes, often dated later than Qianshangying. This highlights the particular significance of the Qianshangying spheroids and subspheroids. However, the current dataset remains limited, and many sites lack detailed morphological and technological studies of spheroids, hampering broader inferences about hominin technological behaviors. We therefore emphasize the need for site-specific analysis of spheroids in future research.

Given the limitations of traditional typology in capturing the functional, morphological, and technological variability of spheroids across sites, we argue that multiple method approaches are essential. From the perspective of typology, spheroids have often been dismissed as poor marker of hominin behavior due to their wide spatial and temporal distribution. However, more recent studies increasingly reveal their diversity and potential as markers of hominin technological behavior [@tittonSubspheroidsLithicAssemblage2020; @vaquero2018; @deweyer2017; @Cabanes2024]. For example, distinctions between flaking-based and battering-based spheroids, along with patterns of raw material selection, production goals, and associations with specific subsistence strategies or environmental adaptations, may prove meaningful and need further explore[@Cabanes2024]. Beyond the methods of morphological and technological analysis used here, future studies incorporating functional analysis and experimental replication will also enhance our understanding of spheroid manufacture, a specific production activity.


# CRediT authorship contribution statement

Ye Zhi: Writing – review & editing, Writing – original draft, Visualization, Resources, Project administration, Methodology, Investigation, Funding acquisition, Formal analysis, Data curation, Conceptualization. Shuwen Pei: Writing – review & editing, Supervision, Conceptualization, Funding acquisition. Dongdong Ma: Formal analysis, Data curation. Hao Li: Writing – review & editing, Conceptualization. Ben Marwick: Writing – original draft, review & editing, Supervision, Project administration, Methodology, Conceptualization.

# Data availability statement

The 3d models from QSY site used in this study are openly available at https://doi.org/10.17605/OSF.IO/CTNE9

# Funding

This work was financially supported through the National Natural Foundation of China (Grant No. 42371165), and China Scholarship Council Programme for international student (CSC No. 202404910542)

# Declaration of competing interest

The authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper.

# Acknowledgements

Thanks to Christine Harper for kindly sharing her expertise on SPHARM analyses.

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```


