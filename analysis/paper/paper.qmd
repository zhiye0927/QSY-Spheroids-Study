---
title: "Spherical harmonic analysis of faceted spheroids identifies shaping strategies and standardisation at Qianshangying (North China)"
author:
  - Yi Zhe:
      correspondence: "yes"
      email: yezhi@ivpp.ac.cn
      orcid: 
      institute:
        - ivpp
  - Ben Marwick:
      correspondence: "no"
      email: bmarwick@uw.edu
      orcid: 0000-0001-7879-4531
      institute:
        - uw
  - Li Hao:
      correspondence: "no"
      orcid: 
      institute:
        - ivpp
  - Shuwen Pei:
      correspondence: "no"
      orcid: 
      institute:
        - ivpp
institute:
  - uw: Department of Anthropology, University of Washington, Seattle, USA
  - ivpp: Institute of Vertebrate Palaeontology and Paleoanthropology, Chinese Academy of Science, Beijing, China
title-block-published: "Last updated"  
date: now
date-format: long
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
execute:
  echo: true
  warning: false
  message: false
  comment: "#>"
  fig-dpi: 600
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
editor_options: 
  chunk_output_type: console
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The actual document text starts here: -->

```{r setup, include=FALSE}

library(data.table)
library(NISTunits)
library(circular)
library(ggpubr)
library(ggalt)
library(ggplot2)
library(stringr)
library(ggtern)
library(dplyr)
library(here)
library(tidyverse)
source(here('analysis/paper/scripts/McPherron_2018.r'))
source(here('analysis/paper/scripts/get_coordinates.r'))
source(here('analysis/paper/scripts/vector_stats.r'))
```

# Introduction

Spheroids are a widely distributed type of stone artifact, appearing across a broad temporal and geographic range, from the Oldowan and Acheulean to the Middle Paleolithic, and in diverse archaeological assemblages.[@willoughby1985; @Cabanes2024]. Early descriptions of spheroids were provided by @clark1955 and @kleindienst1962, and @leakey1971 later formally introduced the term spheroid, alongside polyhedron and bola, in his classification of the Developed Oldowan. Leakey’s definition of spheroids remains a widely cited typological standard: spheroids are rounded lithic objects whose entire surface is covered with flake scars, while subspheroids are generally less symmetrical and may retain portions of the original cortex. Compared to spheroids, polyhedrons are characterized by multiple intersecting flake removals, producing a distinctly angular morphology; bolas exhibit smoother and more rounded surfaces with no visible crests [@leakey1971; @tittonSubspheroidsLithicAssemblage2020; @deweyer2017].

Although these artifact types are frequently grouped under the category “PSB” of Polyhedron, Spheroid and Bolas (or “PSSB” when subspheroids are included) and are commonly interpreted as volumetrically reduced artifacts organized around a central point, this morphology-based classification has led to several challenges. Artifacts identified as spheroids in one study may be classified as bolas or attributed to entirely different technological categories in another, due to differences in observers’ experience and interpretive criteria. Furthermore, research has shown that these forms may not represent a unified *chaîne opératoire*: differences in raw material selection suggest divergent technological strategies and potentially distinct functional purposes [@deweyer2017; @jones1994].Therefore, it is unreasonable to treat them as a coherent group.

At present, the technological category and function of spheroids remain central topics of debate. Broadly, spheroids have been interpreted as hammerstones [@mussi2025; @schick1994], cores [@sahnouni1997], or projectiles [@leakey1979]. Closely tied to this debate is the question of their production strategy, which remains unclear. Experimental replication and site-specific diacritical analyses have produced divergent interpretations. One view suggests that spheroids emerged unintentionally as the by-products of core exhaustion, which represents a low-effort strategy aimed at flake production [@sahnouni1997]. Another perspective holds that spheroids were unconsciously produced through high-intensity battering [@schick1994; @mora2005; @clark1955]. In contrast, a third view proposes that spheroids reflect a conceptual template and were produced through a deliberate shaping strategy [@tittonSubspheroidsLithicAssemblage2020; @Muller2023; @texier2014].

At present, the debate remains stalled, primarily due to the lack of clear typological criteria for distinguishing spheroids intentionally shaped according to conceptual templates from those that emerged as by-products of flaking or percussive activities. Thus, regional studies continue to rely heavily on individual researchers’ observational judgment and experiential knowledge. Furthermore, current typological approaches offer limited capacity for cross-regional comparison, making it difficult for researchers to verify interpretations derived from other sites. At the same time, conclusions drawn from their own analyses are rarely subject to external validation or replication.

To address these challenges, we developed a set of quantitative methods combining morphological and technological analyses to investigate spheroid production strategies. While previous morphlogical measures have focused on the shape of spheroids close to perfect sphere, contributing to discussions of spheroid standardization, they cannot reliably reflect production strategies, as highly spherical forms may result from diverse production goals. We therefore adopted the novel spherical harmonics, a landmark-free method recently introduced to archaeology, which offers morphometric precision comparable to geometric morphometrics but does not rely on predefined landmarks, making it particularly suitable for artifacts like spheroids that lack homologous landmarks. We have creatively modified the spherical harmonics method to distinguish the morphological variability of flaked pieces, enabling us to differentiate between spheroids and multifacial cores or polyhedrons—this is the first attempt of its kind in the field of archaeology. Additional technological analyses, including flake scar orientation analysis and reduction index calculation, further contribute to reconstructing the spheroid production strategies. All of these methods are open-source to enable replication and support a unified quantitative research framework.

These methods were applied to a case study of spheroids recovered from the previously excavated site of Qianshangying of Northern China. In the following part, we assessed whether the Qianshangying spheroids exhibit a patterned production process and standardized morphology, and whether their tendency toward spherical forms resulted from deliberate and systematic reduction processes distinct from the multifacial cores and polyhedrons within the assemblage. This study provides insights into the production strategy of spheroids at the site. At the same time, we situated the Middle Pleistocene Qianshangying site within the broader context of China to explore the technological behaviors and cultural traditions associated with spheroid production, also providing one of the earliest contributions to understanding the spatial and temporal distribution of spheroids in China. More importantly, we offer a practical and integrated framework combining morphological and technological analyses, enabling comparative studies of spheroid production strategies across regions and archaeological sites.

## Spheroids in East Asia

```{r tbl-3, echo=FALSE}

file_path <- here("analysis/data/derived_data/spheroids_sites_China.xlsx")
data3 <- readxl::read_excel(file_path)

knitr::kable(data3, caption = "Summary of core typology and morphological parameters.")

```


::: {#fig-Spheroids-distribution-China}


```{r, echo=FALSE}

library(here)
knitr::include_graphics(here("analysis/paper/figures/Spheroids_distribution_China.png"))

```

Map of Paleolithic Sites with Spheroids in China and Their Associated Lithic Industries.  1. Mujiaqiao, [@Wei1984]; 2. Liaohe river region, [@Li1991]; 3. Deshan Second Brick factory, [@Xi1994]; 4. Zhangjiatan, [@LixianMuseum1992]; 5. Huzhua Mount., [@Tan1999]; 6. Fangniu Mount., [@Fang2002]; 7. Fanba, [@Xia2022Fanba]; 8. Xiaokongshan, [@XiaokongshanTeam1988]; 9. Hejialiang, [@Wang2014Hanzhong]; 10. Longgangsi, [@Lu2006Liangshan]; 11. Shangdan basin, [@Wang2013Danjiang]; 12. Yaoshi basin, [@Wang2000Yaoshi]; 13. Choushuihe, [@Dai1973Lantian]; 14. Kehe, [@Jia1962Kehe]; 15. Shuigou, [@Huang1964Sanmenxia]; 16. Hezhigou, [@Liu1984Jingchuan]; 17. Xigou, [@Jia1959Xigou]; 18. Dingcun, [@SXA2014Dingcun; @Tao1984Dingcun]; 19. Liujiacha, [@Xie1982Liujiacha]; 20. Dangcheng, [@Wu1989Dangcheng] ; 21. Zhoukoudian Loc.1, [@NIGPAS1985PekingMan]; 22. Xujiayao, [@Jia1976Xujayao; @Jia1979Xujayao; @Ma2011Xujayao; @Wang2016Houjiayao]); 23. Jinsitai, [@Wang2010Jinstai]

:::

In East Asia, spheroids constitute a technological category with broad temporal and spatial distribution [@Yi2012Spheroids], as shown in @fig-Spheroids-distribution-China. In addition to the one spheroid collected near the Gongwangling site in Shanxi [@Dai1973Lantian], the earliest dated spheroids originate from Zhoukoudian Locality 1 (ZKD Loc.1) [@NIGPAS1985PekingMan], attributed to the early Middle Pleistocene. In terms of geographic range, the southernmost and westernmost occurrences of spheroids are found at the Mujiaqiao site (MJQ) in Yunnan [@Wei1984], while the northernmost spheroids come from the Jinsitai site (JST) in Inner Mongolia [@Wang2010Jinstai]. The widespread occurrence of spheroids across time and space in East Asia may indicate their role as a generalized or multipurpose tool within Pleistocene contexts, capable of serving diverse functions in varying ecological and cultural settings.

Over 1522 spheroids have been identified across more than 23 archaeological sites or localities in East Asia However, many of these findings derive from surface surveys rather than systematic excavations, and the recovered quantities are often limited. Thus, the number of spheroids per site varies considerably: 19 sites have yielded fewer than ten specimens each. By contrast, three sites—Xujiayao (XJY), Dingcun (DC), and JST—have produced substantial assemblages, each exceeding 100 spheroids [@Wang2016Houjiayao; @Wang2010Jinstai; @SXA2014Dingcun]. Notably, the XJY alone has yielded over 1,000 specimens [@Wang2016Houjiayao].

The raw materials used for spheroids at these archaeological sites primarily include quartz, quartzite, sandstone, and limestone, with occasional occurrences of lava and dolomite at a few localities. Among these, quartz and quartzite are the most widely used materials, found at 18 sites across China. In contrast, spheroids made of sandstone and limestone are mainly concentrated at sites distributed along the Fen River and Li River basins in Central China. Previous researches have observed that the morphological characteristics of spheroids are influenced by the physical properties of the raw materials [@Tao1984Dingcun]. For example, at the DC site, spheroids made from quartz tend to be irregular and angular, possibly due to the fragile nature of quartz. In comparison, those made from softer materials such as limestone and sandstone are generally more rounded and smoother, with flake scars that appear more diffuse or less distinct [@Tao1984Dingcun].

Three primary techniques have been identified in the manufacture of spheroids: flaking, involving the removal of flakes to shape the object (e.g., MJQ, [@Wei1984]); pecking, where two blanks are struck together to round off edges, sometimes by splitting a cobble and using the halves against each other (e.g., DC, [@SXA2014Dingcun]); and battering, involving repeated percussion of a polyhedrons (e.g., ZKD Loc.1, [@NIGPAS1985PekingMan]). Experimental studies suggest that pecking and battering yield similar efficiency and spheroid form [@Lu2021Spheroids]. Many sites, such as XJY and DC, show evidence of multiple techniques, including combined or sequential methods like pecking after flaking to improve sphericity [@Tao1984Dingcun; @NIGPAS1985PekingMan]. No clear relationship has yet been established between raw material types and specific production methods.

At DC and MJQ, thick, flat cobbles were selected and shaped through peripheral flaking, producing roughly approximately cubic shape [@Wei1984; @Tao1984Dingcun]. MJQ specimens retain parts of the cortex, while at DC, flakes with large exterior and small interior platform angles were removed from blanks to increase edge angles and enhance sphericity [@Tao1984Dingcun; @Wei1984]. Of the six sites exhibiting similar strategies to QSY spehroids, all but MJQ are located within the Fen River and Lishui River regions. These sites are grouped into the Keheng–Dingcun techno-complexes and Lishui techno-complexes, characterized by large flakes and large triangular points [@LixianMuseum1992; @Tan1999; @Fang2002; @SXA2014Dingcun; @Jia1962Kehe]. The large triangular points were produced by striking the dorsal surface of large flakes to concentrate edges at the tip, creating triangular outlines and steep cross-sections—indicative of a deliberate shaping strategy. This is a significant observation, as it implies that spheroid production techniques similar to those at QSY are more frequently associated with lithic assemblages characterized by intentional shaping strategies.

From the perspective of lithic industries represented at spheroid-bearing sites, faceted spheroids are found in both core and flake industry and Middle Paleolithic sites. However, they occur most frequently in Acheulean industries and in traditions of large flake and large triangular point [@Wang2014Hanzhong; @Lu2006Liangshan; @Wang2013Danjiang; @Wang2000Yaoshi], both of which are marked by deliberate shaping strategies (@fig-Spheroids-distribution-China). Notably, even sites previously classified as belonging to simple core and flake industries or Mode 1, such as XJY, demonstrate technological capacities that surpass the typical expectations of Mode 1 [@Wang2016Houjiayao].

It should be emphasized, however, that we do not intend to imply a direct association between faceted spheroids and Mode 2 or the Acheulean technology. Rather, what we infer is that faceted spheroids in China appear to represent a shaping tradition that shares the same core technological competencies as LCTs [@leakey1971; @Cabanes2024; @isaac1986foundation], so they often occur alongside one another. If faceted spheroids first emerged within the small flake tool industries in northern China, commonly considered a simple core and flake technology, then this would suggest that shaping techniques may have originated in an even earlier technological context.

This pattern aligns with spheroid findings in other regions of the world. Early examples of spheroids have been identified in various lithic assemblages across Africa, Europe, the Levant, and Asia, where the associated techno-complexes are generally attributed to either the Acheulean or the Oldowan. Spheroids appear in what is considered the Late Oldowan, if a chronological boundary is set at 2.0 Ma to distinguish between Early and Late Oldowan [@gallotti2018emergence]. The growing recognition of technological diversity within the Oldowan has led to a broader consensus that the Late Oldowan includes signs of innovation, such as more complex flaking patterns and decreased morphological variability in flakes [@gallotti2018emergence; @braun2019]. Spheroids, we propose here, may represent one of the key indicators of this increasing technological complexity during the Late Oldowan [@tittonSubspheroidsLithicAssemblage2020]. In particular, faceted spheroids, which we hypothesize represent a deliberate shaping strategy, may indicate a level of technical skill approaching that of the earliest Acheulean, or perhaps even foreshadowing their emergence.

# Qianshangying and its spheroids

```{r, echo=FALSE}
#| label: fig-QSY-geography-chronology
#| fig-cap: "Geological Context and Chrono-Stratigraphy of the QSY Site)"

knitr::include_graphics(here("analysis/paper/figures/QSY_geography_chronology.png"))

```

Qianshangying lies in the Nihewan Basin, a region in northern China situated between the Chinese Loess Plateau and the Inner Mongolian Plateau. The basin preserves extensive Quaternary fluvio-lacustrine and loess deposits [@li2000; @yuan2009], hosts the highest concentrations of Pleistocene Paleolithic sites in East Asia, and is especially significant for preserving evidence of early hominin activities outside Africa dating back over one million years [@yang2020; @yang2017; @pei2019; @pei2017; @zhu2001; @zhu2004]. In recent years, nearly 20 Middle Pleistocene sites—including Jijiazhuang and Caijiagou—have been identified in the southeastern part of the basin [@yuwei2023; @ye2024], within the Yuxian Sub-basin, resulting in a long and detailed regional cultural sequence for the Nihewan Basin (@fig-QSY-geography-chronology).

```{r, echo=FALSE}

df <- tibble(
  material = c("Lava", "Dolomite", "Chert", "Other"),
  spheroids = c(9, 2, 0, 1),
  cores = c(62, 21, 4, 7),
  Polys_and_Multi_cores = c(26, 6, 3, 2),
  total = c(637, 209, 53, 56),
)

df_long <- df %>%
  pivot_longer(cols = -material, names_to = "category", values_to = "count") %>%
  group_by(category) %>%
  mutate(prop = count / sum(count) * 100) %>%
  ungroup() %>%
  mutate(
    category = factor(category, 
                      levels = c("spheroids","Polys_and_Multi_cores", "cores", "total")),
    material = factor(material, 
                      levels = c("Lava", "Dolomite", "Chert", "Other"))
  )

p_raw_material <- 
ggplot(df_long %>% 
         mutate(category = case_when(
           category == "cores" ~ "Cores",
           category == "spheroids" ~ "Spheroid",
           category == "total" ~ "Total",
           category == "Polys_and_Multi_cores" ~ "Polys and Multi cores"
           )) %>% 
         filter(category != "Total"), 
       aes(x = material, 
           y = prop, 
           fill = category)) +
  geom_col(position = position_dodge(width = 0.6), width = 0.5) +
  labs(
    x = "",
    y = "Percentage (%)",
    fill = "Technological Type"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    scale_fill_manual(values = c(
    "Spheroid" = "orange", 
    "Polys and Multi cores" = "#66c2a5",
    "Cores" = "lightgray"
  )) +
  theme_minimal(base_size = 8) +
  theme(
    legend.position = c(0.80, 0.95),              
    legend.justification = c("right", "top"),      
    legend.background = element_rect(fill = alpha("white", 0.6), color = NA),  
    legend.box.background = element_rect(color = "black")  
  )

#citation
df_long <- df_long %>%
  mutate(text = paste0("n = ", count, ", ", round(prop, 1), "%"))
#print(df_long)
lava_total_text <- df_long %>% filter(material == "Lava", category == "total") %>% pull(text)
dolomite_total_text <- df_long %>% filter(material == "Dolomite", category == "total") %>% pull(text)
chert_total_text <- df_long %>% filter(material == "Chert", category == "total") %>% pull(text)
other_total_text <- df_long %>% filter(material == "Other", category == "total") %>% pull(text)

lava_spheroids_text <- df_long %>% filter(material == "Lava", category == "spheroids") %>% pull(text)
dolomite_spheroids_text <- df_long %>% filter(material == "Dolomite", category == "spheroids") %>% pull(text)
chert_spheroids_text <- df_long %>% filter(material == "Chert", category == "spheroids") %>% pull(text)
other_spheroids_text <- df_long %>% filter(material == "Other", category == "spheroids") %>% pull(text)

lava_multi_text <- df_long %>% filter(material == "Lava", category == "Polys_and_Multi_cores") %>% pull(text)
dolomite_multi_text <- df_long %>% filter(material == "Dolomite", category == "Polys_and_Multi_cores") %>% pull(text)
chert_multi_text <- df_long %>% filter(material == "Chert", category == "Polys_and_Multi_cores") %>% pull(text)
other_multi_text <- df_long %>% filter(material == "Other", category == "Polys_and_Multi_cores") %>% pull(text)
```

The Qianshangying site complex consists of four localities from QSY-A to QSY-D, discovered in 2015. It is among the region’s most artifact-rich archaeological site. Geomorphological and sedimentological evidence indicates that the stratigraphy at the site records a full cycle of lake expansion, retreat, re-expansion, and eventually disappearance of the ancient Nihewan lake, and hominin occupation occurred in a marginal lacustrine setting during a low lake-level episode <!-- BM: citation needed -->. The stratigraphic context of Qianshangying indicates a short-term occupation resulting from a single hominin activity event. Analyses of artefact orientations and size distributions indicates that the assemblage appears to be largely *in situ*, exhibiting minimal disturbance after deposition <!-- BM: cite your excavation report, unpublished report -->. ESR dating of the cultural layer places hominin activity at approximately 429 ± 39 ka <!-- BM: cite your excavation report, unpublished report -->.

A total of 955 stone artifacts were recovered from four localities at Qianshangying. Following a widely used techno-typological framework [@Isaac1981; @Isaac1986; @delatorre2004; @de2018oldowan; @pei2017], the assemblage was classified into four general categories: flaked pieces (n = 247, 26.0%), detached pieces (n = 686, 71.8%), pounded pieces (n = 4, 0.4%), and unmodified materials (n = 17, 1.8%). Among these, 12 spheroids and subspheroids were identified, accounting for 1.3% of the total lithic assemblage.

Raw materials at Qianshangying were classified into four categories following @pei2002 and @pei2017: lava, siliceous dolomite, chert, and others. The overall assemblage is dominated by lava ( `r lava_total_text` ), followed by siliceous dolomite ( `r dolomite_total_text` ), with smaller proportions of chert ( `r chert_total_text` ) and other materials ( `r other_total_text` ). The composition of cores closely mirrors this distribution, comprising `r round(df_long$prop[df_long$material == "Lava" & df_long$category == "cores"],1)`% lava (n = `r df_long$count[df_long$material == "Lava" & df_long$category == "cores"]`), `r round(df_long$prop[df_long$material == "Dolomite" & df_long$category == "cores"],1)`% siliceous dolomite (n = `r df_long$count[df_long$material == "Dolomite" & df_long$category == "cores"]`), `r round(df_long$prop[df_long$material == "Chert" & df_long$category == "cores"],1)`% chert (n = `r df_long$count[df_long$material == "Chert" & df_long$category == "cores"]`), and `r round(df_long$prop[df_long$material == "Other" & df_long$category == "cores"],1)`% other (n = `r df_long$count[df_long$material == "Other" & df_long$category == "cores"]`). For polyhedrons and multifacial cores, a preference of chert ( `r chert_multi_text` ) and lava ( `r lava_multi_text` ) was shown. In contrast, spheroids exhibit a marked preference for lava (`r lava_spheroids_text`), with reduced use of siliceous dolomite ( `r dolomite_spheroids_text` ) and no use of chert. Compared to both the total assemblage and the cores, spheroids show a stronger reliance on lava and a diminished use of more fragile materials, suggesting a selective strategy favoring raw materials with more stable and homogeneous physical properties.

```{r, echo=FALSE}
#| label: fig-core-spheroid-size
#| fig-cap: "Box plot comparing of core, spheroid, and multifacial core dimensions"
#| 
# 读取表格
library(tidyverse)
library(readxl)
library(here)
library(dplyr)

file_path <- here("analysis/data/derived_data/cores_spheroids_size.xlsx")
data <- read_excel(file_path)

summary_vars <- data %>%
  select(core_length, core_width, core_thickness, core_weight,
         spheroid_length, spheroid_width, spheroid_thickness, spheroid_weight,
          multi_poly_length, multi_poly_width, multi_poly_thickness)

summary_stats <- summary_vars %>%
  summarise(across(everything(),
                   list(mean = ~mean(.x, na.rm = TRUE),
                        sd = ~sd(.x, na.rm = TRUE)),
                   .names = "{.col}_{.fn}"))

long_data <- data %>%
  select(core_length, core_width, core_thickness,
         spheroid_length, spheroid_width, spheroid_thickness,
         multi_poly_length, multi_poly_width, multi_poly_thickness) %>%
  pivot_longer(
    everything(),
    names_to = "type_metric",
    values_to = "value"
  ) %>%
  extract(type_metric, into = c("artifact", "metric"),
          regex = "^(core|spheroid|multi_poly)_(length|width|thickness)") %>%
  filter(!is.na(value)) %>%
  mutate(
    artifact = recode(artifact,
                      "core" = "Cores",
                      "spheroid" = "Spheroid",
                      "multi_poly" = "Polys and Multi cores"),
    metric = factor(metric, levels = c("length", "width", "thickness"))
  )


# 画图
p_dimensions <- 
ggplot(long_data, aes(x = metric, y = value, fill = artifact)) +
  geom_boxplot(position = position_dodge(0.8), width = 0.5) +
  labs(
    x = "",
    y = "Measurement (mm)",
    fill = "Technological Type"
  ) +
  scale_fill_manual(values = c(
    "Cores" = "lightgray", 
    "Spheroid" = "orange", 
    "Polys and Multi cores" = "#66c2a5"
  )) +
  theme_minimal(base_size = 8) +
  guides(fill = "none")

```

In terms of dimensions, the average length, width, thickness, and mass of spheroids were `r round(summary_stats$spheroid_length_mean, 1)` mm (SD = `r round(summary_stats$spheroid_length_sd, 1)`), `r round(summary_stats$spheroid_width_mean, 1)` mm (SD = `r round(summary_stats$spheroid_width_sd, 1)`), `r round(summary_stats$spheroid_thickness_mean, 1)` mm (SD = `r round(summary_stats$spheroid_thickness_sd, 1)`), and `r round(summary_stats$spheroid_weight_mean, 1)` g (SD = `r round(summary_stats$spheroid_weight_sd, 1)`), respectively, as shown in @fig-basic-characteristics. Two spheroids showed outlier values in size, being either unusually large or small, while the rest exhibited relatively concentrated size distributions. In contrast, polyhedrons and multifacial cores displayed greater variability in size, with standard deviations of `r round(summary_stats$multi_poly_length_sd, 1)` mm, `r round(summary_stats$multi_poly_width_sd, 1)` mm, and `r round(summary_stats$multi_poly_thickness_sd, 1)` mm for length, width, and thickness, respectively. Additionally, spheroids tend to have similar values across length, width, and thickness, reflecting their overall symmetry. In contrast, polyhedrons and multifacial cores show marked differences among these dimensions, indicating more irregular and elongated forms.

```{r}
#| label: fig-basic-characteristics
#| fig-cap: "Basic characteristics of the Qianshangying assemblage. A: Raw material proportions. B: Box plot comparing of core, spheroid, and multifacial core dimensions"
#| echo: false

library(cowplot)

plot_grid(p_raw_material,
          p_dimensions,
          labels = "AUTO")

```


# Method

We generated 3d models of the cores for morphometric and technological analysis. Digital data were captured using Artec Spider, and post-processing was carried out with Artec Studio <!-- BM: add version number -->. The 3D scan files and all the R and Python code used in the analyses reported here are openly available online at https://doi.org/xxxx/xxxx/./xxxx/. <!-- BM: love to see this! -->

## Morphometric Analysis

```{r, echo=FALSE}
# 读取表格
library(tidyverse)
library(readxl)
library(here)
library(stringr)

file_path <- here("analysis/data/derived_data/core_typology_morphological_parameters.xlsx")
data_raw <- read_excel(file_path)

# 对所有字符型列进行清洗
data_clean <- data_raw |>
  mutate(across(
    where(is.character),
    ~ str_to_title(str_squish(trimws(.x)))
  ))

# 统计每类 Typology 的数量
typology_counts <- data_clean |> 
  count(Typology, sort = TRUE)

n_total_typology <- data_clean |> 
  filter(!is.na(Typology)) |> 
  nrow()

# 组合统计
group_counts <- data_clean |>
  filter(Typology %in% c("Polyhedron", "Multifacial", "Spheroid", "Subspheroid")) |>
  mutate(
    Group = case_when(
      Typology %in% c("Polyhedron", "Multifacial") ~ "Polyhedron + Multifacial",
      Typology %in% c("Spheroid", "Subspheroid") ~ "Spheroid + Subspheroid"
    )
  ) |>
  count(Group)

n_poly_multi <- group_counts$n[group_counts$Group == "Polyhedron + Multifacial"]
n_sub_spheroid <- group_counts$n[group_counts$Group == "Spheroid + Subspheroid"]


```

In our typological study we identified some faceted sub-spheroids/spheroids in the Qianshangying assemblage. To minimize subjective judgments that are inherent in typological classifications—particularly in distinguishing spheroids from stone cores—we applied quantitative methods to our 3d models to evaluate the degree of difference between the archaeological spheroids and a perfect sphere. In addition to the spheroids, we included other multifacial cores and polyhedrons in the morphological study to explore whether they can be distinguished from the spheroids. These quantitative methods included computing the sphericity index, 3D spherical harmonics, spherical harmonic energy (SHE) and the centroid offset for each artifact. We also examined the degree of standardization of the spheroids by compulating coefficients of variation [@Eerkens2001; @muller2023] of shape proxies. Furthermore, we compared the results of the typological study and our new morphometric analyses to investigate the validity of the traditional typological approach.

### Sphericity index

To evaluate the degree to which the artifacts approximate a perfect sphere, we employed a standardized sphericity index originally proposed by @Wadell1935 and later adapted for 3D digital models in geoscientific research. The index is calculated using the following formula:

$$
\Psi = \frac{\pi^{1/3} (6V)^{2/3}}{A}
$$

Where V is the volume and A is the surface area of the object. This dimensionless metric yields a maximum value of 1 for a perfect sphere. While values closer to 1 generally indicate a more spherical geometry, sphericity is calculated solely from volume and surface area. As a result, some irregular objects may exhibit high sphericity, while conversely, objects that are generally spherical in shape may deviate from ideal sphericity due to angular features or surface roughness. Thus, sphericity serves as a useful but limited proxy for assessing how close an object is to a perfect sphere. We used Python to decimate to a consistent face count and conduct a unit normalization to ensure comparability across artifacts, and then derived surface area and volume measurements from these processed 3D mesh models.

### 3D spherical harmonics analysis

Spherical Harmonic (SPHARM) analysis is a method for describing 3D shapes using a series of mathematical functions defined on the surface of a sphere. It works like a 3D version of Fourier analysis, breaking down complex shapes into components of different spatial frequencies. Each shape $f(\theta, \phi)$ is first mapped onto a unit sphere and then expressed as a combination of spherical harmonic basis functions $Y_l^m(\theta, \phi)$ according to

$$
f(\theta, \phi) = \sum_{l=0}^{\infty} \sum_{m=-l}^{l} \hat{f}(l, m) \, Y_l^m(\theta, \phi)
$$
where the set of coefficients $\hat{f}(l, m)$ quantifies how much each basis function contributes to the overall shape. Here, θ and ϕ are angles in spherical coordinates, l and m are order and degree respectively. Lower-order terms describe the general shape, while higher-order terms capture finer details (@fig-SPHARM-Reconstruction-by-Degree).

This method is widely used in the field of biology, such as the analysis of skull morphology and cell morphology [@Link2024; @Medyukhina2020; @Harper2022; @Hewitt2024; @Grieb2022]. However, there are currently very few application of SPHARM to archaeological artifacts. @Muller2023 used closed-source and proprietary Matlab software to investigate intentionality in the production of 150 limestone spheroids from ‘Ubeidiya (ca 1.4 Ma) in the Levant. @Muller2023 did not provide code to document their analysis, but they found that lithic reduction resulted in the spheroids becoming more spherical, and concluded that spheroids represent intentionally knapped items. Our work builds on theirs by extending the use of spherical harmonics for the first time to study standardisation and to distinguish between spheroids and polyhedrons. @Noshita2025 used Python to apply spherical harmonic analysis to Ongagawa-style pottery in the Yayoi period of Japan (800 BC–AD 250). Their results were consistent with the hypothesis of an association of Ongagawa-style pottery with the spread of agriculture via two routes in prehistoric Japan, and they provided code and date files to enable their analysis to be reproduced. Our work combines the merits of these previous studies to demonstrate an open source and reproducible analysis of stone artefacts using SPHARM, besides, we used rotation-invariant power spectrum and UMAP to extract the shape features, explore hidden structures in data,and then achieve grouping among flaked pieces, marking the first attempt of its kind. All these were completed in python. We hope to demonstrate the value of this method for quantitative shape analyses of objects that are roughly spherical in shape, such as the spheroids and cores in our case study from Qianshangying.

```{r, echo=FALSE}
#| label: fig-SPHARM-steps
#| fig-cap: "The steps of 3D spherical harmonics analysis"

library(here)
knitr::include_graphics(here("analysis/paper/figures/SPHARM_steps.png"))

```

As shown in the @fig-SPHARM-steps, we first imported, cleaned, simplified and normalized the STL files of spheroids and cores to obtain 3D mesh vertices, which were then converted from Cartesian (x, y, z) to spherical coordinates (r, θ, φ) [@Link2024; @Medyukhina2020]. Next, we interpolated radial values onto a regular spherical grid  of N×N and then decomposed them using spherical harmonics based on the Driscoll–Healy sampling scheme [@Link2024; @Medyukhina2020]. The resulting coefficients were normalized for scale-invariant comparison across models.

From the normalized spherical harmonic coefficients, we computed the rotation-invariant power spectrum by summing the squared magnitudes of the coefficients at each degree. Each 3D shape is thus represented by its unique power spectrum, which serves as a multidimensional descriptor. To explore relationship between models, we applied Uniform Manifold Approximation and Projection (UMAP) for dimensionality reduction and visualization [@Van2023]. Unlike traditional linear dimensionality reduction methods such as Principal Component Analysis (PCA), which capture only global linear variance patterns, UMAP is a non-linear technique designed to preserve both local and global data structure. Its grouping is based on the local and global similarity of shape data. This makes UMAP particularly well suited for complex shape data represented by spherical harmonic coefficients, where morphological variations may manifest in subtle, non-linear ways across multiple degrees. By effectively capturing these non-linear relationships, UMAP yields a refined morphospace representation, enabling detection of complex shape differences that linear techniques may overlook.

To better interpret the grouping revealed by UMAP, we included a set of standard geometric models—such as sphere, rounded cube, ellipsoid (1.2:1:0.8), box (1.2:1:1), and disc-like forms (flattened and discoid core)—in the SPHARM analysis and UMAP embedding as visual references. Spheroids and cores were positioned in this morphospace based on their morphological similarity to these reference models: individuals that cluster more closely to a specific standard form exhibit corresponding shape characteristics. 

### Spherical Harmonic Energy

Additionally, we computed the spherical harmonic energy (SHE), defined as the sum of squared normalized spherical harmonic coefficients for each degree. This provides a rotation-invariant measure of shape complexity across spatial frequencies. For normalized shapes, this total energy approaches one for a perfect sphere, while more irregular forms yield higher values.

Notably, classic sphericity metrics [@Wadell1935] exhibit critical limitations in differentiating morphotypes with equivalent surface-area-to-volume ratios. SHE overcomes this constraint through spherical harmonic decomposition of surface morphology, and this allows it to distinguish localized irregularities (like core edge or concave) from global shape deviations (e.g., elongation) – differences that classic sphericity metrics often fail to capture.

We computed the total energy at degree 20, a resolution high enough to capture surface details. Lower energy values indicate more regular or rounded surfaces, while higher values reflect more irregular or angular geometries.


## Technological Analysis

To complement our shape analysis, we applied technological analysis of the production strategies of spheroids in Qianshangying. Together these methods help determine whether the artifacts were intentionally shaped and whether their manufacture followed standardized procedures. Addressing this question is crucial for achieving our goal of determining whether or not spheroids represent a distinct technological category, separate from exhausted cores.

### Diacritical analysis

We applied diacritical analysis to reconstruct the reduction sequence based on superimposition relationships among scars on spheroids [@tittonSubspheroidsLithicAssemblage2020; @Cabanes2024]. This method enables the identification of scars order, allowing us to figure out the organization of removals. All spheroids, polyhedrons and multifacial cores are included in the analysis to assess whether removals organization differs systematically within these groups.

Following the reconstruction of reduction sequences, we adopted an inductive approach to infer exploitation models of spheroids—that is, the removal patterns and associated stages employed in a spheroid. Our goal was to reconstruct the complete chaîne opératoire of spheroids—from the selection of raw material and initial blank to the final product. If consistent patterns can be observed, they may indicate shared reduction schemes or conceptual templates.We also explored whether multifacial cores and polyhedrons may represent earlier stages in spheroid reduction sequences, contributing to understanding the technological relationship between these types.

### Orientation analysis

To further investigate technological strategies, we incorporated orientation statistics as a complementary approach. This method derives from fabric analysis originally used in sedimentology and has since been adapted to study the arrangement of flake scars on lithic artifacts. We followed the protocol developed by @lin2024, extracting scar vectors from each core and calculating eigenvalues to derive the isotropic ratio and elongation ratio, these steps were carried out in Geomagic Wrap, Rhino8 and R 4.5.1.

Results are visualized using ternary plots to compare orientation statistics between spheroids and other core types. Based on our hypothesis, if spheroids were shaped following a consistent reduction sequence, they should exhibit similar and patterned orientation results. In contrast, if they merely represented exhausted cores, the orientation patterns would appear random and highly variable, similar to those of undirected polyhedron and multifacial cores.

## Efficiency of shaping strategy

This section aims to investigate how the morphology of spheroids evolves during the reduction process. We hypothesize that, as reduction intensity increases, spheroids will progressively approximate a perfect sphere. This would indicate a high-efficiency shaping strategy, where each step is directed toward achieving a predefined morphological goal. To test this hypothesis, we established a set of quantitative indicators for reduction intensity and spheroid morphology.

### Degree of reduction

To compute the degree of reduction we collected data on three metrics: scar number, removal ratio and scar density index (SDI). We measured scar number as total number of flake scars visible on the spheroid surface. Removal ratio was calculated as 1 minus cortex ratio, where the cortex ratio represents the proportion of cortical surface area to total surface area [@Cabanes2024]. We used the removal ratio instead of the traditional cortex ratio in order to maintain a positive correlation with other reduction intensity indicators. SDI is defined as the number of flake scars divided by the total 3D surface area, the SDI serves as a robust indicator of core reduction intensity, following @clarksonMeasuringCoreReduction2013. It has been demonstrated to effectively capture the dynamic nature of the reduction process. In all three metrics, higher values represent more advanced stages of reduction. Scar counts and surface area measurements were extracted using Geomagic Wrap.

### Spheroid shape

We measured spheroid shape with four metrics: sphericity, and spherical harmonic energy (SHE), along with mean edge angle, mean surface curvature. Higher mean edge angles suggest a more spherical geometry. Ten edge intersections were randomly sampled per spheroid. Angles were calculated following @tittonSubspheroidsLithicAssemblage2020 by constructing triangles at ridge intersections, extracting vertex coordinates in Geomagic Wrap, and computed angles from the coordinates using trigonometric functions in R. Mean surface curvature is a proxy for surface roughness, and higher mean surface curvature indicates a smoother surface. We estimated local curvature using the k-nearest neighbors method to fit a best-fit plane at each vertex [@Muller2023]. The deviation between actual surface points and this fitted plane reflects surface roughness. Theses calculations were completed in Python.

Together, these four variables allowed us to assess whether more extensively reduced spheroids display more standardized, symmetrical, and regular morphologies—characteristics expected in deliberate shaping strategies. We conducted Spearman’s rank correlation analysis between two sets of variables—reduction intensity indicators and morphological attributes. This non-parametric method is appropriate for small sample sizes and data that do not follow a normal distribution. Spheroids and sub-spheroids from Qianshangying were included in the analysis.

# Results

## Morphometric analysis

```{r tbl-1, echo=FALSE}

knitr::kable(data_raw %>% 
               # round values for display
               mutate(across(where(is.numeric), round, 3)), 
             caption = "Summary of core typology and morphological parameters.")

```

```{r, echo=FALSE}

# Groups

mean_sphericity_tbl <- data_clean |>
  filter(Typology %in% c("Polyhedron", "Multifacial", "Spheroid", "Subspheroid")) |>
  mutate(
    Group = case_when(
      Typology %in% c("Polyhedron", "Multifacial") ~ "Polyhedron + Multifacial",
      Typology %in% c("Spheroid", "Subspheroid") ~ "Spheroid + Subspheroid"
    )
  )

# Mean Sphericity

mean_sphericity_summary <- mean_sphericity_tbl |>
  group_by(Group) |>
  summarise(mean_sphericity = mean(Sphericity, na.rm = TRUE)) |>
  ungroup()


mean_sphericity_poly_multi <- mean_sphericity_summary$mean_sphericity[mean_sphericity_summary$Group == "Polyhedron + Multifacial"] |> round(3)
mean_sphericity_sub_spheroid <- mean_sphericity_summary$mean_sphericity[mean_sphericity_summary$Group == "Spheroid + Subspheroid"] |> round(3)
```

```{r, echo=FALSE}

# Mann-Whitney U test
# between sphericity_poly_multi and sphericity_sub_spheroid

group_poly_multi <- mean_sphericity_tbl$Sphericity[mean_sphericity_tbl$Group == "Polyhedron + Multifacial"]
group_sub_spheroid <- mean_sphericity_tbl$Sphericity[mean_sphericity_tbl$Group == "Spheroid + Subspheroid"]

mann_whitney_result_sphericity <- wilcox.test(group_poly_multi, group_sub_spheroid, exact = FALSE)

U_value <- mann_whitney_result_sphericity$statistic  
p_value <- mann_whitney_result_sphericity$p.value    

pretty_print_sci <- function(num) {
  sci_str <- sprintf("%.2e", num)
  parts <- strsplit(sci_str, "e")[[1]]
  base <- parts[1]
  exponent <- as.integer(parts[2])
  paste0(base, " \\times 10^{", exponent, "}")
}

p_value_Mann_sci <- pretty_print_sci(p_value)

```

```{r, echo=FALSE}

# Kruskal–Wallis test
# on sphericity among 4 core types

kruskal_result <- kruskal.test(Sphericity ~ Typology, data = data_clean)

H_value <- kruskal_result$statistic
df_kruskal <- kruskal_result$parameter
p_value_kruskal <- kruskal_result$p.value
p_value_kruskal_sci <- pretty_print_sci(p_value_kruskal)
```

```{r, include=FALSE}
# Pearson correlation test

cor_test_pearson <- cor.test(data_clean$Sphericity, data_clean$`SPHARM power`, method = "pearson")


t_value <- cor_test_pearson$statistic
df_value <- cor_test_pearson$parameter
p_value <- cor_test_pearson$p.value
correlation <- cor_test_pearson$estimate

p_value_pearson_sci <- pretty_print_sci(p_value)

p_corr_sphericiy_she <- 
ggplot(data_clean, aes(x = Sphericity, y = `SPHARM power`)) +
  geom_point(size = 3, alpha = 0.9, color = "grey60") +
  geom_smooth(method = "lm", se = TRUE, color = "black", fill = "#A6CEE3") +
  scale_x_continuous(breaks = seq(0.4, 1.0, by = 0.04)) +
  theme_minimal(base_size = 12)  +
  labs(x = "Sphericity", 
       y = "Spherical Harmonic Energy") +
  annotate("text",
         x = Inf, y = Inf,
         hjust = 1.1, vjust = 1.2,
         label = paste0("r = ", round(correlation, 3),
                        "\n", "p = ", pretty_print_sci(p_value),
                        "\n", "n = ", nrow(data_clean)),
         size = 5, color = "#1C3041")
```


```{r, include=FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# 把两个指标转成长格式，方便facet_wrap显示
df_long <- mean_sphericity_tbl %>%
  select(Group, Sphericity, `SPHARM power`) %>%
  pivot_longer(cols = c(Sphericity, `SPHARM power`),
               names_to = "Variable",
               values_to = "Value")

# 自定义Group名称映射，方便图例显示
df_long <- df_long %>%
  mutate(Group = factor(Group, 
                        levels = c("Spheroid + Subspheroid", 
                                   "Polyhedron + Multifacial"),
                        labels = c("Spheroid + Subspheroid", 
                                   "Polyhedron + Multifacial"))) %>% 
  mutate(
    Group = case_when(
      Group == "Spheroid + Subspheroid" ~  "Spheroid\nSubspheroid", 
      Group == "Polyhedron + Multifacial" ~  "Polyhedron\nMultifacial",
      TRUE ~ NA_character_
    )
  )

# 画图
p_sphericity_and_she <- 
ggplot(df_long, aes(x = Group, 
                    y = Value, 
                    fill = Group,
                    colour = Group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.5) +
  geom_jitter(width = 0.15, 
              alpha = 1, 
              size = 1) +
  facet_wrap(~ Variable, scales = "free_y") +
  scale_fill_manual(values = c("Spheroid\nSubspheroid" = "orange", 
                               "Polyhedron\nMultifacial" = "#66c2a5")) +
  scale_colour_manual(values = c("Spheroid\nSubspheroid" = "orange", 
                               "Polyhedron\nMultifacial" = "#66c2a5")) +
  labs(x = "",
       y = "",
       fill = "Group", 
      # title = "Sphericity and SHE by Group"
       ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none"
  )
```

```{r, include=FALSE}
# 读取 CSV
df <- read_csv(
  here("analysis", "data", "derived_data", "variance_per_degree.csv")
)

p_variance_per_degreee <- 
ggplot(df, aes(x = degree, y = variance)) +
  geom_line(size = 1.3, colour = "black") +          
  geom_point(size = 3, colour = "grey60") +  # 橙色边框，填充浅橙
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +    
  scale_y_continuous(breaks = scales::pretty_breaks(n = 8)) +      
  labs(
   # title = "Variance per Degree",
    x = "Spherical Harmonic Degree",
    y = "Variance"
  ) +
  theme_minimal(base_size = 12) 

```


```{r, echo=FALSE}

library(here)
data_dir <- here("analysis", "data", "derived_data", "power_spectrum")
csv_files <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

# 读取所有 CSV 文件，并加上文件名
all_data <- map_dfr(csv_files, function(file) {
  df <- read.csv(file, header = FALSE)
  colnames(df) <- c("degree", "total_power", "max_amplitude", "total_amplitude")
  df$file <- basename(file)
  return(df)
})

#l_2_3_power <- all_data %>%
  #filter(degree %in% c(2, 3)) %>%
  #select(file, degree, total_power) %>%
  #pivot_wider(names_from = degree, values_from = total_power, names_prefix = "l_")

# 查看结果
#View(l_2_3_power)

# 添加 group 列（可以多标签：Spheroid, Polyhedron, All）
all_data <- all_data %>%
  mutate(
    group = case_when(
      str_detect(file, regex("Polyhedron|Multifacial", ignore_case = TRUE)) ~ "Polyhedron/Multifacial",
      str_detect(file, regex("Spheroid|Subspheroid", ignore_case = TRUE)) ~ "Spheroid/Subspheroid",
      TRUE ~ NA_character_
    )
  )

# 所有样本一组（不管名字）
all_data_all <- all_data %>%
  mutate(group = "All specimens")

# 合并所有分组
combined_data <- bind_rows(all_data, all_data_all) %>%
  filter(!is.na(group))

# 计算每组的 degree 平均值和标准差
summary_df <- combined_data %>%
  group_by(group, degree) %>%
  summarise(
    mean_power = mean(total_power, na.rm = TRUE),
    sd_power = sd(total_power, na.rm = TRUE),
    .groups = "drop"
  )

# 绘图，带误差带
p_power_spectrum <- 
ggplot(summary_df, aes(x = degree, y = mean_power, color = group, fill = group)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(
    ymin = pmax(mean_power - sd_power, 1e-10),
    ymax = mean_power + sd_power
  ), alpha = 0.2, linetype = 0) +
  scale_y_log10(
  breaks = c(1e-8, 1e-6, 1e-4, 1e-2, 1),
  labels = parse(text = c("10^-8", "10^-6", "10^-4", "10^-2", "10^0"))
  )+
  scale_x_continuous(
    limits = c(0, 20),
    breaks = seq(0, 20, by = 4),
    expand = c(0, 0)
  ) +
  coord_cartesian(clip = "on") +
  scale_color_manual(values = c(
    "All specimens" = "lightgray",
    "Spheroid/Subspheroid" = "orange",
    "Polyhedron/Multifacial" = "#66c2a5"
  )) +
  scale_fill_manual(values = c(
    "All specimens" = "lightgray",
    "Spheroid/Subspheroid" = "orange",
    "Polyhedron/Multifacial" = "#66c2a5"
  )) +
  labs(
   # title = "Mean Power Spectrum with Standard Deviation",
    x = "Degree (l)",
    y = "Mean Total Power (log scale)",
    color = "Group",
    fill = "Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
  legend.position = c(0.95, 0.4),
  legend.justification = c("right", "top"),
  legend.background = element_rect(fill = alpha("white", 0.8), color = NA),
  legend.box.background = element_rect(color = "gray80"),
  legend.box.margin = margin(5, 5, 5, 5)
  )
```


```{r}
#| label: fig-sp-summary
#| fig-cap: "A. Mean spherical harmonic power spectrum. B. Variance distribution by spherical harmonic degree. C. Distribution of SPHARM power and sphericity by artefact type. D. Correlation of sphericity and spherical harmonic energy"

# combine plots
library(cowplot)
p_panel_spharm <- 
plot_grid(p_power_spectrum, 
          p_variance_per_degreee,
          p_sphericity_and_she,
          p_corr_sphericiy_she,
          labels = 'AUTO'
           )

ggsave(plot = p_panel_spharm,
       filename = here("analysis/paper/figures/panel_spharm_plots.png"),
       h = 8, 
       w = 9)


knitr::include_graphics(here("analysis/paper/figures/panel_spharm_plots.png"))

```

@fig-sp-summary

```{r, echo=FALSE}
# Mean SHE

mean_spharm_power_summary <- mean_sphericity_tbl |>
  group_by(Group) |>
  summarise(
    mean_spharm_power = mean(`SPHARM power`, na.rm = TRUE),
    sd_spharm_power = sd(`SPHARM power`, na.rm = TRUE)
  ) |>
  ungroup()

mean_spharm_power_poly_multi <- mean_spharm_power_summary$mean_spharm_power[mean_spharm_power_summary$Group == "Polyhedron + Multifacial"] |> round(3)
sd_spharm_power_poly_multi <- mean_spharm_power_summary$sd_spharm_power[mean_spharm_power_summary$Group == "Polyhedron + Multifacial"] |> round(3)

mean_spharm_power_sub_spheroid <- mean_spharm_power_summary$mean_spharm_power[mean_spharm_power_summary$Group == "Spheroid + Subspheroid"] |> round(3)
sd_spharm_power_sub_spheroid <- mean_spharm_power_summary$sd_spharm_power[mean_spharm_power_summary$Group == "Spheroid + Subspheroid"] |> round(3)
```

```{r, echo=FALSE}
# Kruskal–Wallis test2
# on SHE among 4 core types

kruskal_result2 <- kruskal.test(`SPHARM power` ~ Typology, data = data_clean)

H_value_kruskal2 <- kruskal_result2$statistic
df_kruskal2 <- kruskal_result2$parameter
p_value_kruskal2 <- kruskal_result2$p.value

p_value_kruskal2_sci <- pretty_print_sci(p_value_kruskal2)
```

```{r, echo=FALSE}

# CV of sphericity and SHE

group_sub_spheroids <- mean_sphericity_tbl %>% filter(Group == "Spheroid + Subspheroid")

# sphericity on spheroids
mean_sph_sub_spheroids <- mean(group_sub_spheroids$Sphericity, na.rm = TRUE)
sd_sph_sub_spheroids <- sd(group_sub_spheroids$Sphericity, na.rm = TRUE)
cv_sph_sub_spheroids <- sd_sph_sub_spheroids / 
mean_sph_sub_spheroids

# SHE on spheroids
mean_she_sub_spheroids <- mean(group_sub_spheroids$`SPHARM power`, na.rm = TRUE)
sd_she_sub_spheroids <- sd(group_sub_spheroids$`SPHARM power`, na.rm = TRUE)
cv_she_sub_spheroids <- sd_she_sub_spheroids /
mean_she_sub_spheroids


group_poly_multi <- mean_sphericity_tbl %>% filter(Group == "Polyhedron + Multifacial")

mean_sph_poly_multi <- mean(group_poly_multi$Sphericity, na.rm = TRUE)
sd_sph_poly_multi <- sd(group_poly_multi$Sphericity, na.rm = TRUE)
cv_sph_poly_multi <- sd_sph_poly_multi / mean_sph_poly_multi


mean_she_poly_multi <- mean(group_poly_multi$`SPHARM power`, na.rm = TRUE)
sd_she_poly_multi <- sd(group_poly_multi$`SPHARM power`, na.rm = TRUE)
cv_she_poly_multi <- sd_she_poly_multi / mean_she_poly_multi


```

```{r setup_umap_data, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggrepel)
library(here)

# Load data
umap_data <- read_csv(here("analysis/data/derived_data/umap_lmax20.csv"))

# Lowercase category and set factor levels
umap_data <- umap_data %>%
  mutate(category_lower = tolower(category)) %>%
  mutate(category_lower = fct_relevel(category_lower,
    "polyhedron", "multifacial", "idealmodel", "subspheroid", "spheroid"
  ))

# Set point size (highlight idealmodel)
umap_data <- umap_data %>%
  mutate(point_size = if_else(category_lower == "idealmodel", 4.5, 3))

# KMeans clustering (k=4)
set.seed(123)
kmeans_result <- kmeans(umap_data[, c("x", "y")], centers = 4)

# Add clustering results
umap_data <- umap_data %>%
  mutate(
    cluster = factor(kmeans_result$cluster),
    is_idealmodel = if_else(category_lower == "idealmodel", "yes", "no")
  )

# Save x/y limits for consistent plotting
x_limits <- range(umap_data$x)
y_limits <- range(umap_data$y)

expand_range <- function(lim, ratio) {
  range_width <- diff(lim)
  return(c(lim[1] - range_width * ratio, lim[2] + range_width * ratio))
}

# 原始坐标范围
x_limits <- range(umap_data$x)
y_limits <- range(umap_data$y)

# 分别扩展 x 和 y
x_limits_expanded <- expand_range(x_limits, 0.10)  # 横轴扩展 10%
y_limits_expanded <- expand_range(y_limits, 0.15)  # 纵轴扩展 15%

# Subset for labeling
label_data <- umap_data %>%
  filter(category_lower %in% c("idealmodel", "spheroid", "subspheroid"))
```

```{r umap_by_category, include=FALSE}
category_colors <- c(
  "idealmodel" = "black",
  "spheroid" = "red",
  "subspheroid" = "orange",
  "multifacial" = "lightgray",
  "polyhedron" = "gray40"
)

ggplot(umap_data, aes(x = x, y = y)) +
  geom_point(aes(color = category_lower, size = point_size), alpha = 0.9, shape = 16) +
  #geom_text_repel(
    #data = label_data,
    #aes(label = filename),
    #size = 3,
    #max.overlaps = 100,
    #show.legend = FALSE
  #) +
  scale_color_manual(values = category_colors, name = "Category") +
  scale_size_identity() +
  coord_cartesian(xlim = x_limits_expanded, ylim = y_limits_expanded)+ #确保范围一致
  theme_minimal(base_size = 14) +
  labs(
    x = "UMAP 1",
    y = "UMAP 2"
  ) +
  theme(
    legend.position = "non",
    # plot.title = element_text(face = "bold")
  )
```

```{r umap_by_cluster, include=FALSE}
cluster_colors <- RColorBrewer::brewer.pal(4, "Set2")

ggplot(umap_data, aes(x = x, y = y)) +
  geom_point(
    data = filter(umap_data, is_idealmodel == "no"),
    aes(color = cluster),
    alpha = 0.8,
    size = 2.5
  ) +
  geom_point(
    data = filter(umap_data, is_idealmodel == "yes"),
    aes(color = cluster),
    size = 3.5,
    show.legend = FALSE
  ) +
  stat_ellipse(
    aes(color = cluster),
    type = "norm",
    level = 0.95,
    linetype = "dashed",
    show.legend = FALSE
  ) +
  scale_color_manual(
    values = cluster_colors,
    name = "Cluster"
  ) +
  coord_cartesian(xlim = x_limits_expanded, ylim = y_limits_expanded) +  # 保证坐标一致
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  labs(
    x = "UMAP 1",
    y = "UMAP 2",
    #caption = "Dashed ellipses show 95% confidence intervals"
  )
```

```{r, echo=FALSE}
#| label: fig-SPHARM-Reconstruction-by-Degree
#| fig-cap: "Shape reconstruction of archaeological spheroids using SPHARM (various lmax levels)"

library(here)
knitr::include_graphics(here("analysis/paper/figures/SPHARM_reconstruction.png"))

```

```{r, echo=FALSE}
#| label: fig-UMAP-SPHARM-clusters
#| fig-cap: "UMAP plot showing distinct clusters of shapes derived from SPHARM"

library(here)
knitr::include_graphics(here("analysis/paper/figures/UMAP_SPHARM_clusters.png"))

```

```{r, echo=FALSE}
#| label: fig-UMAP-SPHARM-samples
#| fig-cap: "UMAP plot of SPHARM-derived shape features colored by types"

library(here)
knitr::include_graphics(here("analysis/paper/figures/UMAP_SPHARM_samples.png"))

```

```{r, echo=FALSE}
#| label: fig-Correlation-SPHARMpower-Sphericity
#| fig-cap: "Correlation analysis between SPHARMpower and Sphericity"

library(here)
knitr::include_graphics(here("analysis/paper/figures/Correlation_SPHARMpower_Sphericity.png"))

```


We calculated the spherical sphericity and spherical harmonic energy (SHE) to both the spheroids (n = `r n_total_typology`) and all other multifacial and polyhedron cores (n = `r n_poly_multi`) in the Qianshangying assemblage. These analyses aim to assess whether spheroids are morphologically distinct from other cores, and whether they exhibit standardized shapes—an essential criterion for evaluating the existence of deliberate shaping strategies and a goal product. In addition, we compare quantitative outcomes with traditional typological classifications to assess their consistency. We present a summary table listing each core's blank morphology and type, final morphology, and cortex coverage here in [@tbl-1].

Our results of sphericity reveals a clear difference between spheroids and multifacial cores/polyhedra. The mean sphericity of spheroids (`r mean_sphericity_sub_spheroid`) is notably higher than that of multifacial cores and polyhedron (`r mean_sphericity_poly_multi`), with a Mann-Whitney U test yielding U = `r U_value`, p = $`r p_value_Mann_sci`$. This result indicates that spheroids possess a more spherical geometry overall, supporting their typological classification as a distinct type.

We conducted shape analysis using spherical harmonic decomposition, setting the maximum degree to 20 (lmax=20, @fig-SPHARM-Reconstruction-by-Degree). This choice ensures that sufficient geometric detail is captured while avoiding high-frequency noise and overfitting artifacts. After normalization, all models have their degree 0 (l=0) coefficient set to 1, allowing for meaningful comparison across different models. 

Subsequently, we computed the rotation-invariant power spectrum. Here we present the power spectrum of different groups, including spheroids, multifacial cores, polyhedrons, and the total of all these types combined. The results show that the spheroid group has significantly lower power than polyhedrons and multifacial cores at both low and high degrees, indicating that spheroids possess a more symmetrical overall shape and more regular local features. In addition, the spheroid group exhibits smaller inter-group morphological variation than polyhedrons and multifacial cores, particularly at low degrees. Then we performed a Variance Analysis on the power of each harmonic degree. The results indicate that l=2 and l=3 exhibit the highest variance across the sample, suggesting that these low-order terms capture the most significant shape variation. Specifically, l=2 reflects global asymmetries, such as elongation or flattening, while degree 3 is more sensitive to localized features like curvature and edge protrusions. 

To reduce the dimensionality and visualize the structure of shape variation, we applied a Uniform Manifold Approximation and Projection (UMAP) to the normalized power spectrum. The UMAP reveals distinct clusters in the first two dimensions of the shape space. These clusters correspond to reference models, sphere, rounded cube, ellipsoid, box and disc-shaped core (@fig-UMAP-SPHARM-clusters). This demonstrates that these cores occupy distinguishable regions in the harmonic shape space, with proximity to the sphere or elongation/flattening along specific axes emerging as key differentiating features. Most artifacts typologically classified as spheroids or sub-spheroids were grouped into the “sphere” , “cube” and "ellipsoid" clusters, indicating their consistent, near-spherical shapes (@fig-UMAP-SPHARM-samples). However, some Multifacial cores and Polyhedron also appeared in the near-spherical region. This can be attributed to their high cortex coverage or limited flake removals, which likely preserved their originally rounded forms and led to their grouping alongside more intentionally shaped spheroids. 

The UMAP-based groupings also correspond to significant differences in sphericity, as indicated by a Kruskal–Wallis test ($\chi^2$ = `r round(H_value, 2)`, df = `r df_kruskal`, p = $`r p_value_kruskal_sci`$). The result shows statistically significant differences in sphericity among the shape clusters, further supporting the effectiveness of the spherical harmonic approach in capturing meaningful morphological variation.

The spherical harmonic energy (SHE), a novel metric introduced here, quantifies the geometric approximation of core morphology to an ideal sphere. Normalized SHE approaching unity indicates progressively spherical configurations, while deviations from unity reflect morphological irregularity. Our analysis demonstrates significant negative correlation between SHE and classic sphericity measures (r = `r round(correlation, 2)`, df = `r df_value`, p = $`r p_value_pearson_sci`$)), validating its efficacy as a proxy of sphericity (@fig-Correlation-SPHARMpower-Sphericity).

Statistical comparisons reveal distinct SHE distributions between morphological classes: spheroids and sub-spheroids exhibit mean SHE = `r mean_spharm_power_sub_spheroid` (SD = `r sd_spharm_power_sub_spheroid`), whereas multifacial cores and polyhedron demonstrate significantly higher irregularity (mean SHE = `r mean_spharm_power_poly_multi`, SD = `r sd_spharm_power_poly_multi`). The Kruskal-Wallis test confirms robust inter-group divergence ($\chi^2$ = `r round(H_value_kruskal2, 2)`, df = `r df_kruskal2`, p = $`r p_value_kruskal2_sci`$), proving the distinguishability of spheroids from Qianshangying <!-- BM: I think a boxplot would be good to show this to the reader also -->

The pursuit of a standardized and distinct spherical form among spheroids is further supported by our findings. Using the Coefficient of Variation (CV)—defined as the sample standard deviation divided by the sample mean—we assessed the consistency of sphericity within the spheroids. @Eerkens2001 suggested that a CV of under 1.7% (0.017) is a realistic threshold for manually-produced archaeological artifacts. Both sphericity and SHE values yielded low CVs (`r round(cv_sph_sub_spheroids, 3)` and `r round(cv_she_sub_spheroids, 3)`, respectively), indicating that sub/spheroids maintain a highly standardized rounded shape. In contrast, multifacial cores combined with polyhedron has a higher CV of `r round(cv_sph_poly_multi, 3)` and `r round(cv_she_poly_multi, 3)` respectively. 

## Technological analysis

Diacritical analysis of spheroid surfaces reveals a structured and recurrent reduction sequence comprising three phases (@fig-spheroids-2797-1098). Phase one was a unidirectional or bidirectional total exploitation, belonging to one kind of volume exploitation. Large and flat surfaces of the cobble were selected as platforms for striking toward the opposite surface. Knapping proceeded until the peripheral volume was fully exploited, resulting in an approximately cubic form. Phase two was peripheral centripetal exploitation. In this phase, previous removals in phase one serve as platforms for centripetal flaking around the core periphery. This represents a surface exploitation strategy. A notable feature is the angle between the face's ventral surface and platform (i.e. core edge angle), which often exceeds 90°, forming a secant plan rather than parallel plan. This phase contributes significantly to the increasingly spherical shape of the artifact. Phase three was the production of small scars on ridges or intersections of previous flake scars, resulting in a rounding and smoother surface, further enhancing sphericity. It is important to note that due to the high degree of reduction intensity observed in most spheroids, phases prior to the visible sequence were often obliterated. We hypothesize the existence of a Phase zero, potentially involving roughing-out of the cobble or an earlier cycle of Phases one to three [@fig-shaping-process].

Scar orientation analysis further supports the interpretation of a systematic reduction sequence in the production of Qianshangying spheroids. @fig-benn-ternary-plot shows that spheroids tend to cluster together, with elongation ratios ranging from 0.403 to 0.637 and isotropy ratios from 0.164 to 0.497 <!-- BM: replace with inline R code -->. These elongation ratios suggest that the spheroids underwent unidirectional or bidirectional total exploitation, typical of Phase one, resulting in relatively high elongation values. In addition, the peripheral centripetal exploitation, namely Phase tow, appears to have contributed to a certain degree of isotropy in scar arrangement—higher isotropy ratios are associated with more spherical shapes. Subspheroids exhibit greater variability in both elongation and isotropy ratios, indicating less consistent reduction intensity.

Multifacial cores and polyhedrons display a wide and dispersed distribution in the ternary plot, without forming any distinctive cluster. Their scar patterns show considerable variability in both elongation and isotropy, reinforcing the interpretation that these cores lack removal organization. Multifacial cores typically exploit natural angles with core rotation occurring without a predetermined plan, which belongs to an opportunistic flaking strategy, while polyhedrons—despite showing a higher degree of reduction—follow a similarly unstructured sequence. This distinction highlights the fundamental technological difference between polyhedrons and spheroids at Qianshangying. Where they used to be considered as a continuous reduction process, our results show that in fact polyhedrons represent exhausted cores, whereas spheroids reflect the presence of a distinct conceptual template and systematic reduction plan.

```{r, echo = FALSE}
get_coordinates <- function(filename) {
  temp_file <- readLines(filename, encoding = "UTF-8")  # 强制 UTF-8 编码读取
  xyz1 <- data.frame(X1 = numeric(), Y1 = numeric(), Z1 = numeric())
  xyz2 <- data.frame(X2 = numeric(), Y2 = numeric(), Z2 = numeric())
  
  for (line in temp_file) {
    if (grepl("^\\s*start\\s*=", line)) {
      coordinates <- gsub(".*\\(([^()]*)\\).*", "\\1", line)
      coords <- as.numeric(strsplit(coordinates, ",")[[1]])
      xyz1 <- rbind(xyz1, data.frame(X1 = coords[1], Y1 = coords[2], Z1 = coords[3]))
    }
    if (grepl("^\\s*end\\s*=", line)) {
      coordinates <- gsub(".*\\(([^()]*)\\).*", "\\1", line)
      coords <- as.numeric(strsplit(coordinates, ",")[[1]])
      xyz2 <- rbind(xyz2, data.frame(X2 = coords[1], Y2 = coords[2], Z2 = coords[3]))
    }
  }

  # 检查是否有数据
  if (nrow(xyz1) == 0 || nrow(xyz2) == 0) {
    warning("未能提取任何坐标，返回空 data.frame")
    return(data.frame())
  }

  # 合并 + 添加 ID、类型、长度等字段
  xyz <- round(cbind(xyz1, xyz2), 5)
  filename_base <- basename(filename)  # 提取文件名
  xyz$ID <- sub("_(.*)", "", filename_base)  # 提取下划线前的部分
  xyz$type <- sub(".*_(.*)\\.txt", "\\1", filename_base)  # 提取下划线后、.txt 前的部分
  xyz$length <- sqrt((xyz$X2 - xyz$X1)^2 + (xyz$Y2 - xyz$Y1)^2 + (xyz$Z2 - xyz$Z1)^2)
  xyz$length_scaled <- xyz$length / sum(xyz$length)

  xyz <- xyz %>%
    filter(complete.cases(.)) %>%
    distinct(.keep_all = TRUE)
  
  return(xyz)
}

# 遍历文件夹中的文本文件
folder_path <- here("analysis/data/raw_data/QSY_A")
temp_file_list <- list.files(folder_path, pattern = "\\.txt$")  # 只列出 .txt 文件

std <- list()

# 读取所有文件并提取数据
for (i in seq_along(temp_file_list)) {
  filepath <- file.path(folder_path, temp_file_list[i])
  std[[i]] <- get_coordinates(filepath)
}

# 运行 benn 函数并构建数据框
benn.output <- as.data.frame(t(sapply(std, benn, min_sample = 0)))
benn.output$type <- sapply(std, function(x) if ("type" %in% names(x)) x$type[1] else NA)
benn.output$ID <- sapply(std, function(x) if ("ID" %in% names(x)) x$ID[1] else NA)
colnames(benn.output) <- c('Scar_count', 'E1', 'E2', 'E3', 'IS', 'EL', 'type', 'ID')

# 检查结果
# print(head(benn.output))

# 保存为 CSV
write.csv(benn.output,
          here("analysis/data/derived_data/benn_output.csv"), row.names = FALSE)
```

```{r, echo=FALSE}
#| label: fig-benn-ternary-plot
#| fig-cap: "Ternary plot showing flake scar orientation analysis"

benn.output$Z <- 1 - benn.output$EL - benn.output$IS

n  = 11      # Number of Data Points
nv = 0.06    # Vertical Adjustment
pn = position_nudge_tern(y = nv, x = nv, z = -nv / 2)

ggtern(data = benn.output, aes(Z, IS, EL, color = type)) + 
  geom_mask() + 
  geom_point(size = 3) + 
  theme_bw() +
  labs(
    x = "Planar", 
    y = "Isotropic", 
    yarrow = "Isotropy Ratio", 
    z = "Linear", 
    zarrow = "Elongation Ratio"
  ) +
  theme_showarrows() + 
  theme_clockwise() + 
  #geom_text(position = pn, aes(label = type), check_overlap = FALSE, size = 3) +
  scale_color_manual(values = c(
    "multifacial" = "lightgray",
    "polyhedron" = "gray40",
    "subspheroid" = "orange",
    "spheroid" = "red"
  ))

ggsave(here("analysis/paper/figures/benn_ternary_plot.jpg"), 
       width = 8, 
       height = 6, 
       dpi = 300)

```

```{r, echo=FALSE}
#| label: fig-spheroids-2797-1098
#| fig-cap: "Diacritical analysis of Qianshangying spheroids"

library(here)
knitr::include_graphics(here("analysis/paper/figures/spheroids_2797_1098.png"))

```

```{r, echo=FALSE}
#| label: fig-shaping-process
#| fig-cap: "hypothesis of QSY spheroid shaping process"

library(here)
knitr::include_graphics(here("analysis/paper/figures/shaping_process.png"))

```

## Shaping strategy efficiency

```{r tbl-2, echo=FALSE}

file_path <- here("analysis/data/derived_data/flaking_intensity_and_shape.xlsx")
data_raw2 <- 
  read_excel(file_path) %>% 
  drop_na() %>% 
  mutate(across(where(is.numeric), \(x) round(x, 3)))

knitr::kable(data_raw2, caption = "Summary of spheroid shaping intensity and shape features.")

```

```{r, echo=FALSE}
#| label: fig-spearman-correlation-matrix
#| fig-cap: "Spearman correlation matrix of shape variables. Red star indicates p < 0.05"

# 加载必要包
library(readxl)
library(Hmisc)       # 用于计算相关系数和p值
library(ggcorrplot)  # 用于相关性热图绘制
library(reshape2)

file_path <- here("analysis/data/derived_data/flaking_intensity_and_shape.xlsx")
data <- read_excel(file_path)

# 标准化列名
colnames(data) <- make.names(colnames(data))

# 选定分析的列
selected_names <- c("Scar.number", "Removal.ratio", "SDI",
                    "Edge.angle.mean", "Curvature", "Sphericity", "SPHARM.power")

# 只选取实际存在于数据中的列
selected_cols <- data[, selected_names[selected_names %in% colnames(data)]]

# 显示维度和列名确认
# print(dim(selected_cols))
# print(colnames(selected_cols))

# 计算 Spearman 相关系数和对应的 p 值
rcorr_result <- rcorr(as.matrix(selected_cols), type = "spearman")
cor_matrix <- rcorr_result$r
p_matrix <- rcorr_result$P

# 转换成长格式
cor_long <- reshape2::melt(cor_matrix)
p_long <- reshape2::melt(p_matrix)

labels_long <- merge(cor_long, p_long, by = c("Var1", "Var2"))
colnames(labels_long) <- c("Var1", "Var2", "cor", "p")

# 调整因子顺序（让 y 轴从上往下）
labels_long$Var1 <- factor(labels_long$Var1, levels = rev(rownames(cor_matrix)))
labels_long$Var2 <- factor(labels_long$Var2, levels = colnames(cor_matrix))

# 显著标记星号
labels_long$star <- ifelse(labels_long$p < 0.05 & labels_long$Var1 != labels_long$Var2, "*", "")

# 相关系数文本，保留2位小数
labels_long$cor_label <- sprintf("%.2f", labels_long$cor)


val1 <- labels_long[labels_long$Var1 == "Scar.number" & labels_long$Var2 == "Removal.ratio", ]
cor_scar_removal <- sprintf("%.2f", val1$cor)
p_scar_removal <- pretty_print_sci(val1$p)

# 提取 scar number ~ SDI
val2 <- labels_long[labels_long$Var1 == "Scar.number" & labels_long$Var2 == "SDI", ]
cor_scar_sdi <- sprintf("%.2f", val2$cor)
p_scar_sdi <- pretty_print_sci(val2$p)

# 提取 removal ratio ~ SDI
val3 <- labels_long[labels_long$Var1 == "Removal.ratio" & labels_long$Var2 == "SDI", ]
cor_removal_sdi <- sprintf("%.2f", val3$cor)
p_removal_sdi <- pretty_print_sci(val3$p)

# 提取 edge angle ~ sphericity
val4 <- labels_long[labels_long$Var1 == "Edge.angle.mean" & labels_long$Var2 == "Sphericity", ]
cor_angle_sph <- sprintf("%.2f", val4$cor)
p_angle_sph <- pretty_print_sci(val4$p)

# 提取 edge angle ~ SPHARM power
val5 <- labels_long[labels_long$Var1 == "Edge.angle.mean" & labels_long$Var2 == "SPHARM.power", ]
cor_angle_she <- sprintf("%.2f", val5$cor)
p_angle_she <- pretty_print_sci(val5$p)

# 提取 curvature ~ Sphericity
val6 <- labels_long[labels_long$Var1 == "Curvature" & labels_long$Var2 == "Sphercity", ]
cor_cur_sph <- sprintf("%.2f", val5$cor)
p_cur_sph <- pretty_print_sci(val5$p)

# make variable names pretty (again) for the plot
labels_long <- 
  labels_long %>% 
  mutate(Var1 = str_replace_all( Var1, "\\.", " "),
         Var2 = str_replace_all( Var2, "\\.", " "))

# 自己绘图
ggplot(labels_long, aes(x = Var2, y = Var1, fill = cor)) +
  geom_tile(color = "gray") +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  geom_text(aes(label = cor_label), size = 3) +          
# 相关系数字符串
  geom_text(aes(label = star), color = "red", size = 6, nudge_y = 0.25) + # 星号
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Correlation",
       x = "",
       y = "") 
  
```

@fig-spearman-correlation-matrix shows significant positive correlations among the three variables representing reduction intensity: scar number, removal ratio, and SDI. Among them, scar counts show significant positive correlations with both removal ratio (ρ = `r cor_scar_removal`, p = $`r p_scar_removal`$) and SDI (ρ = `r cor_scar_sdi`, p = $`r p_scar_sdi`$). Removal ratio and SDI exhibit a stronger and more highly significant correlation (ρ = `r cor_removal_sdi`, p = $`r p_removal_sdi`$). These two variables incorporate surface area in their calculation, making them more effective in capturing the density and intensity of reduction, and therefore more reliable indicators of the shaping process in spheroids.

Among the shape descriptors of spheroids, several significant correlations were observed. Mean edge angle was positively correlated with sphericity (ρ = `r cor_angle_sph`, p = $`r p_angle_sph`$) and negatively correlated with SPHARM power (ρ = `r cor_angle_she`, p = $`r p_angle_she`$), indicating that greater edge angles are associated with more spherical and regular forms. As noted in previous studies, mean edge angle is a key variable in capturing the morphology of spheroids \[citation\]. This correlation between edge angle and sphericity may help explain why spheroids were often interpreted as exhausted cores in earlier research \[citation\]. Indeed, spheroids must be significantly reduced, as achieving a near-perfect spherical shape typically results in increased edge angles, making further flake removal difficult. However, the reverse is not necessarily true—not all exhausted cores evolve into spheroids.

Curvature was only significantly correlated with sphericity (ρ = `r cor_cur_sph`, p = $`r p_cur_sph`$), suggesting that smoother surfaces tend to approximate spheres more closely. Its lack of correlation with other variables may reflect its focus on local surface texture, while edge angle and SPHARM power capture broader aspects of shape regularity and symmetry. The weak correlation between sphericity and SPHARM power may result from the small sample size or their different sensitivities: sphericity, based on area and volume, tolerates surface variation, while SPHARM power responds more to asymmetry and surface irregularity. Thus, even in similarly spherical specimens, surface differences can produce substantial variation in SPHARM power. The analysis of spheroid shape variables indicates that mean edge angle, curvature, sphericity, and SPHARM power each capture distinct aspects of spheroid morphology, which explains the varying strengths of correlation observed among them.

# Discussion

## Do the Qianshangying spheroids represent a shaping strategy?

According to the results of our morphological and technological analysis, we can summarize the technical strategy employed in the production of faceted spheroids from Qianshangying. This strategy consists of a series of sequential phases (@fig-shaping-process): a potential rough-out phase, volume exploitation aimed at forming a cubic shape, surface exploitation to approximate a spheroidal geometry, edge refinement, and potentially the repetition of earlier phases. The existence of a repetitive phase is supported by the observation that while the original cobble blanks from Qianshangying display considerable size variation, the finished spheroids, although two of them are relatively large or small, mostly cluster around a diameter of 6–9 cm (@@fig-basic-characteristics). This suggests that the production of spheroids may have involved multiple cycles of reduction, and further implies that a diameter of 6–9 cm was considered an optimal or intended size in the knapping process.

Therefore, it can be inferred that the Qianshangying hominins deliberately employed a standardized production approach to create spheroids with consistent and formalized shapes. The technological strategy reflected in the Qianshangying facetted spheroids includes the use of a conceptual template, standardized production, and the achievement of a target product, which together demonstrate that this was a shaping strategy. This stands in contrast to flaking strategies, where the primary objective is the removal of usable flakes or débitage rather than the shaping of a cobble into a predetermined morphology [@inizan1999; @duke2021].

The evolutionary origins of shaping strategies are most commonly linked to the Acheulean, particularly those exemplified by bifacial shaping strategies on handaxes [@isaac1986foundation]. These strategies gradually became more refined, with mature bifacial shaping marked by the concept of bifacial symmetry, thinning and edge refinement, and the achievement of a standardized final shape [@beyene2013]. Compared to flaking technology in Oldowan, these processes demand greater cognitive planning and precise manual control [@wynn1995; @stout2015]. Although the spheroids from Qianshangying do not qualify as Large Cutting Tools (LCTs), nor does the site yield other typically Acheulean products, the faceted spheroids nonetheless exhibit a level of technological and morphological complexity comparable to that of LCTs. They also share key features, including a hierarchical and standardized reduction sequence and a high degree of symmetry and surface regularity in the final product. <!-- BM: check Shipton, see if he has anything relevant to mention here -->

These findings also contribute to the long-standing debate over the nature of spheroids—whether they should be interpreted as byproducts of flake production, or as targeted end products of shaping strategies. In the case of the Qianshangying facted spheroids, the evidence strongly supports the latter. Faceted spheroids recovered from other Early Pleistocene sites in Barranco Leon and ‘Ubeidiya have also been reported to show evidence consistent with shaping strategy [@Muller2023; @tittonSubspheroidsLithicAssemblage2020]. These intentionally shaped spheroids appear contemporaneous with, or even predate, the emergence of Acheulean technology. It is important to note, however, that many spheroids from East Africa may not fall into this category. As noted by @mora2005, these quartz-based spheroids may have been produced through percussive techniques. They are often covered with battering marks, exhibit smoother surfaces, and lack ridges, features that suggest they may be better classified as bolas within a typological framework [@leakey1971]. It may be more appropriate to describe these artifacts in technological terms, rather than relying on morphology-based typologies that can lead to confusion. For instance, referring to them as battering spheroids could help distinguish them from faceted spheroids. <!-- BM: check Cabanès,  do we agree or disagree with their findings-->

Another issue we aim to address is the relationship between polyhedrons, spheroids, and bolas. While no bolas were identified at Qianshangying, our quantitative analyses clearly differentiate polyhedrons from spheroids. These two artifact types differ in size, morphology, and production sequence. Polyhedrons at Qianshangying represent heavily reduced cores, whose edge angle increase results from extensive flake removal. Their primary purpose lies in producing flakes, placing them within a flaking strategy. In contrast, spheroids were intentionally shaped as end products, reflecting a shaping strategy. These two technological approaches of flaking and shaping strategies coexisted at Qianshangying, indicating a diversity of reduction goals.

However, we found that although the morphology and reduction technology of spheroids and polyhedrons can be clearly distinguished, spheroids in early phases may be difficult to differentiate from cores. In their initial phases of reduction, spheroids often resemble cores due to similar flake removal patterns. At this stage, they may be classified as cores, especially since the flakes produced during the initial shaping are themselves usable. However, it remains unclear whether this typological transformation was intentional or unplanned. In addition, the spheroids at Qianshangying appear to have undergone another form of typological transformation—from hammerstones to spheroids. One specimen initially served as percussive tools but were later subjected to flake removal, suggesting a shift in function from battering to shaping.


# Conclusion

<!-- BM: for JAS I think we want the novelty of the methods to be the leading idea in the conclusion -->

Quantitative approaches to studying spheroids remain limited [@Muller2023; @deweyer2017; @tittonSubspheroidsLithicAssemblage2020]. We propose a methodological framework here represented by spherical harmonics to quantitatively assess morphological variation among flaked pieces, allowing for the distinction between cores and spheroids and evaluating the degree of morphological standardization in spheroids. This approach has proven effective and reliable. Past approaches to analyzing the morphology of flaked pieces have been limited, with geometric morphometrics measures being virtually the only method used for a long time [@hallinan2025; @cao2025; @lycett2013]. However, this method has significant constraints, including the requirement for homologous landmarks, which limits its applicability to artifacts like cores in shape variety and spheroids. Spherical harmonics offer a viable alternative, showing strong potential for precision and applicability. We can reasonably expect broader applications of this method across a range of archaeological artifacts in the future.

This study provides one of the earliest systematic analyses focused on spheroids from East Asia. By applying a range of quantitative methods, we conducted an integrated morphological and technological study of the Qianshangying spheroids. Our results demonstrate that these spheroids were produced through a programmed reduction strategy aimed at achieving standardized spherical forms, primarily using hard-hammer direct percussion. The evidence of shaping strategies on Qianshangying spheroids confirms that they were intentionally made tools with conceptual template rather than exhausted cores. This distinguishes them from polyhedrons or multi-facial cores in their terminal reduction stages. Traditionally, lithic technology in northern China prior to the Late Pleistocene has been considered stagnant and generally classified as simple core-and-flake industries. However, the Qianshangying assemblage from \~429ka clearly reveals a higher level of technological complexity

This paper also presents one of the first systematic overviews of the spatial and temporal distribution and technological variability of spheroids within China. We found that Chinese spheroids display considerable diversity in raw materials, production techniques, and morphology. Some assemblages contain spheroids that may be comparable to those from Qianshangying and tend to appear within Acheulean or shaping-oriented techno-complexes, often dated later than Qianshangying This highlights the particular significance of the Qianshangying spheroids. However, the current dataset remains limited, and many sites lack detailed morphological and technological studies of spheroids, hampering broader inferences about hominin technological behaviors. We therefore emphasize the need for site-specific analysis of spheroids in future research.

Given the limitations of traditional typology in capturing the functional, morphological, and technological variability of spheroids across sites, we argue that multiple method approaches are essential. From the perspective of typology, spheroids have often been dismissed as poor marker of hominin behavior due to their wide spatial and temporal distribution, combined with low-cost technologies, more refined studies increasingly reveal their diversity and potential as markers of homonin technological behavior [@tittonSubspheroidsLithicAssemblage2020; @vaquero2018]. For example, distinctions between flaking-based and battering-based spheroids, along with patterns of raw material selection, production goals, and associations with specific subsistence strategies or environmental adaptations, may prove meaningful [@Cabanes2024]. Beyond the methods of morphological and technological analysis used here, future studies incorporating functional analysis and experimental replication will further enhance our understanding.


<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
