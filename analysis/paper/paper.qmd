---
title: "Shaping strategies and standardisation of faceted spheroids from Qianshangying (North China)"
institute:
  - fosg:
      name: Formatting Open Science Group
      address: 23 Science Street, Eureka, Mississippi, USA
  - fop: Federation of Planets
title-block-published: "Last updated"  
date: now
date-format: long
format: html
execute:
  echo: true
  warning: false
  message: false
  comment: "#>"
  fig-dpi: 600
bibliography: references.bib
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
editor_options: 
  chunk_output_type: console
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The actual document text starts here: -->

```{r setup, include=FALSE}

library(data.table)
library(NISTunits)
library(circular)
library(ggpubr)
library(ggalt)
library(ggplot2)
library(stringr)
library(ggtern)
library(dplyr)
library(here)
source(here('analysis/paper/scripts/McPherron_2018.r'))
source(here('analysis/paper/scripts/get_coordinates.r'))
source(here('analysis/paper/scripts/vector_stats.r'))
```

# Introduction

...Qianshangying (QSY) ....

Here is a citation [@Marwick2017]

# Background

# Methods

In this study, the 3d models of the cores were collected and used for morphometric and technological analysis. Digital data were captured using Artec Spider, and post-processing was carried out with Artec Studio \[version number\]. The 3D scan files and all the R and Python code used in the analyses reported here are openly available online at https://doi.org/xxxx/xxxx/.

## Core Type and Typology

## Morphometric Analysis

```{r}
# 读取 Excel 文件
library(tidyverse)
library(here)
library(readxl)

file_path <- here("analysis/data/derived_data/flaking_intensity_and_shape.xlsx")
data <- read_excel(file_path)

data_clean <- data %>% 
  drop_na()

n_of_artefacts <- nrow(data_clean)
```

Based on typological study, we identify `r n_of_artefacts` rounded faceted sub-spheroids/spheroids in QSY site. Inevitably, the classification of stone artifacts under the guidance of typology relies on subjective judgment, and the identification of stone core types may vary with researchers. \[BM: feels like this belongs in results section\]

~~To avoid preconceptions and self-justification,~~ We ~~try to~~ applied quantitative methods to ~~help confirm the spheroids in site. These morphological measurements designed to~~ indicate ~~whether these identified spheroids are spherical and~~ the degree of difference between the archaeological spheroids and a perfect sphere. This included computing the sphericity index, 3D spherical harmonics, spherical harmonic energy and the centroid offset for each artefact. We ~~will~~ also examined the degree of standardization of the spheroids by comparing coefficients of variation \[citation\] of sphericity \[and what else\].

In addition to the archaeological spheroids, we included other multidirectional-multifacial cores in the morphological study to explore whether they can be distinguished from the spheroids. Furthermore, we compared the results of the typological and our new morphometric analyses to investigate the validity of the traditional typological approach.

### Sphericity index

To evaluate the degree to which the artifacts approximate a perfect sphere, this study employs a standardized sphericity index originally proposed by @Wadell1935 and later adapted for 3D digital models in geoscientific research. The index is calculated using the following formula:

$$
\Psi = \frac{\pi^{1/3} (6V)^{2/3}}{A}
$$

Where V is the volume and A is the surface area of the object. This dimensionless metric yields a maximum value of 1 for a perfect sphere. Values closer to 1 indicate a higher degree of sphericity, thus serving as a reliable proxy for assessing the morphological regularity and intentional shaping of the spheroids. We used Python to derive surface area and volume measurements from 3D mesh models. The models were were decimated to a consistent face count and subjected to unit normalization, ensuring comparability across specimens. \[BM: check if we need this here\]

### 3D spherical harmonics analysis

Spherical Harmonic (SPHARM) analysis is a method for describing 3D shapes using a series of mathematical functions defined on the surface of a sphere. It works like a 3D version of Fourier analysis, breaking down complex shapes into components of different spatial frequencies. Each shape is first mapped onto a unit sphere and then expressed as a combination of spherical harmonic functions $Y_l^m(\theta, \phi)$. The shape is represented by a set of coefficients $\hat{f}(l, m)$, which capture how much each function contributes. Here, θ and ϕ are angles in spherical coordinates, l and m are order and degree respectively. Lower-order terms describe the general shape, while higher-order terms capture finer details[@Link2024; @Medyukhina2020; @Harper2022]. This method is widely used in the field of biology, such as ~~for~~ the analysis of skull morphology and cell morphology \[citations\]. However, there are currently very few application of SPHARM to archaeological artifacts [@Muller2023; @Noshita2025]. Our work aims to demonstrate the usefulness of SPHARM for shape analysis of objects that are roughly spherical in shape, such as the spheroids and cores studied in this research.

We first imported, cleaned, and simplified the STL files of spheroids and cores to extract 3D mesh vertices, which were then converted from Cartesian (x, y, z) to spherical coordinates (r, θ, φ) \[citation\]. Next, we interpolated radial values onto a regular spherical grid and then decomposed them using spherical harmonics based on the Driscoll–Healy sampling scheme \[citation\]. The resulting coefficients were normalized for scale-invariant comparison across models.

From the normalized spherical harmonic coefficients, we computed the rotation-invariant power spectrum by summing the squared magnitudes of the coefficients at each degree. Each 3D shape is thus represented by its unique power spectrum, which serves as a multidimensional descriptor. To explore variation between models, we applied UMAP for dimensionality reduction and visualization [@Van2023].

This study represents the first attempt in archaeology to apply SPHARM for the classification of cores. Specifically, we include a set of standard geometric models—such as sphere, rounded cube, ellipsoid (1.2:1:0.8) rounded rectangular prism (1.2:1:1), and disc-like (flattened, and like discoid core)—in the SPHARM analysis and UMAP. Cores are positioned in this position based on their morphological similarity to these reference models: individuals that cluster more closely to a specific standard form exhibit corresponding shape characteristics. \[BM: this text probably better in the intro or background section\]

### Spherical Harmonic energy

Additionally, we compute the spherical harmonic energy (SHE), defined as the sum of squared spherical harmonic coefficients for each degree. This provides a rotation-invariant measure of shape complexity across spatial frequencies. For normalized shapes, this total energy approaches 1 for an ideal sphere, while more irregular forms yield higher values.

Notably, classic sphericity metrics [@Wadell1935] exhibit critical limitations in differentiating morphotypes with equivalent surface-area-to-volume ratios. For instance, rough spheres and smooth ellipsoids may achieve comparable Wadell values despite fundamentally distinct geometries. SHE overcomes this constraint through spherical harmonic decomposition of surface morphology, and this allows it to distinguish localized irregularities (like core edge or concave) from global shape deviations (e.g., elongation) – differences that classic sphericity metrics often fail to capture.

We computed the total energy at degree 20, a resolution high enough to capture surface details. Lower energy values indicate smoother and more regular surfaces, while higher values reflect more irregular or angular geometries. Unlike sphericity, which may overestimate sphericality in irregular objects, spherical harmonic energy better captures fine-scale shape deviations.

### Centroid offset

To evaluate how closely an artifact approximates a sphere, this study uses the distance between its centre of mass (CoM) and the centre of its bounding box (CoBB) as a measure of volumetric symmetry [@Muller2023]. A perfect sphere will have its CoM and CoBB perfectly aligned, resulting in a zero offset. As the object becomes more irregular or asymmetric, this offset increases. For each 3d model, the CoBB is defined as the midpoint of the maximum orthogonal dimensions—length (y), width (x), and thickness (z)—of its minimum bounding box. The CoM, which approximates the true mass center for objects made of homogeneous materials, is computed by weighting each triangular face of the mesh by its surface area and normalizing the result. The distance between CoM and CoBB, normalized by the artifact’s volume, serves as a quantitative indicator of sphericity: lower values indicate more spherical forms.

## Technological Analysis

To investigate the production strategies of spheroids in QSY, this part aims to determine whether these artifacts were intentionally shaped and whether their manufacture followed standardized procedures. Addressing this question is crucial for evaluating whether spheroids represent a distinct technological category, separate from exhausted cores.

### Diacritical analysis

We applied diacritical analysis to reconstruct the reduction sequence based on superimposition relationships among scars on spheroids [@tittonSubspheroidsLithicAssemblage2020; @Cabanes2024]. This method enables the identification of scars order, allowing us to figure out the organization of removals. All spheroids, polyhedron and multifacial cores are included in the analysis to assess whether removals organization differs systematically within these groups.

Following the reconstruction of reduction sequences, we adopted an inductive approach to infer exploitation models of spheroids—that is, the removal patterns and associated stages employed in a spheroid. Ideally, the goal is to reconstruct the complete chaîne opératoire of spheroids—from the selection of raw material and initial blank to the final product. If consistent patterns are observed, they may indicate shared reduction schemes or conceptual templates. Furthermore, we explore whether multifacial cores and polyhedrons may represent earlier stages in spheroid reduction sequences, contributing to understanding the technological relationship between these types.

### Orientation analysis

To further investigate technological strategies, we incorporated orientation statistics as a complementary approach. This method derives from fabric analysis originally used in sedimentology and has since been adapted to study the arrangement of flake scars on lithic artifacts. We followed the protocol developed by Sam Lin [@Lin2024], extracting scar vectors from each core and calculating eigenvalues to derive the isotropic ratio and elongation ratio, these steps are finished in Geomagic Wrap, Rhino8 and R.

Results are visualized using ternary plots to compare orientation statistics between spheroids and other core types. Based on our hypothesis, if spheroids were shaped following a consistent reduction sequence, they should exhibit similar and patterned orientation results. In contrast, if they merely represent exhausted cores, the orientation patterns would appear random and highly variable, similar to those of undirected polyhedron and multifacial cores.

## Efficiency of shaping strategy

This section aims to investigate how the morphology of spheroids evolves during the reduction process. We hypothesize that, as reduction intensity increases, spheroids will progressively approximate a perfect sphere. This would indicate a high-efficiency shaping strategy, where each step is directed toward achieving a predefined morphological goal. To test this hypothesis, we established a set of quantitative indicators for reduction intensity and spheroid morphology.

### Degree of reduction

To compute the degree of reduction we collected data on three metrics: scar number, removal ratio and scar density index (SDI). We measured scar number as total number of flake scars visible on the spheroid surface. Removal ratio was calculated as 1 minus cortex ratio, where the cortex ratio represents the proportion of cortical surface area to total surface area. \[BM: add a sentence to define cortex ratio and give citation.\] We used the removal ratio instead of the traditional cortex ratio in order to maintain a positive correlation with other reduction intensity indicators. SDI is defined as the number of flake scars divided by the total 3D surface area, the SDI serves as a robust indicator of core reduction intensity, following @clarksonMeasuringCoreReduction2013. It has been demonstrated to effectively capture the dynamic nature of the reduction process.In all three metrics, higher values represent more advanced stages of reduction. Scar counts and surface area measurements were extracted using Geomagic Wrap.

### Spheroid shape

We measured spheroid shape with four metrics: sphericity, and spherical harmonic energy, along with mean edge angle, mean surface curvature. Higher average edge angles suggest a more spherical geometry. Ten edge intersections were randomly sampled per spheroid. Angles were calculated following @tittonSubspheroidsLithicAssemblage2020 by constructing triangles at ridge intersections, extracting vertex coordinates in Geomagic Wrap, and computed angles from the coordinates using trigonometric functions in R. Mean surface curvature is a proxy for surface roughness, and higher mean surface curvature indicates a smoother surface. We estimated local curvature using the k-nearest neighbors method to fit a best-fit plane at each vertex [@Muller2023]. The deviation between actual surface points and this fitted plane reflects surface roughness. The calculation steps were completed in Python.

Together, these four variables allowed us to assess whether more extensively reduced spheroids display more standardized, symmetrical, and regular morphologies—characteristics expected in deliberate shaping strategies. We conducted Spearman’s rank correlation analysis between two sets of variables—reduction intensity indicators and morphological attributes. This non-parametric method is appropriate for small sample sizes and data that do not follow a normal distribution. A total of `r n_of_artefacts` final-stage spheroids and sub-spheroids from the site were included in the analysis.

# Results

```{r}
# multifacial and polyhedron cores
cores <- 
read_excel(here("analysis/data/derived_data/core technological parameters.xlsx")) 
  
multifacial_and_polyhedron_cores <- 
    cores %>% 
  filter(!Typology %in% c("Spheroid", 
                          "Subspheroid", 
                          "Subsperoid"))

n_multifacial_and_polyhedron_cores <-
  nrow(multifacial_and_polyhedron_cores)
```

## Results of Morphometric analysis

```{r}
#| label: tbl-cores
#| tbl-cap: "Our table"

knitr::kable(multifacial_and_polyhedron_cores)
```


We applied spherical sphericity index, harmonics analysis, and centroid offset measurements to both the spheroids (n = `r n_of_artefacts`) and all other multifacial and polyhedron cores (n = `r n_multifacial_and_polyhedron_cores`) in the assemblage of QSY. These analyses aim to assess whether spheroids are morphologically distinct from other cores, and whether they exhibit standardized shapes—an essential criterion for evaluating the existence of deliberate shaping strategies and a goal product. In addition, we compare quantitative outcomes with traditional typological classifications to assess their consistency. We present a summary table listing each core's blank morphology and type, final morphology, and cortex coverage here in [@tbl-cores].

```{r}

# code for basic morphometry
mean_sphercity_tbl <- 
cores %>% 
  mutate(grouped_types = case_when(
    Typology == "Polyhedron" ~  "Multifacial",
    Typology == "Subspheroid" ~ "Spheroid",
    .default = Typology
  )) 

# summary values for Sphericity
mean_sphercity_tbl_summary <- 
  mean_sphercity_tbl %>% 
  group_by(grouped_types) %>% 
  summarise(mean_sphercity = mean(Sphericity))

mean_sphercity_tbl_sph <- 
  mean_sphercity_tbl_summary %>% 
  filter(grouped_types == "Spheroid") %>% 
  pull(mean_sphercity) %>% 
  round(3)

mean_sphercity_tbl_mult <- 
  mean_sphercity_tbl_summary %>% 
  filter(grouped_types == "Multifacial") %>% 
  pull(mean_sphercity) %>% 
  round(3)

# Mann-Whitney U test
# Convert to scientific text
pretty_print_sci <- function(num){
  scientific_text <- paste0(gsub("e", " x 10^",  
                                 # Replace 'e' with ' x 10^'
                          sprintf("%.2e", num)), "^") 
  # round to 2 sf
  return(scientific_text)
}

# example usage:
# `r pretty_print_sci(journal_summary_metrics_ranks_test$p.value)
# convert 3.993e-5 to 3.99 × 10⁻⁵ for pretty printing in your paper



```

Sphericity analysis reveals a clear difference between spheroids and multifacial cores/polyhedra. The mean sphericity of spheroids (`r mean_sphercity_tbl_sph`) is notably higher than that of multifacial cores and polyhedron (`r mean_sphercity_tbl_mult`), with a Mann-Whitney U test yielding U = 37.0, p = 3.99 × 10⁻⁵. This result indicates that spheroids possess a more spherical geometry overall, supporting their typological classification.

We conducted shape analysis based on spherical harmonic decomposition, setting the maximum degree to 20 (lmax=20). This choice ensures that sufficient geometric detail is captured while avoiding high-frequency noise and overfitting artifacts such as the Gibbs phenomenon. After normalization, all models have their degree 0 (l=0) coefficient set to 1, allowing for meaningful comparison across different models.

A Variance Analysis was performed on the power of each harmonic degree. The results indicate that l= 2 and l=3 exhibit the highest variance across the sample, suggesting that these low-order terms capture the most significant shape variation. Specifically, l=2 reflects global asymmetries—such as elongation or flattening—while degree 3 is more sensitive to localized features like curvature and edge protrusions.

To visualize the structure of shape variation, we applied UMAP to the normalized power spectrum. The UMAP projection reveals distinct clusters in the first two dimensions of the shape space. These clusters correspond to reference models, sphere, rounded cube, ellipsoid, rounded rectangular prism and disc-shaped core. This demonstrates that these cores occupy distinguishable regions in the harmonic shape space, with proximity to the sphere or elongation/flattening along specific axes emerging as key differentiating features. Most artifacts typologically classified as spheroids or sub-spheroids were grouped into the “rounded cube” and “sphere” clusters, indicating their consistent, near-spherical shapes. However, some Multifacial cores and Polyhedron also appeared in the near-spherical region. This can be attributed to their high cortex coverage or limited flake removals, which likely preserved their originally rounded forms and led to their grouping alongside more intentionally shaped spheroids.

We then tested whether the UMAP-based groupings also correspond to differences in sphericity using a Kruskal–Wallis test, which yielded H = 18.43, p = 3.59 × 10⁻⁴. The result shows statistically significant differences in sphericity among the shape clusters, further supporting the effectiveness of the spherical harmonic approach in capturing meaningful morphological variation.

The spherical harmonic energy (SHE), a novel metric introduced herein, quantifies the geometric approximation of core morphology to an ideal sphere. Normalized SHE approaching unity indicates progressively spherical configurations, while deviations from unity reflect morphological irregularity. Our analysis demonstrates significant negative correlation between SHE and classic sphericity measures (t = -11.012, df = 49, p = 7.443×10⁻¹⁵), validating its efficacy as a proxy of sphericity.

Statistical comparisons reveal distinct SHE distributions between morphological classes: spheroids and sub-spheroids exhibit mean SHE=1.013 (SD ± 0.008), whereas multifacial cores and polyhedron demonstrate significantly higher irregularity (mean SHE=1.032, SD ± 0.014). The Kruskal-Wallis test confirms robust inter-group divergence (H=16.99, p=3.76×10⁻⁵), proving the distinguishability of spheroids in QSY.

The pursuit of a standardized spherical form among spheroids is further supported by our findings. Using the Coefficient of Variation (CV)—defined as the sample standard deviation divided by the sample mean—we assessed the consistency of sphericity within the spheroids. Eerkens (2000) suggested that a CV of under 1.7% (0.017) is a realistic threshold for manually-produced archaeological artifacts. Both sphericity and SHE values yielded low CVs (0.0175 and 0.0068, respectively), indicating that spheroids maintain a highly standardized rounded shape. In contrast, multifacial cores combined with polyhedron has a higher CV of 0.0447 and 0.0191 respectively.

## Results of technological analysis

The diacritical analysis of spheroid surfaces reveals a structured and recurrent reduction sequence comprising the following phases:

Phase 1) unidirectional or bidirectional total exploitation, belonging to one kind of volume exploitation. Large and flat surfaces of the cobble are selected as platforms to striking toward the opposite surface. Knapping proceeds until the peripheral volume is fully exploited, resulting in an approximately cubic form. Phase 2) peripheral centripetal exploitation. In this phase, previous removals in phase 1 serve as platforms for centripetal flaking around the core periphery. This represents a surface exploitation strategy. A notable feature is the angle between the face ventral surface and platform (core edge angle), which often exceeds 90°, forming what the literature refers to as secant plan rather than parallel plans. This approach contributes significantly to the progressive spherical of the shape. Phase 3) small scars on ridges or intersections of previous flake scars, resulting in a rounding and smoother surface, further enhancing sphericality. It is important to note that due to the high degree of reduction intensity observed in most spheroids, phases prior to the initial visible sequence are often obliterated. We hypothesize the existence of a Phase 0, potentially involving roughing-out of the cobble or an earlier cycle of Phases 1–3.

Scar orientation analysis further supports the interpretation of a systematical reduction sequence in the production of QSY spheroids. Shown in the ternary plot, spheroids tend to cluster together, with elongation ratios ranging from 0.403 to 0.637 and isotropy ratios from 0.164 to 0.497. These elongation ratios suggest that the spheroids underwent unidirectional or bidirectional total exploitation, resulting in relatively high elongation values. In addition, the peripheral centripetal exploitation appears to have contributed to a certain degree of isotropy in scar arrangement—higher isotropy ratios are associated with more spherical shapes. Subspheroids exhibit greater variability in both elongation and isotropy ratios, indicating less consistent reduction intensity.

Multifacial cores and polyhedrons display a wide and dispersed distribution in the ternary plot, without forming any distinctive cluster. Their scar patterns show considerable variability in both elongation and isotropy, reinforcing the interpretation that these cores lack removal organization and reflect a SSDA. Multifacial cores typically exploit natural angles with core rotation occurring without a predetermined plan, which belongs to an opportunistic flaking strategy, while polyhedrons—despite showing a higher degree of reduction—follow a similarly unstructured sequence. This distinction highlights the fundamental technological difference between polyhedrons and spheroids at QSY, where they used to be considered as a continuous reduction process: polyhedrons represent exhausted cores, whereas spheroids reflect the presence of a conceptual template and systematic reduction plan.

```{r, echo = FALSE}
get_coordinates <- function(filename) {
  temp_file <- readLines(filename, encoding = "UTF-8")  # 强制 UTF-8 编码读取
  xyz1 <- data.frame(X1 = numeric(), Y1 = numeric(), Z1 = numeric())
  xyz2 <- data.frame(X2 = numeric(), Y2 = numeric(), Z2 = numeric())
  
  for (line in temp_file) {
    if (grepl("^\\s*start\\s*=", line)) {
      coordinates <- gsub(".*\\(([^()]*)\\).*", "\\1", line)
      coords <- as.numeric(strsplit(coordinates, ",")[[1]])
      xyz1 <- rbind(xyz1, data.frame(X1 = coords[1], Y1 = coords[2], Z1 = coords[3]))
    }
    if (grepl("^\\s*end\\s*=", line)) {
      coordinates <- gsub(".*\\(([^()]*)\\).*", "\\1", line)
      coords <- as.numeric(strsplit(coordinates, ",")[[1]])
      xyz2 <- rbind(xyz2, data.frame(X2 = coords[1], Y2 = coords[2], Z2 = coords[3]))
    }
  }

  # 检查是否有数据
  if (nrow(xyz1) == 0 || nrow(xyz2) == 0) {
    warning("未能提取任何坐标，返回空 data.frame")
    return(data.frame())
  }

  # 合并 + 添加 ID、类型、长度等字段
  xyz <- round(cbind(xyz1, xyz2), 5)
  filename_base <- basename(filename)  # 提取文件名
  xyz$ID <- sub("_(.*)", "", filename_base)  # 提取下划线前的部分
  xyz$type <- sub(".*_(.*)\\.txt", "\\1", filename_base)  # 提取下划线后、.txt 前的部分
  xyz$length <- sqrt((xyz$X2 - xyz$X1)^2 + (xyz$Y2 - xyz$Y1)^2 + (xyz$Z2 - xyz$Z1)^2)
  xyz$length_scaled <- xyz$length / sum(xyz$length)

  xyz <- xyz %>%
    filter(complete.cases(.)) %>%
    distinct(.keep_all = TRUE)
  
  return(xyz)
}

# 遍历文件夹中的文本文件
folder_path <- here("analysis/data/raw_data/QSY_A")
temp_file_list <- list.files(folder_path, pattern = "\\.txt$")  # 只列出 .txt 文件

std <- list()

# 读取所有文件并提取数据
for (i in seq_along(temp_file_list)) {
  filepath <- file.path(folder_path, temp_file_list[i])
  std[[i]] <- get_coordinates(filepath)
}

# 运行 benn 函数并构建数据框
benn.output <- as.data.frame(t(sapply(std, benn, min_sample = 0)))
benn.output$type <- sapply(std, function(x) if ("type" %in% names(x)) x$type[1] else NA)
benn.output$ID <- sapply(std, function(x) if ("ID" %in% names(x)) x$ID[1] else NA)
colnames(benn.output) <- c('Scar_count', 'E1', 'E2', 'E3', 'IS', 'EL', 'type', 'ID')

# 检查结果
print(head(benn.output))

# 保存为 CSV
write.csv(benn.output,
          here("analysis/data/derived_data/benn_output.csv"), row.names = FALSE)
```

```{r, Fig, benn_ternary_plot, echo=FALSE}

benn.output$Z <- 1 - benn.output$EL - benn.output$IS

n  = 11      # Number of Data Points
nv = 0.06    # Vertical Adjustment
pn = position_nudge_tern(y = nv, x = nv, z = -nv / 2)

ggtern(data = benn.output, aes(Z, IS, EL, color = type)) + 
  geom_mask() + 
  geom_point(size = 3) + 
  theme_bw() +
  labs(
    x = "Planar", 
    y = "Isotropic", 
    yarrow = "Isotropy Ratio", 
    z = "Linear", 
    zarrow = "Elongation Ratio"
  ) +
  theme_showarrows() + 
  theme_clockwise() + 
  #geom_text(position = pn, aes(label = type), check_overlap = FALSE, size = 3) +
  scale_color_manual(values = c(
    "multifacial" = "lightgray",
    "polyhedron" = "gray40",
    "subspheroid" = "orange",
    "spheroid" = "red"
  ))

ggsave(here("analysis/paper/figures/benn_ternary_plot.jpg"), 
       width = 8, 
       height = 6, 
       dpi = 300)

```

Based on this diacritical analysis and scar orientation analysis, we can summarize the technical strategy employed in the production of faceted spheroids in QSY. This strategy consists of a series of essential and sequential phases: a potential rough-out phase, volume exploitation aimed at forming a cubic shape, surface exploitation to approximate a spheroidal geometry, edge refinement, and potentially the repetition of earlier phases. The existence of a repetitive phase is supported by the observation that while the original cobble blanks in QSY display considerable size variation, the finished spheroids—although some are relatively large—mostly cluster around a diameter of 8–10 cm. This suggests that the production of spheroids may have involved multiple cycles of reduction, and further implies that a diameter of 8–10 cm was considered an optimal or intended size in the knapping process.

## Results of technological analysis

The Spearman correlation analysis shows significant positive correlations among the three variables representing reduction intensity: scar number, removal ratio, and SDI. Among them, scar counts show significant positive correlations with both removal ratio (ρ = 0.74, p = 0.0036) and SDI (ρ = 0.64, p = 0.0187). Removal ratio and SDI exhibit a stronger and highly significant correlation (ρ = 0.89, p \< 0.001). These two variables incorporate surface area in their calculation, making them more effective in capturing the density and intensity of reduction, and therefore more reliable indicators of the shaping process in spheroids.

Among the shape descriptors of spheroids, several significant correlations were observed. Mean edge angle was positively correlated with sphericity (ρ = 0.68, p = 0.011) and negatively correlated with SPHARM power (ρ = –0.59, p = 0.035), indicating that greater edge angles are associated with more spherical and regular forms. As noted in previous studies, mean edge angle is a key variable in capturing the morphology of spheroids. This may help explain why spheroids were often interpreted as exhausted cores in earlier research. Indeed, spheroids must be significantly reduced, as achieving a near-perfect spherical shape typically results in increased edge angles, making further flake removal difficult. However, the reverse is not necessarily true—not all exhausted cores evolve into spheroids.

Curvature was only significantly correlated with sphericity (ρ = –0.57, p = 0.041), suggesting that smoother surfaces tend to approximate spheres more closely. Its lack of correlation with other variables may reflect its focus on local surface texture, while edge angle and SPHARM power capture broader aspects of shape regularity and symmetry.

The weak correlation between sphericity and SPHARM power may result from the small sample size or their different sensitivities: sphericity, based on area and volume, tolerates surface variation, while SPHARM power responds more to asymmetry and irregularity. Thus, even in similarly spherical specimens, surface differences can produce substantial variation in SPHARM power.

The analysis of spheroid shape variables indicates that mean edge angle, curvature, sphericity, and SPHARM power each capture distinct aspects of spheroid morphology, which explains the varying strengths of correlation observed among them.

```{r, Fig spearman correlation matrix, echo=FALSE}

# 加载必要包
library(readxl)
library(Hmisc)       # 用于计算相关系数和p值
library(ggcorrplot)  # 用于相关性热图绘制
library(reshape2)



# 标准化列名
colnames(data) <- make.names(colnames(data))

# 选定分析的列
selected_names <- c("Scar.number", "Removal.ratio", "SDI",
                    "Edge.angle.mean", "Curvature", "Sphericity", "SPHARM.power")

# 只选取实际存在于数据中的列
selected_cols <- data[, selected_names[selected_names %in% colnames(data)]]

# 显示维度和列名确认
print(dim(selected_cols))
print(colnames(selected_cols))

# 计算 Spearman 相关系数和对应的 p 值
rcorr_result <- rcorr(as.matrix(selected_cols), type = "spearman")
cor_matrix <- rcorr_result$r
p_matrix <- rcorr_result$P

# 打印结果查看
print("Spearman correlation matrix:")
print(round(cor_matrix, 4))
print("P-value matrix:")
print(round(p_matrix, 4))

# 转换成长格式
cor_long <- reshape2::melt(cor_matrix)
p_long <- reshape2::melt(p_matrix)

labels_long <- merge(cor_long, p_long, by = c("Var1", "Var2"))
colnames(labels_long) <- c("Var1", "Var2", "cor", "p")

# 调整因子顺序（让 y 轴从上往下）
labels_long$Var1 <- factor(labels_long$Var1, levels = rev(rownames(cor_matrix)))
labels_long$Var2 <- factor(labels_long$Var2, levels = colnames(cor_matrix))

# 显著标记星号
labels_long$star <- ifelse(labels_long$p < 0.1 & labels_long$Var1 != labels_long$Var2, "*", "")

# 相关系数文本，保留2位小数
labels_long$cor_label <- sprintf("%.2f", labels_long$cor)

# 自己绘图
ggplot(labels_long, aes(x = Var2, y = Var1, fill = cor)) +
  geom_tile(color = "gray") +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  geom_text(aes(label = cor_label), size = 3) +          
# 相关系数字符串
  geom_text(aes(label = star), color = "red", size = 6, nudge_y = 0.25) + # 星号
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Spearman Correlation Matrix with Significance",
       fill = "Correlation")



```

<!-- Here's some example analysis code: -->

```{r}
#| label: fig-m
#| fig-cap: "the"
#| out-width: "100%"

knitr::include_graphics(here("analysis/paper/figures/1.png"))
```

@fig-m shows...

# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
