---
format: gfm
default-image-extension: ""
editor: 
  markdown: 
    wrap: 72
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

# Spherical harmonic analysis of faceted spheroids identifies shaping strategies and standardisation at Qianshangying (North China)

```{=html}
<!--
[![Binder](https://mybinder.org/badge_logo.svg)](https://mybinder.org/v2/gh/benmarwick/archyjobads/main?urlpath=rstudio) [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.15847809.svg)](https://doi.org/10.5281/zenodo.15847809)
-->
```

This repository contains the data and code for our paper:

> Ye Zhi, Ben Marwick, Li Hao, Shuwen Pei (2025). Spherical harmonic
> analysis of faceted spheroids identifies shaping strategies and
> standardisation at Qianshangying (North China)". Submitted to *Journal
> of Archaeological Science*

A pre-print of this paper is freely available on SocArXiv:
https://osf.io/preprints/socarxiv/

## Contents

The **analysis** directory contains:

-   [:file_folder: paper](/analysis/paper): Quarto source document for
    manuscript. Includes code to reproduce the figures and tables
    generated by the analysis.
-   [:file_folder: data](/analysis/data): Data used in the analysis.
-   [:file_folder: figures](/analysis/paper/figures): Plots and other
    illustrations

The **py_SPHARM** directory contains:

-   [:file_folder: py_SPHARM](/py_SPHARM): Python source files for
    SPHARM analysis.
    -   **SPHARM_main**:
        -   `batch_operation.py` — batch calculation of spherical
            harmonics for STL files.\
        -   `main.py` — shape analysis using spherical harmonics for a
            single STL file, including visualization of analysis
            results.\
    -   **SPHARM_modules**: supporting modules for main scripts,
        including shape preprocessing, spherical harmonic
        computation/statistics, shape reconstruction, and
        computation/output of sphericity and curvature.


## How to download and run locally

This research compendium has been developed using the statistical
programming language R. To work with the compendium, you will need
installed on your computer the [R
software](https://cloud.r-project.org/) itself and optionally [RStudio
Desktop](https://rstudio.com/products/rstudio/download/).

You can download the compendium as a zip from from this URL:
[master.zip](/archive/master.zip). After unzipping:\
- open the `.Rproj` file in RStudio\
- run `renv::restore()` to ensure you have the packages this analysis
depends on\
- finally, open `analysis/paper/article.qmd` and render to produce the
`article.docx`, or run `rmarkdown::render("analysis/paper/paper.qmd")`
in the R console

# How to download and run locally

This project provides Python scripts for 3D spheroid shape analysis using SPHARM.  
1. **Download STL files**  
   - Go to the [OSF repository](https://osf.io/ctne9/files/osfstorage) and download the folder containing STL models: `3d_models_QSY_spheroids_multi_poly`  
2. **Unzip and place STL files in project directory**  
   - Extract the downloaded archive.  
   - After unzipping, copy the entire folder **`3d_models_QSY_spheroids_multi_poly`** into the project working directory:  [:file_folder: `SPHARM_main`](/py_SPHARM/SPHARM_main)  
3. **Open the main script and install dependencies**    
   - In [:file_folder: `SPHARM_main`](/py_SPHARM/SPHARM_main), open the main Python script file `main.py` in PyCharm.      
   - Install required dependencies by running in the Terminal:  
     ```
     python -m pip install -r requirements.txt  
     ```  
4. **Run the main script-main.py**    
   - Run `main.py` in PyCharm.    
   - The script will perform SPHARM calculation on a single 3D model and reconstruct it based on the computed results.    
   - You can save figures during the process.    
   - By default, all output results will be saved to the project folder [:file_folder: `SPHARM_main`](/py_SPHARM/SPHARM_main).    
5. **Run the batch operation script (`batch_operation.py`)**    
   - Run `batch_operation.py` in PyCharm.    
   - This script will process all STL files in the folder `3d_models_QSY_spheroids_multi_poly` and perform the following computations:    
     - SPHARM (spherical harmonics) calculation for each model    
     - Rotation-invariant spectrum computation    
     - Spherical harmonic energy (SHE) calculation    
     - UMAP analysis on the rotation-invariant spectrum    
   - You can replace the input folder with your own STL files to perform a similar analysis.    
   - By default, all output results will be saved to: [:file_folder: raw_data](/analysis/data/raw_data)    
6. **Run the curvature script (`curvature.py`)**    
   - Locate `curvature.py` in the [:file_folder: `SPHARM_module`](/py_SPHARM/SPHARM_module) and open it in PyCharm.    
   - This script will compute the curvature for all STL files in the folder `3d_models_QSY_spheroids_multi_poly`.    
   - By default, all output results will be saved to: [:file_folder: raw_data](/analysis/data/raw_data)  
7. **Run the sphericity script (`sphericity.py`)**      
   - Locate `sphericity.py` in the [:file_folder: `SPHARM_module`](/py_SPHARM/SPHARM_module) and open it in PyCharm.      
   - This script will compute the sphericity for all STL files in the folder `3d_models_QSY_spheroids_multi_poly`.      
   - By default, all output results will be saved to: [:file_folder: raw_data](/analysis/data/raw_data)
   
This project also provides steps to process and visualize the results in R.

8. **Data processing and visualization in R**    
   - Open the `.Rproj` file in RStudio.    
   - Run `renv::restore()` to ensure you have all the packages this analysis depends on.    
   - Finally, open `analysis/paper/paper.qmd` and render it to produce `paper.docx`.  
   

## How to download and run locally in a Docker container

This research compendium includes a [Dockerfile](Dockerfile) that
specifies the computational environment used to generate the results
presented in the paper. You can recreate this environment, which
includes R, RStudio and all necessary R packages, on your computer by
following these steps:

1.  Install [Docker](https://www.docker.com/get-started/) on your
    computer
2.  Download the compendium, e.g. from GitHub by clicking on the green
    `< > Code` button above, then click `Download ZIP`, then unzip on
    your computer
3.  Set your terminal working directory to the compendium, and run
    `docker build -t qsy .` (be sure to include the period) to build the
    container on your computer, it will take a few minutes and require a
    fast internet connection.
4.  Run in your terminal
    `docker run --rm -it -e ROOT=TRUE -e PASSWORD=rstudio -dp 8787:8787 qsy`
    to start the container on your computer
5.  Go to <http://localhost:8787/> with your browser and enter `rstudio`
    in both fields to start RStudio in your browser, running in the
    Docker container with all the required depedencies installed
6.  In RStudio, run `rstudioapi::openProject("/home/rstudio/qsy")` to
    open the compendium’s project. This project uses
    [`renv`](https://rstudio.github.io/renv/) to document and manage
    dependencies, this will be activated when the project is first
    opened in RStudio.
7.  Run
    `rmarkdown::render("analysis/paper/paper.qmd", output_dir='/tmp')`
    to render the Quarto document that is the manuscript submitted for
    publication
8.  After the code has executed, view the rendered output document by
    running `browseURL("/tmp/paper.docx")`
9.  When finished, to delete the Docker container from your computer,
    run this in the terminal on your desktop:
    `docker ps -aq | xargs docker stop | xargs docker rm`

### Licenses

**Text and figures :**
[CC-BY-4.0](http://creativecommons.org/licenses/by/4.0/)

**Code :** See the [DESCRIPTION](DESCRIPTION) file

**Data :** [CC-0](http://creativecommons.org/publicdomain/zero/1.0/)
attribution requested in reuse
